2025-09-20 16:00:53.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T13:00:53.670383"}
2025-09-20 16:00:53.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:processor_initialized | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:53.670383", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-20 16:00:54.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | correlation_token=sim_909c4aa76664333dbd33add873591bca_1758373233161 | will_start_billing=True
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:first_audio_received | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697176", "direction": "DOWNSTREAM"}
2025-09-20 16:00:54.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-20 16:00:54.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-20 16:00:54.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "start_time": "2025-09-20T13:00:54.697379", "backend_url": "http://localhost:3000"}
2025-09-20 16:00:54.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_2f51cb14-306b-498d-be37-efe1deef93e7 | task_id=13305912320
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:started | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697474", "start_time": "2025-09-20T13:00:54.697379", "backend_url": "http://localhost:3000"}
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697285", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697335", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-20 16:00:54.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:00:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=0 | waiting_60s=true
2025-09-20 16:01:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=1 | minute=1 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:01:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758373314701 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-20 16:01:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758373314701 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 1, "timestamp": "2025-09-20T13:01:54.701329"}
2025-09-20 16:01:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758373314701 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758373314701"}
2025-09-20 16:01:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758373314701", "status": 200, "latency_ms": 37.358999252319336, "minute": 1, "response_size": 157}
2025-09-20 16:01:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758373314701 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:01:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:01:54.739236", "request_id": "req_1_1758373314701", "minute": 1, "latency_ms": 37.358999252319336, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:01:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 1, "success": true, "latency_ms": 38.13886642456055, "iteration": 1}
2025-09-20 16:01:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758373314739", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:01:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:01:54.739571", "response_id": "resp_1_1758373314739", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:01:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=1 | total_duration_s=60.04 | webhook_duration_ms=38.14
2025-09-20 16:01:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=1 | waiting_60s=true
2025-09-20 16:02:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=2 | minute=2 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:02:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758373374747 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-20 16:02:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758373374747 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 2, "timestamp": "2025-09-20T13:02:54.747275"}
2025-09-20 16:02:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758373374747 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758373374747"}
2025-09-20 16:02:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758373374747", "status": 200, "latency_ms": 34.65700149536133, "minute": 2, "response_size": 157}
2025-09-20 16:02:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758373374747 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:02:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:02:54.782625", "request_id": "req_2_1758373374747", "minute": 2, "latency_ms": 34.65700149536133, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:02:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 2, "success": true, "latency_ms": 35.57586669921875, "iteration": 2}
2025-09-20 16:02:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758373374782", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:02:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:02:54.782928", "response_id": "resp_2_1758373374782", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:02:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=2 | total_duration_s=60.04 | webhook_duration_ms=35.58
2025-09-20 16:02:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=2 | waiting_60s=true
2025-09-20 16:03:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=3 | minute=3 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:03:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758373434794 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-20 16:03:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758373434794 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 3, "timestamp": "2025-09-20T13:03:54.794419"}
2025-09-20 16:03:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758373434794 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758373434794"}
2025-09-20 16:03:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758373434794", "status": 200, "latency_ms": 32.31310844421387, "minute": 3, "response_size": 157}
2025-09-20 16:03:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758373434794 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:03:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:03:54.827860", "request_id": "req_3_1758373434794", "minute": 3, "latency_ms": 32.31310844421387, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:03:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 3, "success": true, "latency_ms": 33.66899490356445, "iteration": 3}
2025-09-20 16:03:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758373434828", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:03:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:03:54.828159", "response_id": "resp_3_1758373434828", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:03:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=3 | total_duration_s=60.05 | webhook_duration_ms=33.67
2025-09-20 16:03:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=3 | waiting_60s=true
2025-09-20 16:04:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=4 | minute=4 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:04:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758373494832 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-20 16:04:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758373494832 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 4, "timestamp": "2025-09-20T13:04:54.832422"}
2025-09-20 16:04:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758373494832 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758373494832"}
2025-09-20 16:04:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758373494832", "status": 200, "latency_ms": 42.664289474487305, "minute": 4, "response_size": 157}
2025-09-20 16:04:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758373494832 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:04:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:04:54.875607", "request_id": "req_4_1758373494832", "minute": 4, "latency_ms": 42.664289474487305, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:04:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 4, "success": true, "latency_ms": 43.463945388793945, "iteration": 4}
2025-09-20 16:04:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758373494875", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:04:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:04:54.875968", "response_id": "resp_4_1758373494875", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:04:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=4 | total_duration_s=60.05 | webhook_duration_ms=43.46
2025-09-20 16:04:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=4 | waiting_60s=true
2025-09-20 16:05:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=5 | minute=5 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:05:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758373554878 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-20 16:05:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758373554878 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 5, "timestamp": "2025-09-20T13:05:54.878360"}
2025-09-20 16:05:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758373554878 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758373554878"}
2025-09-20 16:05:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758373554878", "status": 200, "latency_ms": 32.68313407897949, "minute": 5, "response_size": 157}
2025-09-20 16:05:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758373554878 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:05:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:05:54.912249", "request_id": "req_5_1758373554878", "minute": 5, "latency_ms": 32.68313407897949, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:05:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 5, "success": true, "latency_ms": 34.15107727050781, "iteration": 5}
2025-09-20 16:05:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758373554912", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:05:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:05:54.912694", "response_id": "resp_5_1758373554912", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:05:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=5 | total_duration_s=60.04 | webhook_duration_ms=34.15
2025-09-20 16:05:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=5 | waiting_60s=true
2025-09-20 16:06:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=6 | minute=6 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:06:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758373614914 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-20 16:06:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758373614914 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 6, "timestamp": "2025-09-20T13:06:54.914407"}
2025-09-20 16:06:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758373614914 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758373614914"}
2025-09-20 16:06:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758373614914", "status": 200, "latency_ms": 22.996902465820312, "minute": 6, "response_size": 157}
2025-09-20 16:06:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758373614914 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:06:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:06:54.937770", "request_id": "req_6_1758373614914", "minute": 6, "latency_ms": 22.996902465820312, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:06:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 6, "success": true, "latency_ms": 23.555994033813477, "iteration": 6}
2025-09-20 16:06:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758373614938", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:06:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:06:54.938057", "response_id": "resp_6_1758373614938", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:06:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=6 | total_duration_s=60.03 | webhook_duration_ms=23.56
2025-09-20 16:06:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 7 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=6 | waiting_60s=true
2025-09-20 16:07:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=7 | minute=7 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:07:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_7_1758373674942 | url=http://localhost:3000/api/billing/voice-minute | minute=7 | attempt=7
2025-09-20 16:07:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_7_1758373674942 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 7, "timestamp": "2025-09-20T13:07:54.942594"}
2025-09-20 16:07:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_7_1758373674942 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_7_1758373674942"}
2025-09-20 16:07:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_7_1758373674942", "status": 200, "latency_ms": 36.17286682128906, "minute": 7, "response_size": 157}
2025-09-20 16:07:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_7_1758373674942 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:07:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:07:54.979357", "request_id": "req_7_1758373674942", "minute": 7, "latency_ms": 36.17286682128906, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:07:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 7, "success": true, "latency_ms": 37.00685501098633, "iteration": 7}
2025-09-20 16:07:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_7_1758373674979", "minute": 7, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:07:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:07:54.979743", "response_id": "resp_7_1758373674979", "minute": 7, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:07:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=7 | total_duration_s=60.04 | webhook_duration_ms=37.01
2025-09-20 16:07:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 8 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=7 | waiting_60s=true
2025-09-20 16:08:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=8 | minute=8 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:08:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_8_1758373734984 | url=http://localhost:3000/api/billing/voice-minute | minute=8 | attempt=8
2025-09-20 16:08:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_8_1758373734984 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 8, "timestamp": "2025-09-20T13:08:54.984259"}
2025-09-20 16:08:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_8_1758373734984 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_8_1758373734984"}
2025-09-20 16:08:55.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_8_1758373734984", "status": 200, "latency_ms": 59.144020080566406, "minute": 8, "response_size": 211}
2025-09-20 16:08:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_8_1758373734984 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 8, "totalMinutesBilled": 8, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-20 16:08:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:08:55.044387", "request_id": "req_8_1758373734984", "minute": 8, "latency_ms": 59.144020080566406, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 8, "totalMinutesBilled": 8, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-20 16:08:55.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 8, "success": true, "latency_ms": 60.36996841430664, "iteration": 8}
2025-09-20 16:08:55.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_8_1758373735044", "minute": 8, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-20 16:08:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:08:55.044708", "response_id": "resp_8_1758373735044", "minute": 8, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-20 16:08:55.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_8_1758373735044 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-20 16:08:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=8 | total_duration_s=60.06 | webhook_duration_ms=60.37
2025-09-20 16:08:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration 9 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=8 | waiting_60s=true
2025-09-20 16:09:55.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=9 | minute=9 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:09:55.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_9_1758373795048 | url=http://localhost:3000/api/billing/voice-minute | minute=9 | attempt=9
2025-09-20 16:09:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_9_1758373795048 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 9, "timestamp": "2025-09-20T13:09:55.048660"}
2025-09-20 16:09:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_9_1758373795048 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_9_1758373795048"}
2025-09-20 16:09:55.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_9_1758373795048", "status": 200, "latency_ms": 34.73377227783203, "minute": 9, "response_size": 211}
2025-09-20 16:09:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_9_1758373795048 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 9, "totalMinutesBilled": 9, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-20 16:09:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:09:55.084446", "request_id": "req_9_1758373795048", "minute": 9, "latency_ms": 34.73377227783203, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 9, "totalMinutesBilled": 9, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-20 16:09:55.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 9, "success": true, "latency_ms": 36.1788272857666, "iteration": 9}
2025-09-20 16:09:55.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_9_1758373795084", "minute": 9, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-20 16:09:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:09:55.085019", "response_id": "resp_9_1758373795084", "minute": 9, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-20 16:09:55.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_9_1758373795084 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-20 16:09:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=9 | total_duration_s=60.04 | webhook_duration_ms=36.18
2025-09-20 16:09:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration 10 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=9 | waiting_60s=true
2025-09-20 16:10:18.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758373818476 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | state=active
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758373818477 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | reason=cleanup | minutes_billed=9
2025-09-20 16:10:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-20 16:10:18.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758373818477 | task_name=billing_loop_2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.478044", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-20 16:10:18.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | total_iterations=10 | minutes_billed=9
2025-09-20 16:10:18.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | total_iterations=10 | total_minutes=9 | final_state=stopping
2025-09-20 16:10:18.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758373818477 | task_name=billing_loop_2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758373818477", "total_seconds": 563.780965, "billed_minutes": 9, "calculated_minutes": 10, "needs_final_billing": true}
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758373818477 | minute=10
2025-09-20 16:10:18.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758373818478 | final_minute=10 | previous_minutes=9
2025-09-20 16:10:18.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_10_1758373818478 | url=http://localhost:3000/api/billing/voice-minute | minute=10 | attempt=10
2025-09-20 16:10:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_10_1758373818478 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 10, "timestamp": "2025-09-20T13:10:18.478443"}
2025-09-20 16:10:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_10_1758373818478 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_10_1758373818478"}
2025-09-20 16:10:18.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_10_1758373818478", "status": 200, "latency_ms": 24.90711212158203, "minute": 10, "response_size": 236}
2025-09-20 16:10:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_10_1758373818478 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 10, "totalMinutesBilled": 10, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.503598", "request_id": "req_10_1758373818478", "minute": 10, "latency_ms": 24.90711212158203, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 10, "totalMinutesBilled": 10, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-20 16:10:18.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758373818478 | success=True
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758373818477 | {"webhook_attempts": 10, "webhook_successes": 10, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 35.76312065124512, "min_latency_ms": 22.996902465820312, "max_latency_ms": 59.144020080566406, "last_webhook_time": "2025-09-20T13:10:18.503429", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T13:00:54.697285"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T13:00:54.697335"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-20T13:10:18.478044"}]}
2025-09-20 16:10:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:stopped | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.504073", "stop_id": "stop_1758373818477", "reason": "cleanup", "total_minutes": 10, "metrics": {"webhook_attempts": 10, "webhook_successes": 10, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 35.76312065124512, "min_latency_ms": 22.996902465820312, "max_latency_ms": 59.144020080566406, "last_webhook_time": "2025-09-20T13:10:18.503429", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T13:00:54.697285"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T13:00:54.697335"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-20T13:10:18.478044"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-20T13:10:18.504022"}]}}
2025-09-20 16:10:18.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758373818476 | final_state=stopped
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.504022", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-21 00:03:37.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T21:03:37.636425"}
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:processor_initialized | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.636425", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 00:03:37.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | correlation_token=transcript-1758402217369-rq608s2g1 | will_start_billing=True
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:first_audio_received | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.692928", "direction": "DOWNSTREAM"}
2025-09-21 00:03:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 00:03:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 00:03:37.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "start_time": "2025-09-20T21:03:37.693150", "backend_url": "http://localhost:3000"}
2025-09-21 00:03:37.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_5bbec813-4889-4aea-9cdc-e58e92774dfe | task_id=5803532416
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:started | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.693227", "start_time": "2025-09-20T21:03:37.693150", "backend_url": "http://localhost:3000"}
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.693068", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.693119", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 00:03:37.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:03:37.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | current_minute=0 | waiting_60s=true
2025-09-21 00:04:33.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T21:04:33.666835"}
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:processor_initialized | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.666835", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 00:04:33.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a | correlation_token=transcript-1758402273412-73gyu8nit | will_start_billing=True
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:first_audio_received | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.727860", "direction": "DOWNSTREAM"}
2025-09-21 00:04:33.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 00:04:33.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 00:04:33.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "start_time": "2025-09-20T21:04:33.728207", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:33.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_14c7af04-2ab9-497f-bb19-45f373c6310a | task_id=5864104256
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:started | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.728291", "start_time": "2025-09-20T21:04:33.728207", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:state_transition | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.728111", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:state_transition | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.728164", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 00:04:33.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a
2025-09-21 00:04:33.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | current_minute=0 | waiting_60s=true
2025-09-21 00:04:37.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | iteration=1 | minute=1 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758402277694 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758402277694 | data={"correlation_token": "transcript-1758402217369-rq608s2g1", "conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "minute": 1, "timestamp": "2025-09-20T21:04:37.694803"}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758402277694 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758402277694"}
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758402277694", "status": 200, "latency_ms": 25.20608901977539, "minute": 1, "response_size": 160}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758402277694 | data={"status": "error", "creditsRemaining": 0, "minuteBilled": 1, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:webhook_success | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720278", "request_id": "req_1_1758402277694", "minute": 1, "latency_ms": 25.20608901977539, "response": {"status": "error", "creditsRemaining": 0, "minuteBilled": 1, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}}
2025-09-21 00:04:37.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | {"minute": 1, "success": true, "latency_ms": 25.6960391998291, "iteration": 1}
2025-09-21 00:04:37.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758402277720", "minute": 1, "status": "error", "credits_remaining": 0, "should_terminate": true, "message": "Invalid correlation token - session not found", "grace_period": null}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:status_update | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720683", "response_id": "resp_1_1758402277720", "minute": 1, "status": "error", "credits_remaining": 0, "should_terminate": true, "message": "Invalid correlation token - session not found", "grace_period": null}
2025-09-21 00:04:37.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_1_1758402277720 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | reason=Invalid correlation token - session not found | grace_period=Nones
2025-09-21 00:04:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=active | to=stopping | reason=termination_requested
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:terminated | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720844", "reason": "insufficient_credits", "minutes_used": 1, "final_message": "Invalid correlation token - session not found"}
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758402277720 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | reason=insufficient_credits | minutes_billed=1
2025-09-21 00:04:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-21 00:04:37.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758402277720 | task_name=billing_loop_5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720806", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720923", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-21 00:04:37.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758402277720 | task_name=billing_loop_5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758402277720", "total_seconds": 60.027983, "billed_minutes": 1, "calculated_minutes": 2, "needs_final_billing": true}
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758402277720 | minute=2
2025-09-21 00:04:37.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758402277721 | final_minute=2 | previous_minutes=1
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758402277721 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758402277721 | data={"correlation_token": "transcript-1758402217369-rq608s2g1", "conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "minute": 2, "timestamp": "2025-09-20T21:04:37.721219"}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758402277721 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758402277721"}
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758402277721", "status": 200, "latency_ms": 6.0520172119140625, "minute": 2, "response_size": 160}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758402277721 | data={"status": "error", "creditsRemaining": 0, "minuteBilled": 2, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:webhook_success | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.727551", "request_id": "req_2_1758402277721", "minute": 2, "latency_ms": 6.0520172119140625, "response": {"status": "error", "creditsRemaining": 0, "minuteBilled": 2, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}}
2025-09-21 00:04:37.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758402277721 | success=True
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758402277720 | {"webhook_attempts": 2, "webhook_successes": 2, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 15.629053115844727, "min_latency_ms": 6.0520172119140625, "max_latency_ms": 25.20608901977539, "last_webhook_time": "2025-09-20T21:04:37.727350", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T21:03:37.693068"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T21:03:37.693119"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-20T21:04:37.720806"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-20T21:04:37.720923"}]}
2025-09-21 00:04:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:stopped | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.728025", "stop_id": "stop_1758402277720", "reason": "insufficient_credits", "total_minutes": 2, "metrics": {"webhook_attempts": 2, "webhook_successes": 2, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 15.629053115844727, "min_latency_ms": 6.0520172119140625, "max_latency_ms": 25.20608901977539, "last_webhook_time": "2025-09-20T21:04:37.727350", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T21:03:37.693068"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T21:03:37.693119"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-20T21:04:37.720806"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-20T21:04:37.720923"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-20T21:04:37.727936"}]}}
2025-09-21 00:04:37.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-21 00:04:37.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-21 00:04:37.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=25.70
2025-09-21 00:04:37.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | total_iterations=1 | total_minutes=2 | final_state=stopped
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.727936", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-21 00:04:48.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T21:04:48.163645"}
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:processor_initialized | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.163645", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 00:04:48.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e | correlation_token=transcript-1758402287937-ohsc01l1c | will_start_billing=True
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:first_audio_received | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228765", "direction": "DOWNSTREAM"}
2025-09-21 00:04:48.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 00:04:48.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 00:04:48.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "start_time": "2025-09-20T21:04:48.228925", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:48.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_e015f41e-3393-4621-9cd4-6552acd6389e | task_id=5868405760
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:started | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228984", "start_time": "2025-09-20T21:04:48.228925", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:state_transition | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228860", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:state_transition | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228897", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 00:04:48.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e
2025-09-21 00:04:48.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | current_minute=0 | waiting_60s=true
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | total_iterations=1 | minutes_billed=0
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | total_iterations=1 | minutes_billed=0
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-21 15:36:20.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T12:36:20.403931"}
2025-09-21 15:36:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:processor_initialized | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:36:20.403931", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 15:36:20.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | correlation_token=sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122 | will_start_billing=True
2025-09-21 15:36:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:first_audio_received | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:36:20.460551", "direction": "DOWNSTREAM"}
2025-09-21 15:36:20.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 15:36:20.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 15:36:20.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "start_time": "2025-09-21T12:36:20.460776", "backend_url": "http://localhost:3000"}
2025-09-21 15:36:20.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_627e46c4-36c2-4f14-9321-b92a9a7fa014 | task_id=4763361600
2025-09-21 15:36:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:started | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:36:20.460858", "start_time": "2025-09-21T12:36:20.460776", "backend_url": "http://localhost:3000"}
2025-09-21 15:36:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:state_transition | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:36:20.460647", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 15:36:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:state_transition | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:36:20.460709", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 15:36:20.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:36:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=0 | waiting_60s=true
2025-09-21 15:37:20.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=1 | minute=1 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:37:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758458240462 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 15:37:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758458240462 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 1, "timestamp": "2025-09-21T12:37:20.462425"}
2025-09-21 15:37:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758458240462 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758458240462"}
2025-09-21 15:37:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758458240462", "status": 200, "latency_ms": 23.252010345458984, "minute": 1, "response_size": 157}
2025-09-21 15:37:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758458240462 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:37:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:37:20.485975", "request_id": "req_1_1758458240462", "minute": 1, "latency_ms": 23.252010345458984, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:37:20.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | {"minute": 1, "success": true, "latency_ms": 23.700952529907227, "iteration": 1}
2025-09-21 15:37:20.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758458240486", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:37:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:status_update | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:37:20.486187", "response_id": "resp_1_1758458240486", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:37:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=23.70
2025-09-21 15:37:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=1 | waiting_60s=true
2025-09-21 15:38:20.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=2 | minute=2 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:38:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758458300488 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 15:38:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758458300488 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 2, "timestamp": "2025-09-21T12:38:20.488418"}
2025-09-21 15:38:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758458300488 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758458300488"}
2025-09-21 15:38:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758458300488", "status": 200, "latency_ms": 33.99181365966797, "minute": 2, "response_size": 157}
2025-09-21 15:38:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758458300488 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:38:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:38:20.523109", "request_id": "req_2_1758458300488", "minute": 2, "latency_ms": 33.99181365966797, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:38:20.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | {"minute": 2, "success": true, "latency_ms": 34.986019134521484, "iteration": 2}
2025-09-21 15:38:20.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758458300523", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:38:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:status_update | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:38:20.523543", "response_id": "resp_2_1758458300523", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:38:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=2 | total_duration_s=60.04 | webhook_duration_ms=34.99
2025-09-21 15:38:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=2 | waiting_60s=true
2025-09-21 15:39:20.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=3 | minute=3 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:39:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758458360529 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-21 15:39:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758458360529 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 3, "timestamp": "2025-09-21T12:39:20.529258"}
2025-09-21 15:39:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758458360529 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758458360529"}
2025-09-21 15:39:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758458360529", "status": 200, "latency_ms": 37.164926528930664, "minute": 3, "response_size": 157}
2025-09-21 15:39:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758458360529 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:39:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:39:20.567415", "request_id": "req_3_1758458360529", "minute": 3, "latency_ms": 37.164926528930664, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:39:20.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | {"minute": 3, "success": true, "latency_ms": 38.700103759765625, "iteration": 3}
2025-09-21 15:39:20.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758458360567", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:39:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:status_update | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:39:20.567953", "response_id": "resp_3_1758458360567", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:39:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=3 | total_duration_s=60.04 | webhook_duration_ms=38.70
2025-09-21 15:39:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=3 | waiting_60s=true
2025-09-21 15:40:20.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=4 | minute=4 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:40:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758458420571 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-21 15:40:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758458420571 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 4, "timestamp": "2025-09-21T12:40:20.571932"}
2025-09-21 15:40:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758458420571 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758458420571"}
2025-09-21 15:40:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758458420571", "status": 200, "latency_ms": 33.42318534851074, "minute": 4, "response_size": 157}
2025-09-21 15:40:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758458420571 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:40:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:40:20.606060", "request_id": "req_4_1758458420571", "minute": 4, "latency_ms": 33.42318534851074, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:40:20.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | {"minute": 4, "success": true, "latency_ms": 34.363746643066406, "iteration": 4}
2025-09-21 15:40:20.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758458420606", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:40:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:status_update | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:40:20.606359", "response_id": "resp_4_1758458420606", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:40:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=4 | total_duration_s=60.04 | webhook_duration_ms=34.36
2025-09-21 15:40:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=4 | waiting_60s=true
2025-09-21 15:41:20.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=5 | minute=5 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:41:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758458480611 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-21 15:41:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758458480611 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 5, "timestamp": "2025-09-21T12:41:20.611595"}
2025-09-21 15:41:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758458480611 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758458480611"}
2025-09-21 15:41:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758458480611", "status": 200, "latency_ms": 111.70101165771484, "minute": 5, "response_size": 157}
2025-09-21 15:41:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758458480611 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:41:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:41:20.724704", "request_id": "req_5_1758458480611", "minute": 5, "latency_ms": 111.70101165771484, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:41:20.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | {"minute": 5, "success": true, "latency_ms": 113.45624923706055, "iteration": 5}
2025-09-21 15:41:20.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758458480725", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:41:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:status_update | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:41:20.725179", "response_id": "resp_5_1758458480725", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:41:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=5 | total_duration_s=60.12 | webhook_duration_ms=113.46
2025-09-21 15:41:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=5 | waiting_60s=true
2025-09-21 15:42:20.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=6 | minute=6 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:42:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758458540728 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-21 15:42:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758458540728 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 6, "timestamp": "2025-09-21T12:42:20.728907"}
2025-09-21 15:42:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758458540728 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758458540728"}
2025-09-21 15:42:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758458540728", "status": 200, "latency_ms": 34.61194038391113, "minute": 6, "response_size": 157}
2025-09-21 15:42:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758458540728 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:42:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:42:20.764220", "request_id": "req_6_1758458540728", "minute": 6, "latency_ms": 34.61194038391113, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:42:20.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | {"minute": 6, "success": true, "latency_ms": 35.58516502380371, "iteration": 6}
2025-09-21 15:42:20.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758458540764", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:42:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:status_update | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:42:20.764568", "response_id": "resp_6_1758458540764", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:42:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | iteration=6 | total_duration_s=60.04 | webhook_duration_ms=35.59
2025-09-21 15:42:20.f | DEBUG    | _billing_loop             | [LOOP] Iteration 7 starting | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | current_minute=6 | waiting_60s=true
2025-09-21 15:42:38.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758458558270 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | state=active
2025-09-21 15:42:38.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758458558270 | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | reason=cleanup | minutes_billed=6
2025-09-21 15:42:38.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-21 15:42:38.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758458558270 | task_name=billing_loop_627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:42:38.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:state_transition | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:42:38.271186", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-21 15:42:38.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | total_iterations=7 | minutes_billed=6
2025-09-21 15:42:38.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=627e46c4-36c2-4f14-9321-b92a9a7fa014_1758458180 | total_iterations=7 | total_minutes=6 | final_state=stopping
2025-09-21 15:42:38.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758458558270 | task_name=billing_loop_627e46c4-36c2-4f14-9321-b92a9a7fa014
2025-09-21 15:42:38.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758458558270", "total_seconds": 377.812557, "billed_minutes": 6, "calculated_minutes": 7, "needs_final_billing": true}
2025-09-21 15:42:38.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758458558270 | minute=7
2025-09-21 15:42:38.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758458558273 | final_minute=7 | previous_minutes=6
2025-09-21 15:42:38.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_7_1758458558273 | url=http://localhost:3000/api/billing/voice-minute | minute=7 | attempt=7
2025-09-21 15:42:38.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_7_1758458558273 | data={"correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "minute": 7, "timestamp": "2025-09-21T12:42:38.273782"}
2025-09-21 15:42:38.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_7_1758458558273 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_7_1758458558273"}
2025-09-21 15:42:38.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_7_1758458558273", "status": 200, "latency_ms": 35.341739654541016, "minute": 7, "response_size": 157}
2025-09-21 15:42:38.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_7_1758458558273 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}
2025-09-21 15:42:38.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:webhook_success | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:42:38.309865", "request_id": "req_7_1758458558273", "minute": 7, "latency_ms": 35.341739654541016, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "8f4294c9-6332-47f3-b21c-e34424233f19", "shouldTerminate": false}}
2025-09-21 15:42:38.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758458558273 | success=True
2025-09-21 15:42:38.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758458558270 | {"webhook_attempts": 7, "webhook_successes": 7, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 44.21237536839077, "min_latency_ms": 23.252010345458984, "max_latency_ms": 111.70101165771484, "last_webhook_time": "2025-09-21T12:42:38.309567", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T12:36:20.460647"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T12:36:20.460709"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-21T12:42:38.271186"}]}
2025-09-21 15:42:38.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=627e46c4-36c2-4f14-9321-b92a9a7fa014 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-21 15:42:38.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:stopped | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:42:38.310415", "stop_id": "stop_1758458558270", "reason": "cleanup", "total_minutes": 7, "metrics": {"webhook_attempts": 7, "webhook_successes": 7, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 44.21237536839077, "min_latency_ms": 23.252010345458984, "max_latency_ms": 111.70101165771484, "last_webhook_time": "2025-09-21T12:42:38.309567", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T12:36:20.460647"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T12:36:20.460709"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-21T12:42:38.271186"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-21T12:42:38.310270"}]}}
2025-09-21 15:42:38.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:627e46c4-36c2-4f14-9321-b92a9a7fa014:billing:state_transition | data={"conversation_id": "627e46c4-36c2-4f14-9321-b92a9a7fa014", "correlation_token": "sim_bcfbeccdd98d4ee98ee81cd721cd3251_1758458180122", "timestamp": "2025-09-21T12:42:38.310270", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-21 15:42:38.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758458558270 | final_state=stopped
2025-09-21 15:43:05.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T12:43:05.825662"}
2025-09-21 15:43:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c5857d16-0e5b-480f-ab60-20b5d80d22ae:billing:processor_initialized | data={"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "timestamp": "2025-09-21T12:43:05.825662", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 15:43:05.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae | correlation_token=sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548 | will_start_billing=True
2025-09-21 15:43:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c5857d16-0e5b-480f-ab60-20b5d80d22ae:billing:first_audio_received | data={"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "timestamp": "2025-09-21T12:43:05.882541", "direction": "DOWNSTREAM"}
2025-09-21 15:43:05.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 15:43:05.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 15:43:05.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "start_time": "2025-09-21T12:43:05.882691", "backend_url": "http://localhost:3000"}
2025-09-21 15:43:05.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_c5857d16-0e5b-480f-ab60-20b5d80d22ae | task_id=4786446656
2025-09-21 15:43:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c5857d16-0e5b-480f-ab60-20b5d80d22ae:billing:started | data={"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "timestamp": "2025-09-21T12:43:05.882752", "start_time": "2025-09-21T12:43:05.882691", "backend_url": "http://localhost:3000"}
2025-09-21 15:43:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c5857d16-0e5b-480f-ab60-20b5d80d22ae:billing:state_transition | data={"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "timestamp": "2025-09-21T12:43:05.882628", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 15:43:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c5857d16-0e5b-480f-ab60-20b5d80d22ae:billing:state_transition | data={"conversation_id": "c5857d16-0e5b-480f-ab60-20b5d80d22ae", "correlation_token": "sim_2dfd6c1359d94292f8e9b4ee6d3e1969_1758458585548", "timestamp": "2025-09-21T12:43:05.882662", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 15:43:05.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae_1758458585 | conversation_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae
2025-09-21 15:43:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae_1758458585 | current_minute=0 | waiting_60s=true
2025-09-21 15:43:50.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae_1758458585 | total_iterations=1 | minutes_billed=0
2025-09-21 15:43:50.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=c5857d16-0e5b-480f-ab60-20b5d80d22ae_1758458585 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-21 15:44:46.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T12:44:46.301472"}
2025-09-21 15:44:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:processor_initialized | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:44:46.301472", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 15:44:46.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | correlation_token=sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026 | will_start_billing=True
2025-09-21 15:44:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:first_audio_received | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:44:46.356797", "direction": "DOWNSTREAM"}
2025-09-21 15:44:46.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 15:44:46.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 15:44:46.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "start_time": "2025-09-21T12:44:46.356960", "backend_url": "http://localhost:3000"}
2025-09-21 15:44:46.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_771f8a41-bca5-4a17-8aaa-786908018ad3 | task_id=5173404352
2025-09-21 15:44:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:started | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:44:46.357022", "start_time": "2025-09-21T12:44:46.356960", "backend_url": "http://localhost:3000"}
2025-09-21 15:44:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:state_transition | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:44:46.356894", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 15:44:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:state_transition | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:44:46.356932", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 15:44:46.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3
2025-09-21 15:44:46.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | current_minute=0 | waiting_60s=true
2025-09-21 15:45:46.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | iteration=1 | minute=1 | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3
2025-09-21 15:45:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758458746359 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 15:45:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758458746359 | data={"correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "minute": 1, "timestamp": "2025-09-21T12:45:46.359218"}
2025-09-21 15:45:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758458746359 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758458746359"}
2025-09-21 15:45:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758458746359", "status": 200, "latency_ms": 60.10103225708008, "minute": 1, "response_size": 211}
2025-09-21 15:45:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758458746359 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-21 15:45:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:webhook_success | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:45:46.421656", "request_id": "req_1_1758458746359", "minute": 1, "latency_ms": 60.10103225708008, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-21 15:45:46.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | {"minute": 1, "success": true, "latency_ms": 65.2310848236084, "iteration": 1}
2025-09-21 15:45:46.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758458746424", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-21 15:45:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:status_update | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:45:46.424848", "response_id": "resp_1_1758458746424", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-21 15:45:46.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_1_1758458746424 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-21 15:45:46.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | iteration=1 | total_duration_s=60.07 | webhook_duration_ms=65.23
2025-09-21 15:45:46.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | current_minute=1 | waiting_60s=true
2025-09-21 15:46:46.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | iteration=2 | minute=2 | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3
2025-09-21 15:46:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758458806427 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 15:46:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758458806427 | data={"correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "minute": 2, "timestamp": "2025-09-21T12:46:46.427851"}
2025-09-21 15:46:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758458806427 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758458806427"}
2025-09-21 15:46:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758458806427", "status": 200, "latency_ms": 25.656938552856445, "minute": 2, "response_size": 211}
2025-09-21 15:46:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758458806427 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-21 15:46:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:webhook_success | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:46:46.453870", "request_id": "req_2_1758458806427", "minute": 2, "latency_ms": 25.656938552856445, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-21 15:46:46.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | {"minute": 2, "success": true, "latency_ms": 26.178836822509766, "iteration": 2}
2025-09-21 15:46:46.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758458806454", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-21 15:46:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:status_update | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:46:46.454099", "response_id": "resp_2_1758458806454", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-21 15:46:46.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_2_1758458806454 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-21 15:46:46.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | iteration=2 | total_duration_s=60.03 | webhook_duration_ms=26.18
2025-09-21 15:46:46.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | current_minute=2 | waiting_60s=true
2025-09-21 15:47:46.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | iteration=3 | minute=3 | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3
2025-09-21 15:47:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758458866456 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-21 15:47:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758458866456 | data={"correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "minute": 3, "timestamp": "2025-09-21T12:47:46.456055"}
2025-09-21 15:47:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758458866456 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758458866456"}
2025-09-21 15:47:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758458866456", "status": 200, "latency_ms": 45.38702964782715, "minute": 3, "response_size": 234}
2025-09-21 15:47:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758458866456 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-21 15:47:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:webhook_success | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:47:46.502210", "request_id": "req_3_1758458866456", "minute": 3, "latency_ms": 45.38702964782715, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-21 15:47:46.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | {"minute": 3, "success": true, "latency_ms": 46.40984535217285, "iteration": 3}
2025-09-21 15:47:46.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758458866502", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-21 15:47:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:status_update | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:47:46.502660", "response_id": "resp_3_1758458866502", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-21 15:47:46.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_3_1758458866502 | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | reason=Last credit used - conversation will end | grace_period=60s
2025-09-21 15:47:46.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | from=active | to=stopping | reason=termination_requested
2025-09-21 15:47:46.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=60s
2025-09-21 15:47:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:grace_period_started | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:47:46.502976", "duration_seconds": 60, "reason": "Last credit used - conversation will end"}
2025-09-21 15:47:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:state_transition | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:47:46.502879", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-21 15:48:46.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-21 15:48:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:grace_period_ended | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:48:46.506426"}
2025-09-21 15:48:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:terminated | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:48:46.506836", "reason": "insufficient_credits", "minutes_used": 3, "final_message": "Last credit used - conversation will end"}
2025-09-21 15:48:46.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758458926507 | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | reason=insufficient_credits | minutes_billed=3
2025-09-21 15:48:46.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-21 15:48:46.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758458926507 | task_name=billing_loop_771f8a41-bca5-4a17-8aaa-786908018ad3
2025-09-21 15:48:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:state_transition | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:48:46.507792", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-21 15:48:46.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758458926507 | task_name=billing_loop_771f8a41-bca5-4a17-8aaa-786908018ad3
2025-09-21 15:48:46.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758458926507", "total_seconds": 240.151964, "billed_minutes": 3, "calculated_minutes": 5, "needs_final_billing": true}
2025-09-21 15:48:46.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758458926507 | minute=5
2025-09-21 15:48:46.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758458926509 | final_minute=5 | previous_minutes=3
2025-09-21 15:48:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758458926509 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=4
2025-09-21 15:48:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758458926509 | data={"correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "minute": 5, "timestamp": "2025-09-21T12:48:46.509314"}
2025-09-21 15:48:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758458926509 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758458926509"}
2025-09-21 15:48:46.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758458926509", "status": 200, "latency_ms": 29.91199493408203, "minute": 5, "response_size": 226}
2025-09-21 15:48:46.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758458926509 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 3, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-21 15:48:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:webhook_success | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:48:46.539651", "request_id": "req_5_1758458926509", "minute": 5, "latency_ms": 29.91199493408203, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 3, "attemptId": "8b651344-a2a2-47c0-8906-da08feeb0601", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-21 15:48:46.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758458926509 | success=True
2025-09-21 15:48:46.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758458926507 | {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 40.264248847961426, "min_latency_ms": 25.656938552856445, "max_latency_ms": 60.10103225708008, "last_webhook_time": "2025-09-21T12:48:46.539422", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T12:44:46.356894"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T12:44:46.356932"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-21T12:47:46.502879"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-21T12:48:46.507792"}]}
2025-09-21 15:48:46.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=771f8a41-bca5-4a17-8aaa-786908018ad3 | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-21 15:48:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:stopped | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:48:46.540206", "stop_id": "stop_1758458926507", "reason": "insufficient_credits", "total_minutes": 5, "metrics": {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 40.264248847961426, "min_latency_ms": 25.656938552856445, "max_latency_ms": 60.10103225708008, "last_webhook_time": "2025-09-21T12:48:46.539422", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T12:44:46.356894"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T12:44:46.356932"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-21T12:47:46.502879"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-21T12:48:46.507792"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-21T12:48:46.540146"}]}}
2025-09-21 15:48:46.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-21 15:48:46.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-21 15:48:46.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | iteration=3 | total_duration_s=120.09 | webhook_duration_ms=46.41
2025-09-21 15:48:46.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=771f8a41-bca5-4a17-8aaa-786908018ad3_1758458686 | total_iterations=3 | total_minutes=5 | final_state=stopped
2025-09-21 15:48:46.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:771f8a41-bca5-4a17-8aaa-786908018ad3:billing:state_transition | data={"conversation_id": "771f8a41-bca5-4a17-8aaa-786908018ad3", "correlation_token": "sim_5843fb55034be0b70c9cf207f7082ae3_1758458686026", "timestamp": "2025-09-21T12:48:46.540146", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-21 15:51:26.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T12:51:26.706065"}
2025-09-21 15:51:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:11b2e00f-0ea1-428c-895f-58917e11e5cc:billing:processor_initialized | data={"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:51:26.706065", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 15:51:26.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=11b2e00f-0ea1-428c-895f-58917e11e5cc | correlation_token=sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257 | will_start_billing=True
2025-09-21 15:51:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:11b2e00f-0ea1-428c-895f-58917e11e5cc:billing:first_audio_received | data={"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:51:26.769268", "direction": "DOWNSTREAM"}
2025-09-21 15:51:26.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=11b2e00f-0ea1-428c-895f-58917e11e5cc | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 15:51:26.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=11b2e00f-0ea1-428c-895f-58917e11e5cc | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 15:51:26.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "start_time": "2025-09-21T12:51:26.769458", "backend_url": "http://localhost:3000"}
2025-09-21 15:51:26.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_11b2e00f-0ea1-428c-895f-58917e11e5cc | task_id=4977239296
2025-09-21 15:51:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:11b2e00f-0ea1-428c-895f-58917e11e5cc:billing:started | data={"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:51:26.769541", "start_time": "2025-09-21T12:51:26.769458", "backend_url": "http://localhost:3000"}
2025-09-21 15:51:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:11b2e00f-0ea1-428c-895f-58917e11e5cc:billing:state_transition | data={"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:51:26.769359", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 15:51:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:11b2e00f-0ea1-428c-895f-58917e11e5cc:billing:state_transition | data={"conversation_id": "11b2e00f-0ea1-428c-895f-58917e11e5cc", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:51:26.769395", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 15:51:26.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=11b2e00f-0ea1-428c-895f-58917e11e5cc_1758459086 | conversation_id=11b2e00f-0ea1-428c-895f-58917e11e5cc
2025-09-21 15:51:26.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=11b2e00f-0ea1-428c-895f-58917e11e5cc_1758459086 | current_minute=0 | waiting_60s=true
2025-09-21 15:51:57.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=11b2e00f-0ea1-428c-895f-58917e11e5cc_1758459086 | total_iterations=1 | minutes_billed=0
2025-09-21 15:51:57.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=11b2e00f-0ea1-428c-895f-58917e11e5cc_1758459086 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-21 15:52:35.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T12:52:35.404938"}
2025-09-21 15:52:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:f9bfc756-ac1c-4c0f-896d-8e7724e0e586:billing:processor_initialized | data={"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:52:35.404938", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 15:52:35.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586 | correlation_token=sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257 | will_start_billing=True
2025-09-21 15:52:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:f9bfc756-ac1c-4c0f-896d-8e7724e0e586:billing:first_audio_received | data={"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:52:35.460475", "direction": "DOWNSTREAM"}
2025-09-21 15:52:35.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 15:52:35.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 15:52:35.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "start_time": "2025-09-21T12:52:35.460657", "backend_url": "http://localhost:3000"}
2025-09-21 15:52:35.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_f9bfc756-ac1c-4c0f-896d-8e7724e0e586 | task_id=4606714368
2025-09-21 15:52:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:f9bfc756-ac1c-4c0f-896d-8e7724e0e586:billing:started | data={"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:52:35.460718", "start_time": "2025-09-21T12:52:35.460657", "backend_url": "http://localhost:3000"}
2025-09-21 15:52:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:f9bfc756-ac1c-4c0f-896d-8e7724e0e586:billing:state_transition | data={"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:52:35.460590", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 15:52:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:f9bfc756-ac1c-4c0f-896d-8e7724e0e586:billing:state_transition | data={"conversation_id": "f9bfc756-ac1c-4c0f-896d-8e7724e0e586", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:52:35.460628", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 15:52:35.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586_1758459155 | conversation_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586
2025-09-21 15:52:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586_1758459155 | current_minute=0 | waiting_60s=true
2025-09-21 15:53:15.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586_1758459155 | total_iterations=1 | minutes_billed=0
2025-09-21 15:53:15.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=f9bfc756-ac1c-4c0f-896d-8e7724e0e586_1758459155 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-21 15:54:14.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T12:54:14.808462"}
2025-09-21 15:54:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:processor_initialized | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:54:14.808462", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 15:54:14.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | correlation_token=sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257 | will_start_billing=True
2025-09-21 15:54:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:first_audio_received | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:54:14.859099", "direction": "DOWNSTREAM"}
2025-09-21 15:54:14.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 15:54:14.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 15:54:14.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "start_time": "2025-09-21T12:54:14.859296", "backend_url": "http://localhost:3000"}
2025-09-21 15:54:14.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_0ae31958-f6c6-42d2-9e7a-99911534fb36 | task_id=4588906496
2025-09-21 15:54:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:started | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:54:14.859360", "start_time": "2025-09-21T12:54:14.859296", "backend_url": "http://localhost:3000"}
2025-09-21 15:54:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:state_transition | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:54:14.859174", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 15:54:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:state_transition | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:54:14.859259", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 15:54:14.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 15:54:14.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=0 | waiting_60s=true
2025-09-21 15:55:14.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=1 | minute=1 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 15:55:14.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758459314861 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 15:55:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758459314861 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 1, "timestamp": "2025-09-21T12:55:14.861016"}
2025-09-21 15:55:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758459314861 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758459314861"}
2025-09-21 15:55:14.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758459314861", "status": 200, "latency_ms": 25.716066360473633, "minute": 1, "response_size": 157}
2025-09-21 15:55:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758459314861 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 15:55:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:55:14.887098", "request_id": "req_1_1758459314861", "minute": 1, "latency_ms": 25.716066360473633, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 15:55:14.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | {"minute": 1, "success": true, "latency_ms": 26.307106018066406, "iteration": 1}
2025-09-21 15:55:14.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758459314887", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:55:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:status_update | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:55:14.887397", "response_id": "resp_1_1758459314887", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:55:14.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=26.31
2025-09-21 15:55:14.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=1 | waiting_60s=true
2025-09-21 15:56:14.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=2 | minute=2 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 15:56:14.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758459374890 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 15:56:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758459374890 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 2, "timestamp": "2025-09-21T12:56:14.890055"}
2025-09-21 15:56:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758459374890 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758459374890"}
2025-09-21 15:56:14.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758459374890", "status": 200, "latency_ms": 58.821678161621094, "minute": 2, "response_size": 157}
2025-09-21 15:56:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758459374890 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 15:56:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:56:14.949980", "request_id": "req_2_1758459374890", "minute": 2, "latency_ms": 58.821678161621094, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 15:56:14.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | {"minute": 2, "success": true, "latency_ms": 62.01815605163574, "iteration": 2}
2025-09-21 15:56:14.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758459374952", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:56:14.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:status_update | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:56:14.952622", "response_id": "resp_2_1758459374952", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:56:14.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=2 | total_duration_s=60.07 | webhook_duration_ms=62.02
2025-09-21 15:56:14.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=2 | waiting_60s=true
2025-09-21 15:57:14.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=3 | minute=3 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 15:57:14.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758459434958 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-21 15:57:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758459434958 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 3, "timestamp": "2025-09-21T12:57:14.958297"}
2025-09-21 15:57:14.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758459434958 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758459434958"}
2025-09-21 15:57:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758459434958", "status": 200, "latency_ms": 60.21690368652344, "minute": 3, "response_size": 157}
2025-09-21 15:57:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758459434958 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 15:57:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:57:15.019250", "request_id": "req_3_1758459434958", "minute": 3, "latency_ms": 60.21690368652344, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 15:57:15.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | {"minute": 3, "success": true, "latency_ms": 61.457157135009766, "iteration": 3}
2025-09-21 15:57:15.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758459435019", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:57:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:status_update | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:57:15.019801", "response_id": "resp_3_1758459435019", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:57:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=3 | total_duration_s=60.07 | webhook_duration_ms=61.46
2025-09-21 15:57:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=3 | waiting_60s=true
2025-09-21 15:58:15.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=4 | minute=4 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 15:58:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758459495027 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-21 15:58:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758459495027 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 4, "timestamp": "2025-09-21T12:58:15.027381"}
2025-09-21 15:58:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758459495027 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758459495027"}
2025-09-21 15:58:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758459495027", "status": 200, "latency_ms": 63.899993896484375, "minute": 4, "response_size": 157}
2025-09-21 15:58:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758459495027 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 15:58:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:58:15.092569", "request_id": "req_4_1758459495027", "minute": 4, "latency_ms": 63.899993896484375, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 15:58:15.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | {"minute": 4, "success": true, "latency_ms": 65.7188892364502, "iteration": 4}
2025-09-21 15:58:15.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758459495093", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:58:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:status_update | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:58:15.093219", "response_id": "resp_4_1758459495093", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:58:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=4 | total_duration_s=60.07 | webhook_duration_ms=65.72
2025-09-21 15:58:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=4 | waiting_60s=true
2025-09-21 15:59:15.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=5 | minute=5 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 15:59:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758459555095 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-21 15:59:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758459555095 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 5, "timestamp": "2025-09-21T12:59:15.095298"}
2025-09-21 15:59:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758459555095 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758459555095"}
2025-09-21 15:59:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758459555095", "status": 200, "latency_ms": 18.87798309326172, "minute": 5, "response_size": 157}
2025-09-21 15:59:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758459555095 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 15:59:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:59:15.114526", "request_id": "req_5_1758459555095", "minute": 5, "latency_ms": 18.87798309326172, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 15:59:15.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | {"minute": 5, "success": true, "latency_ms": 19.416093826293945, "iteration": 5}
2025-09-21 15:59:15.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758459555114", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:59:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:status_update | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T12:59:15.114826", "response_id": "resp_5_1758459555114", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 15:59:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=5 | total_duration_s=60.02 | webhook_duration_ms=19.42
2025-09-21 15:59:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=5 | waiting_60s=true
2025-09-21 16:00:15.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=6 | minute=6 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 16:00:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758459615117 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-21 16:00:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758459615117 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 6, "timestamp": "2025-09-21T13:00:15.117796"}
2025-09-21 16:00:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758459615117 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758459615117"}
2025-09-21 16:00:15.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758459615117", "status": 200, "latency_ms": 33.995866775512695, "minute": 6, "response_size": 157}
2025-09-21 16:00:15.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758459615117 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 16:00:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T13:00:15.152518", "request_id": "req_6_1758459615117", "minute": 6, "latency_ms": 33.995866775512695, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 16:00:15.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | {"minute": 6, "success": true, "latency_ms": 35.00223159790039, "iteration": 6}
2025-09-21 16:00:15.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758459615152", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:00:15.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:status_update | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T13:00:15.152895", "response_id": "resp_6_1758459615152", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:00:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | iteration=6 | total_duration_s=60.04 | webhook_duration_ms=35.00
2025-09-21 16:00:15.f | DEBUG    | _billing_loop             | [LOOP] Iteration 7 starting | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | current_minute=6 | waiting_60s=true
2025-09-21 16:00:20.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758459620826 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | state=active
2025-09-21 16:00:20.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758459620826 | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | reason=cleanup | minutes_billed=6
2025-09-21 16:00:20.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-21 16:00:20.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758459620826 | task_name=billing_loop_0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 16:00:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:state_transition | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T13:00:20.826318", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-21 16:00:20.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | total_iterations=7 | minutes_billed=6
2025-09-21 16:00:20.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=0ae31958-f6c6-42d2-9e7a-99911534fb36_1758459254 | total_iterations=7 | total_minutes=6 | final_state=stopping
2025-09-21 16:00:20.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758459620826 | task_name=billing_loop_0ae31958-f6c6-42d2-9e7a-99911534fb36
2025-09-21 16:00:20.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758459620826", "total_seconds": 365.967386, "billed_minutes": 6, "calculated_minutes": 7, "needs_final_billing": true}
2025-09-21 16:00:20.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758459620826 | minute=7
2025-09-21 16:00:20.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758459620826 | final_minute=7 | previous_minutes=6
2025-09-21 16:00:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_7_1758459620826 | url=http://localhost:3000/api/billing/voice-minute | minute=7 | attempt=7
2025-09-21 16:00:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_7_1758459620826 | data={"correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "minute": 7, "timestamp": "2025-09-21T13:00:20.826814"}
2025-09-21 16:00:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_7_1758459620826 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_7_1758459620826"}
2025-09-21 16:00:20.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_7_1758459620826", "status": 200, "latency_ms": 23.3457088470459, "minute": 7, "response_size": 157}
2025-09-21 16:00:20.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_7_1758459620826 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}
2025-09-21 16:00:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:webhook_success | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T13:00:20.850456", "request_id": "req_7_1758459620826", "minute": 7, "latency_ms": 23.3457088470459, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "cb16e5f9-a566-4e2b-8d76-285f287d0a4e", "shouldTerminate": false}}
2025-09-21 16:00:20.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758459620826 | success=True
2025-09-21 16:00:20.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758459620826 | {"webhook_attempts": 7, "webhook_successes": 7, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 40.69631440298898, "min_latency_ms": 18.87798309326172, "max_latency_ms": 63.899993896484375, "last_webhook_time": "2025-09-21T13:00:20.850258", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T12:54:14.859174"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T12:54:14.859259"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-21T13:00:20.826318"}]}
2025-09-21 16:00:20.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=0ae31958-f6c6-42d2-9e7a-99911534fb36 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-21 16:00:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:stopped | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T13:00:20.850833", "stop_id": "stop_1758459620826", "reason": "cleanup", "total_minutes": 7, "metrics": {"webhook_attempts": 7, "webhook_successes": 7, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 40.69631440298898, "min_latency_ms": 18.87798309326172, "max_latency_ms": 63.899993896484375, "last_webhook_time": "2025-09-21T13:00:20.850258", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T12:54:14.859174"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T12:54:14.859259"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-21T13:00:20.826318"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-21T13:00:20.850788"}]}}
2025-09-21 16:00:20.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:0ae31958-f6c6-42d2-9e7a-99911534fb36:billing:state_transition | data={"conversation_id": "0ae31958-f6c6-42d2-9e7a-99911534fb36", "correlation_token": "sim_b8d76b9b0b56946a3bdc7bd454191a36_1758459056257", "timestamp": "2025-09-21T13:00:20.850788", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-21 16:00:20.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758459620826 | final_state=stopped
2025-09-21 16:03:10.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T13:03:10.260602"}
2025-09-21 16:03:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:processor_initialized | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:03:10.260602", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 16:03:10.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | correlation_token=sim_592915840ce4be9191c4989787516ed7_1758459789973 | will_start_billing=True
2025-09-21 16:03:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:first_audio_received | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:03:10.324566", "direction": "DOWNSTREAM"}
2025-09-21 16:03:10.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 16:03:10.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 16:03:10.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "start_time": "2025-09-21T13:03:10.324737", "backend_url": "http://localhost:3000"}
2025-09-21 16:03:10.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | task_id=4588908224
2025-09-21 16:03:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:started | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:03:10.324814", "start_time": "2025-09-21T13:03:10.324737", "backend_url": "http://localhost:3000"}
2025-09-21 16:03:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:state_transition | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:03:10.324664", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 16:03:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:state_transition | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:03:10.324706", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 16:03:10.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09
2025-09-21 16:03:10.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | current_minute=0 | waiting_60s=true
2025-09-21 16:04:10.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | iteration=1 | minute=1 | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09
2025-09-21 16:04:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758459850325 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 16:04:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758459850325 | data={"correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "minute": 1, "timestamp": "2025-09-21T13:04:10.325185"}
2025-09-21 16:04:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758459850325 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758459850325"}
2025-09-21 16:04:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758459850325", "status": 200, "latency_ms": 26.76701545715332, "minute": 1, "response_size": 211}
2025-09-21 16:04:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758459850325 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-21 16:04:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:webhook_success | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:04:10.352328", "request_id": "req_1_1758459850325", "minute": 1, "latency_ms": 26.76701545715332, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-21 16:04:10.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | {"minute": 1, "success": true, "latency_ms": 27.376174926757812, "iteration": 1}
2025-09-21 16:04:10.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758459850352", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-21 16:04:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:status_update | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:04:10.352657", "response_id": "resp_1_1758459850352", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-21 16:04:10.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_1_1758459850352 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-21 16:04:10.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=27.38
2025-09-21 16:04:10.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | current_minute=1 | waiting_60s=true
2025-09-21 16:05:10.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | iteration=2 | minute=2 | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09
2025-09-21 16:05:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758459910357 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 16:05:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758459910357 | data={"correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "minute": 2, "timestamp": "2025-09-21T13:05:10.357253"}
2025-09-21 16:05:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758459910357 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758459910357"}
2025-09-21 16:05:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758459910357", "status": 200, "latency_ms": 34.61313247680664, "minute": 2, "response_size": 211}
2025-09-21 16:05:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758459910357 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-21 16:05:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:webhook_success | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:05:10.393155", "request_id": "req_2_1758459910357", "minute": 2, "latency_ms": 34.61313247680664, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-21 16:05:10.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | {"minute": 2, "success": true, "latency_ms": 36.41796112060547, "iteration": 2}
2025-09-21 16:05:10.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758459910393", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-21 16:05:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:status_update | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:05:10.393729", "response_id": "resp_2_1758459910393", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-21 16:05:10.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_2_1758459910393 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-21 16:05:10.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | iteration=2 | total_duration_s=60.04 | webhook_duration_ms=36.42
2025-09-21 16:05:10.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | current_minute=2 | waiting_60s=true
2025-09-21 16:06:10.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | iteration=3 | minute=3 | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09
2025-09-21 16:06:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758459970396 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-21 16:06:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758459970396 | data={"correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "minute": 3, "timestamp": "2025-09-21T13:06:10.396155"}
2025-09-21 16:06:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758459970396 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758459970396"}
2025-09-21 16:06:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758459970396", "status": 200, "latency_ms": 36.83590888977051, "minute": 3, "response_size": 234}
2025-09-21 16:06:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758459970396 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-21 16:06:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:webhook_success | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:06:10.434132", "request_id": "req_3_1758459970396", "minute": 3, "latency_ms": 36.83590888977051, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-21 16:06:10.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | {"minute": 3, "success": true, "latency_ms": 38.170814514160156, "iteration": 3}
2025-09-21 16:06:10.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758459970434", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-21 16:06:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:status_update | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:06:10.434464", "response_id": "resp_3_1758459970434", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-21 16:06:10.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_3_1758459970434 | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | reason=Last credit used - conversation will end | grace_period=60s
2025-09-21 16:06:10.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | from=active | to=stopping | reason=termination_requested
2025-09-21 16:06:10.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=60s
2025-09-21 16:06:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:grace_period_started | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:06:10.434728", "duration_seconds": 60, "reason": "Last credit used - conversation will end"}
2025-09-21 16:06:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:state_transition | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:06:10.434622", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-21 16:07:10.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-21 16:07:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:grace_period_ended | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:07:10.437364"}
2025-09-21 16:07:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:terminated | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:07:10.437622", "reason": "insufficient_credits", "minutes_used": 3, "final_message": "Last credit used - conversation will end"}
2025-09-21 16:07:10.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758460030437 | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | reason=insufficient_credits | minutes_billed=3
2025-09-21 16:07:10.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-21 16:07:10.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758460030437 | task_name=billing_loop_00052a58-b53c-4bb6-b2c2-c43f4aa3cc09
2025-09-21 16:07:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:state_transition | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:07:10.437727", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-21 16:07:10.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758460030437 | task_name=billing_loop_00052a58-b53c-4bb6-b2c2-c43f4aa3cc09
2025-09-21 16:07:10.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758460030437", "total_seconds": 240.113284, "billed_minutes": 3, "calculated_minutes": 5, "needs_final_billing": true}
2025-09-21 16:07:10.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758460030437 | minute=5
2025-09-21 16:07:10.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758460030438 | final_minute=5 | previous_minutes=3
2025-09-21 16:07:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758460030438 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=4
2025-09-21 16:07:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758460030438 | data={"correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "minute": 5, "timestamp": "2025-09-21T13:07:10.438119"}
2025-09-21 16:07:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758460030438 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758460030438"}
2025-09-21 16:07:10.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758460030438", "status": 200, "latency_ms": 9.150981903076172, "minute": 5, "response_size": 226}
2025-09-21 16:07:10.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758460030438 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 3, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-21 16:07:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:webhook_success | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:07:10.447554", "request_id": "req_5_1758460030438", "minute": 5, "latency_ms": 9.150981903076172, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 3, "attemptId": "307141d9-0e15-4770-a9e7-619b4bd67fe7", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-21 16:07:10.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758460030438 | success=True
2025-09-21 16:07:10.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758460030437 | {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 26.84175968170166, "min_latency_ms": 9.150981903076172, "max_latency_ms": 36.83590888977051, "last_webhook_time": "2025-09-21T13:07:10.447375", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T13:03:10.324664"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T13:03:10.324706"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-21T13:06:10.434622"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-21T13:07:10.437727"}]}
2025-09-21 16:07:10.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09 | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-21 16:07:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:stopped | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:07:10.447851", "stop_id": "stop_1758460030437", "reason": "insufficient_credits", "total_minutes": 5, "metrics": {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 26.84175968170166, "min_latency_ms": 9.150981903076172, "max_latency_ms": 36.83590888977051, "last_webhook_time": "2025-09-21T13:07:10.447375", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T13:03:10.324664"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T13:03:10.324706"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-21T13:06:10.434622"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-21T13:07:10.437727"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-21T13:07:10.447816"}]}}
2025-09-21 16:07:10.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-21 16:07:10.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-21 16:07:10.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | iteration=3 | total_duration_s=120.05 | webhook_duration_ms=38.17
2025-09-21 16:07:10.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=00052a58-b53c-4bb6-b2c2-c43f4aa3cc09_1758459790 | total_iterations=3 | total_minutes=5 | final_state=stopped
2025-09-21 16:07:10.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:00052a58-b53c-4bb6-b2c2-c43f4aa3cc09:billing:state_transition | data={"conversation_id": "00052a58-b53c-4bb6-b2c2-c43f4aa3cc09", "correlation_token": "sim_592915840ce4be9191c4989787516ed7_1758459789973", "timestamp": "2025-09-21T13:07:10.447816", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-21 16:07:35.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-21T13:07:35.469922"}
2025-09-21 16:07:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:processor_initialized | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:07:35.469922", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 16:07:35.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | correlation_token=sim_cb32ed92769159a690dae36c671c52c5_1758460055192 | will_start_billing=True
2025-09-21 16:07:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:first_audio_received | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:07:35.532475", "direction": "DOWNSTREAM"}
2025-09-21 16:07:35.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 16:07:35.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 16:07:35.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "start_time": "2025-09-21T13:07:35.532644", "backend_url": "http://localhost:3000"}
2025-09-21 16:07:35.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | task_id=4856701248
2025-09-21 16:07:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:started | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:07:35.532705", "start_time": "2025-09-21T13:07:35.532644", "backend_url": "http://localhost:3000"}
2025-09-21 16:07:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:state_transition | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:07:35.532568", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 16:07:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:state_transition | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:07:35.532606", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 16:07:35.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:07:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=0 | waiting_60s=true
2025-09-21 16:08:35.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=1 | minute=1 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:08:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758460115535 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 16:08:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758460115535 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 1, "timestamp": "2025-09-21T13:08:35.535659"}
2025-09-21 16:08:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758460115535 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758460115535"}
2025-09-21 16:08:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758460115535", "status": 200, "latency_ms": 33.799171447753906, "minute": 1, "response_size": 157}
2025-09-21 16:08:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758460115535 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:08:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:08:35.570219", "request_id": "req_1_1758460115535", "minute": 1, "latency_ms": 33.799171447753906, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:08:35.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | {"minute": 1, "success": true, "latency_ms": 34.818172454833984, "iteration": 1}
2025-09-21 16:08:35.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758460115570", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:08:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:status_update | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:08:35.570731", "response_id": "resp_1_1758460115570", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:08:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=1 | total_duration_s=60.04 | webhook_duration_ms=34.82
2025-09-21 16:08:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=1 | waiting_60s=true
2025-09-21 16:09:35.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=2 | minute=2 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:09:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758460175573 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 16:09:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758460175573 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 2, "timestamp": "2025-09-21T13:09:35.573909"}
2025-09-21 16:09:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758460175573 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758460175573"}
2025-09-21 16:09:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758460175573", "status": 200, "latency_ms": 40.59910774230957, "minute": 2, "response_size": 157}
2025-09-21 16:09:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758460175573 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:09:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:09:35.614969", "request_id": "req_2_1758460175573", "minute": 2, "latency_ms": 40.59910774230957, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:09:35.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | {"minute": 2, "success": true, "latency_ms": 41.3818359375, "iteration": 2}
2025-09-21 16:09:35.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758460175615", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:09:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:status_update | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:09:35.615485", "response_id": "resp_2_1758460175615", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:09:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=2 | total_duration_s=60.04 | webhook_duration_ms=41.38
2025-09-21 16:09:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=2 | waiting_60s=true
2025-09-21 16:10:35.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=3 | minute=3 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:10:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758460235617 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-21 16:10:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758460235617 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 3, "timestamp": "2025-09-21T13:10:35.617492"}
2025-09-21 16:10:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758460235617 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758460235617"}
2025-09-21 16:10:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758460235617", "status": 200, "latency_ms": 37.78195381164551, "minute": 3, "response_size": 157}
2025-09-21 16:10:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758460235617 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:10:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:10:35.655930", "request_id": "req_3_1758460235617", "minute": 3, "latency_ms": 37.78195381164551, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:10:35.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | {"minute": 3, "success": true, "latency_ms": 38.667917251586914, "iteration": 3}
2025-09-21 16:10:35.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758460235656", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:10:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:status_update | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:10:35.656235", "response_id": "resp_3_1758460235656", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:10:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=3 | total_duration_s=60.04 | webhook_duration_ms=38.67
2025-09-21 16:10:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=3 | waiting_60s=true
2025-09-21 16:11:35.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=4 | minute=4 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:11:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758460295659 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-21 16:11:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758460295659 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 4, "timestamp": "2025-09-21T13:11:35.659215"}
2025-09-21 16:11:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758460295659 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758460295659"}
2025-09-21 16:11:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758460295659", "status": 200, "latency_ms": 33.82301330566406, "minute": 4, "response_size": 157}
2025-09-21 16:11:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758460295659 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:11:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:11:35.694027", "request_id": "req_4_1758460295659", "minute": 4, "latency_ms": 33.82301330566406, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:11:35.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | {"minute": 4, "success": true, "latency_ms": 35.13026237487793, "iteration": 4}
2025-09-21 16:11:35.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758460295694", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:11:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:status_update | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:11:35.694533", "response_id": "resp_4_1758460295694", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:11:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=4 | total_duration_s=60.04 | webhook_duration_ms=35.13
2025-09-21 16:11:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=4 | waiting_60s=true
2025-09-21 16:12:35.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=5 | minute=5 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:12:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758460355695 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-21 16:12:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758460355695 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 5, "timestamp": "2025-09-21T13:12:35.695132"}
2025-09-21 16:12:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758460355695 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758460355695"}
2025-09-21 16:12:35.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758460355695", "status": 200, "latency_ms": 56.3349723815918, "minute": 5, "response_size": 157}
2025-09-21 16:12:35.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758460355695 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:12:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:12:35.753788", "request_id": "req_5_1758460355695", "minute": 5, "latency_ms": 56.3349723815918, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:12:35.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | {"minute": 5, "success": true, "latency_ms": 59.5247745513916, "iteration": 5}
2025-09-21 16:12:35.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758460355754", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:12:35.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:status_update | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:12:35.754739", "response_id": "resp_5_1758460355754", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:12:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=5 | total_duration_s=60.06 | webhook_duration_ms=59.52
2025-09-21 16:12:35.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=5 | waiting_60s=true
2025-09-21 16:17:28.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=6 | minute=6 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:17:28.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758460648881 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-21 16:17:28.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758460648881 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 6, "timestamp": "2025-09-21T13:17:28.882013"}
2025-09-21 16:17:28.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758460648881 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758460648881"}
2025-09-21 16:17:29.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758460648881", "status": 200, "latency_ms": 99.86114501953125, "minute": 6, "response_size": 157}
2025-09-21 16:17:29.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758460648881 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:17:29.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:17:29.028295", "request_id": "req_6_1758460648881", "minute": 6, "latency_ms": 99.86114501953125, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:17:29.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | {"minute": 6, "success": true, "latency_ms": 146.4979648590088, "iteration": 6}
2025-09-21 16:17:29.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758460649028", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:17:29.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:status_update | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:17:29.028559", "response_id": "resp_6_1758460649028", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-21 16:17:29.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=6 | total_duration_s=293.27 | webhook_duration_ms=146.50
2025-09-21 16:17:29.f | DEBUG    | _billing_loop             | [LOOP] Iteration 7 starting | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | current_minute=6 | waiting_60s=true
2025-09-21 16:33:27.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | iteration=7 | minute=7 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:33:27.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_7_1758461607213 | url=http://localhost:3000/api/billing/voice-minute | minute=7 | attempt=7
2025-09-21 16:33:27.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_7_1758461607213 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 7, "timestamp": "2025-09-21T13:33:27.213814"}
2025-09-21 16:33:27.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_7_1758461607213 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_7_1758461607213"}
2025-09-21 16:33:27.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758461607224 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | state=active
2025-09-21 16:33:27.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758461607224 | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | reason=cleanup | minutes_billed=7
2025-09-21 16:33:27.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-21 16:33:27.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758461607224 | task_name=billing_loop_fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:33:27.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:state_transition | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:33:27.224686", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-21 16:33:27.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | total_iterations=7 | minutes_billed=7
2025-09-21 16:33:27.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63_1758460055 | total_iterations=7 | total_minutes=7 | final_state=stopping
2025-09-21 16:33:27.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758461607224 | task_name=billing_loop_fd9ce2ca-1aca-4561-ad67-326f3bbc3a63
2025-09-21 16:33:27.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758461607224", "total_seconds": 1551.693139, "billed_minutes": 7, "calculated_minutes": 26, "needs_final_billing": true}
2025-09-21 16:33:27.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758461607224 | minute=26
2025-09-21 16:33:27.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758461607226 | final_minute=26 | previous_minutes=7
2025-09-21 16:33:27.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_26_1758461607226 | url=http://localhost:3000/api/billing/voice-minute | minute=26 | attempt=8
2025-09-21 16:33:27.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_26_1758461607226 | data={"correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "minute": 26, "timestamp": "2025-09-21T13:33:27.226117"}
2025-09-21 16:33:27.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_26_1758461607226 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_26_1758461607226"}
2025-09-21 16:33:27.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_26_1758461607226", "status": 200, "latency_ms": 59.2041015625, "minute": 26, "response_size": 159}
2025-09-21 16:33:27.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_26_1758461607226 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 26, "totalMinutesBilled": 26, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}
2025-09-21 16:33:27.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:webhook_success | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:33:27.285619", "request_id": "req_26_1758461607226", "minute": 26, "latency_ms": 59.2041015625, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 26, "totalMinutesBilled": 26, "attemptId": "ad2b4566-8a89-47e5-bbf2-126728fef650", "shouldTerminate": false}}
2025-09-21 16:33:27.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758461607226 | success=True
2025-09-21 16:33:27.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758461607224 | {"webhook_attempts": 8, "webhook_successes": 7, "webhook_failures": 0, "success_rate": 87.5, "avg_latency_ms": 51.629066467285156, "min_latency_ms": 33.799171447753906, "max_latency_ms": 99.86114501953125, "last_webhook_time": "2025-09-21T13:33:27.285432", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T13:07:35.532568"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T13:07:35.532606"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-21T13:33:27.224686"}]}
2025-09-21 16:33:27.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=fd9ce2ca-1aca-4561-ad67-326f3bbc3a63 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-21 16:33:27.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:stopped | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:33:27.286232", "stop_id": "stop_1758461607224", "reason": "cleanup", "total_minutes": 26, "metrics": {"webhook_attempts": 8, "webhook_successes": 7, "webhook_failures": 0, "success_rate": 87.5, "avg_latency_ms": 51.629066467285156, "min_latency_ms": 33.799171447753906, "max_latency_ms": 99.86114501953125, "last_webhook_time": "2025-09-21T13:33:27.285432", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-21T13:07:35.532568"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-21T13:07:35.532606"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-21T13:33:27.224686"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-21T13:33:27.286180"}]}}
2025-09-21 16:33:27.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:fd9ce2ca-1aca-4561-ad67-326f3bbc3a63:billing:state_transition | data={"conversation_id": "fd9ce2ca-1aca-4561-ad67-326f3bbc3a63", "correlation_token": "sim_cb32ed92769159a690dae36c671c52c5_1758460055192", "timestamp": "2025-09-21T13:33:27.286180", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-21 16:33:27.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758461607224 | final_state=stopped
2025-09-22 12:22:11.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:22:11.057972"}
2025-09-22 12:22:11.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151:billing:processor_initialized | data={"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:11.057972", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:22:11.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151 | correlation_token=sim_2b8085e88712ed90b695c814afa75a02_1758532912933 | will_start_billing=True
2025-09-22 12:22:11.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151:billing:first_audio_received | data={"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:11.670135", "direction": "DOWNSTREAM"}
2025-09-22 12:22:11.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:22:11.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:22:11.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "start_time": "2025-09-22T09:22:11.670524", "backend_url": "http://localhost:3000"}
2025-09-22 12:22:11.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151 | task_id=4856707008
2025-09-22 12:22:11.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151:billing:started | data={"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:11.670681", "start_time": "2025-09-22T09:22:11.670524", "backend_url": "http://localhost:3000"}
2025-09-22 12:22:11.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151:billing:state_transition | data={"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:11.670352", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:22:11.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151:billing:state_transition | data={"conversation_id": "8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:11.670447", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:22:11.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151_1758532931 | conversation_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151
2025-09-22 12:22:11.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151_1758532931 | current_minute=0 | waiting_60s=true
2025-09-22 12:22:27.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:22:27.925488"}
2025-09-22 12:22:27.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:a7481cdc-7fb2-47bd-acc3-e78c96a819e9:billing:processor_initialized | data={"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:27.925488", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:22:28.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9 | correlation_token=sim_2b8085e88712ed90b695c814afa75a02_1758532912933 | will_start_billing=True
2025-09-22 12:22:28.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:a7481cdc-7fb2-47bd-acc3-e78c96a819e9:billing:first_audio_received | data={"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:28.002403", "direction": "DOWNSTREAM"}
2025-09-22 12:22:28.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:22:28.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:22:28.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "start_time": "2025-09-22T09:22:28.002568", "backend_url": "http://localhost:3000"}
2025-09-22 12:22:28.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_a7481cdc-7fb2-47bd-acc3-e78c96a819e9 | task_id=4963407552
2025-09-22 12:22:28.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:a7481cdc-7fb2-47bd-acc3-e78c96a819e9:billing:started | data={"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:28.002630", "start_time": "2025-09-22T09:22:28.002568", "backend_url": "http://localhost:3000"}
2025-09-22 12:22:28.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:a7481cdc-7fb2-47bd-acc3-e78c96a819e9:billing:state_transition | data={"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:28.002499", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:22:28.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:a7481cdc-7fb2-47bd-acc3-e78c96a819e9:billing:state_transition | data={"conversation_id": "a7481cdc-7fb2-47bd-acc3-e78c96a819e9", "correlation_token": "sim_2b8085e88712ed90b695c814afa75a02_1758532912933", "timestamp": "2025-09-22T09:22:28.002536", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:22:28.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9_1758532948 | conversation_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9
2025-09-22 12:22:28.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9_1758532948 | current_minute=0 | waiting_60s=true
2025-09-22 12:22:31.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151_1758532931 | total_iterations=1 | minutes_billed=0
2025-09-22 12:22:31.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=8bbe4032-73ec-4c2f-b00c-4b7e2e4b1151_1758532931 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-22 12:22:31.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9_1758532948 | total_iterations=1 | minutes_billed=0
2025-09-22 12:22:31.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=a7481cdc-7fb2-47bd-acc3-e78c96a819e9_1758532948 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-22 12:29:49.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:29:49.136417"}
2025-09-22 12:29:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:processor_initialized | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:29:49.136417", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:29:49.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | correlation_token=sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570 | will_start_billing=True
2025-09-22 12:29:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:first_audio_received | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:29:49.195026", "direction": "DOWNSTREAM"}
2025-09-22 12:29:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:29:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:29:49.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "start_time": "2025-09-22T09:29:49.195183", "backend_url": "http://localhost:3000"}
2025-09-22 12:29:49.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_3a5545fc-b609-4e66-bb70-c3dd8c9db76a | task_id=4714226752
2025-09-22 12:29:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:started | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:29:49.196101", "start_time": "2025-09-22T09:29:49.195183", "backend_url": "http://localhost:3000"}
2025-09-22 12:29:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:state_transition | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:29:49.195116", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:29:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:state_transition | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:29:49.195154", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:29:49.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a
2025-09-22 12:29:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | current_minute=0 | waiting_60s=true
2025-09-22 12:30:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | iteration=1 | minute=1 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a
2025-09-22 12:30:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758533449199 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:30:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758533449199 | data={"correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "minute": 1, "timestamp": "2025-09-22T09:30:49.199061"}
2025-09-22 12:30:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758533449199 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758533449199"}
2025-09-22 12:30:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758533449199", "status": 200, "latency_ms": 45.263051986694336, "minute": 1, "response_size": 211}
2025-09-22 12:30:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758533449199 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-22 12:30:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:webhook_success | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:30:49.245378", "request_id": "req_1_1758533449199", "minute": 1, "latency_ms": 45.263051986694336, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-22 12:30:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | {"minute": 1, "success": true, "latency_ms": 46.55599594116211, "iteration": 1}
2025-09-22 12:30:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758533449245", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 12:30:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:status_update | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:30:49.245730", "response_id": "resp_1_1758533449245", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 12:30:49.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_1_1758533449245 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-22 12:30:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | iteration=1 | total_duration_s=60.05 | webhook_duration_ms=46.56
2025-09-22 12:30:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | current_minute=1 | waiting_60s=true
2025-09-22 12:31:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | iteration=2 | minute=2 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a
2025-09-22 12:31:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758533509247 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:31:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758533509247 | data={"correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "minute": 2, "timestamp": "2025-09-22T09:31:49.247273"}
2025-09-22 12:31:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758533509247 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758533509247"}
2025-09-22 12:31:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758533509247", "status": 200, "latency_ms": 29.9530029296875, "minute": 2, "response_size": 211}
2025-09-22 12:31:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758533509247 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-22 12:31:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:webhook_success | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:31:49.277831", "request_id": "req_2_1758533509247", "minute": 2, "latency_ms": 29.9530029296875, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-22 12:31:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | {"minute": 2, "success": true, "latency_ms": 30.772924423217773, "iteration": 2}
2025-09-22 12:31:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758533509278", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 12:31:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:status_update | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:31:49.278147", "response_id": "resp_2_1758533509278", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 12:31:49.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_2_1758533509278 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-22 12:31:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | iteration=2 | total_duration_s=60.03 | webhook_duration_ms=30.77
2025-09-22 12:31:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | current_minute=2 | waiting_60s=true
2025-09-22 12:32:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | iteration=3 | minute=3 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a
2025-09-22 12:32:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758533569281 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 12:32:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758533569281 | data={"correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "minute": 3, "timestamp": "2025-09-22T09:32:49.281816"}
2025-09-22 12:32:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758533569281 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758533569281"}
2025-09-22 12:32:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758533569281", "status": 200, "latency_ms": 35.2931022644043, "minute": 3, "response_size": 234}
2025-09-22 12:32:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758533569281 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-22 12:32:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:webhook_success | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:32:49.318172", "request_id": "req_3_1758533569281", "minute": 3, "latency_ms": 35.2931022644043, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-22 12:32:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | {"minute": 3, "success": true, "latency_ms": 36.698102951049805, "iteration": 3}
2025-09-22 12:32:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758533569318", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 12:32:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:status_update | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:32:49.318547", "response_id": "resp_3_1758533569318", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 12:32:49.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_3_1758533569318 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | reason=Last credit used - conversation will end | grace_period=60s
2025-09-22 12:32:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | from=active | to=stopping | reason=termination_requested
2025-09-22 12:32:49.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=60s
2025-09-22 12:32:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:grace_period_started | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:32:49.318789", "duration_seconds": 60, "reason": "Last credit used - conversation will end"}
2025-09-22 12:32:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:state_transition | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:32:49.318694", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 12:33:49.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-22 12:33:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:grace_period_ended | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:33:49.321340"}
2025-09-22 12:33:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:terminated | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:33:49.321497", "reason": "insufficient_credits", "minutes_used": 3, "final_message": "Last credit used - conversation will end"}
2025-09-22 12:33:49.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758533629321 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | reason=insufficient_credits | minutes_billed=3
2025-09-22 12:33:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-22 12:33:49.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758533629321 | task_name=billing_loop_3a5545fc-b609-4e66-bb70-c3dd8c9db76a
2025-09-22 12:33:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:state_transition | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:33:49.321622", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-22 12:33:49.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758533629321 | task_name=billing_loop_3a5545fc-b609-4e66-bb70-c3dd8c9db76a
2025-09-22 12:33:49.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758533629321", "total_seconds": 240.126667, "billed_minutes": 3, "calculated_minutes": 5, "needs_final_billing": true}
2025-09-22 12:33:49.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758533629321 | minute=5
2025-09-22 12:33:49.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758533629321 | final_minute=5 | previous_minutes=3
2025-09-22 12:33:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758533629321 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=4
2025-09-22 12:33:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758533629321 | data={"correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "minute": 5, "timestamp": "2025-09-22T09:33:49.321965"}
2025-09-22 12:33:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758533629321 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758533629321"}
2025-09-22 12:33:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758533629321", "status": 200, "latency_ms": 13.414144515991211, "minute": 5, "response_size": 226}
2025-09-22 12:33:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758533629321 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 3, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 12:33:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:webhook_success | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:33:49.335653", "request_id": "req_5_1758533629321", "minute": 5, "latency_ms": 13.414144515991211, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 3, "attemptId": "e2332cb3-c9dd-4c96-a641-fcac9e3205e4", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 12:33:49.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758533629321 | success=True
2025-09-22 12:33:49.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758533629321 | {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 30.980825424194336, "min_latency_ms": 13.414144515991211, "max_latency_ms": 45.263051986694336, "last_webhook_time": "2025-09-22T09:33:49.335480", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:29:49.195116"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:29:49.195154"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T09:32:49.318694"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T09:33:49.321622"}]}
2025-09-22 12:33:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-22 12:33:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:stopped | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:33:49.336152", "stop_id": "stop_1758533629321", "reason": "insufficient_credits", "total_minutes": 5, "metrics": {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 30.980825424194336, "min_latency_ms": 13.414144515991211, "max_latency_ms": 45.263051986694336, "last_webhook_time": "2025-09-22T09:33:49.335480", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:29:49.195116"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:29:49.195154"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T09:32:49.318694"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T09:33:49.321622"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-22T09:33:49.336107"}]}}
2025-09-22 12:33:49.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-22 12:33:49.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-22 12:33:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | iteration=3 | total_duration_s=120.06 | webhook_duration_ms=36.70
2025-09-22 12:33:49.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a_1758533389 | total_iterations=3 | total_minutes=5 | final_state=stopped
2025-09-22 12:33:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:3a5545fc-b609-4e66-bb70-c3dd8c9db76a:billing:state_transition | data={"conversation_id": "3a5545fc-b609-4e66-bb70-c3dd8c9db76a", "correlation_token": "sim_6e69cd5253ee50f10f8682ece7c5cda5_1758533375570", "timestamp": "2025-09-22T09:33:49.336107", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-22 12:35:09.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758533709183 | conversation_id=3a5545fc-b609-4e66-bb70-c3dd8c9db76a | state=stopped
2025-09-22 12:35:09.f | DEBUG    | _stop_billing             | [STOP] Already inactive | stop_id=stop_1758533709187 | state=stopped
2025-09-22 12:35:09.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758533709183 | final_state=stopped
2025-09-22 12:43:49.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:43:49.022448"}
2025-09-22 12:43:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:processor_initialized | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:43:49.022448", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:43:49.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | correlation_token=sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849 | will_start_billing=True
2025-09-22 12:43:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:first_audio_received | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:43:49.075762", "direction": "DOWNSTREAM"}
2025-09-22 12:43:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:43:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:43:49.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "start_time": "2025-09-22T09:43:49.075919", "backend_url": "http://localhost:3000"}
2025-09-22 12:43:49.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_c51f20e9-365f-46e7-b1f8-abb2778de8b0 | task_id=4994015744
2025-09-22 12:43:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:started | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:43:49.076114", "start_time": "2025-09-22T09:43:49.075919", "backend_url": "http://localhost:3000"}
2025-09-22 12:43:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:state_transition | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:43:49.075852", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:43:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:state_transition | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:43:49.075889", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:43:49.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:43:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | current_minute=0 | waiting_60s=true
2025-09-22 12:44:24.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:44:24.660600"}
2025-09-22 12:44:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:processor_initialized | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:24.660600", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:44:24.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | correlation_token=sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849 | will_start_billing=True
2025-09-22 12:44:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:first_audio_received | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:24.717588", "direction": "DOWNSTREAM"}
2025-09-22 12:44:24.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:44:24.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:44:24.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "start_time": "2025-09-22T09:44:24.717747", "backend_url": "http://localhost:3000"}
2025-09-22 12:44:24.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_bf00b666-6a5c-4687-89db-783abf2e97c6 | task_id=5052472320
2025-09-22 12:44:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:started | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:24.717864", "start_time": "2025-09-22T09:44:24.717747", "backend_url": "http://localhost:3000"}
2025-09-22 12:44:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:state_transition | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:24.717683", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:44:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:state_transition | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:24.717719", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:44:24.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:44:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | current_minute=0 | waiting_60s=true
2025-09-22 12:44:40.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:44:40.645387"}
2025-09-22 12:44:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:processor_initialized | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:40.645387", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:44:40.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | correlation_token=sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849 | will_start_billing=True
2025-09-22 12:44:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:first_audio_received | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:40.707551", "direction": "DOWNSTREAM"}
2025-09-22 12:44:40.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:44:40.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:44:40.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "start_time": "2025-09-22T09:44:40.707710", "backend_url": "http://localhost:3000"}
2025-09-22 12:44:40.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_56651fcd-06f4-40b8-a2fc-bf11486cadee | task_id=5056710784
2025-09-22 12:44:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:started | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:40.707770", "start_time": "2025-09-22T09:44:40.707710", "backend_url": "http://localhost:3000"}
2025-09-22 12:44:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:state_transition | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:40.707644", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:44:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:state_transition | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:40.707681", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:44:40.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:44:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | current_minute=0 | waiting_60s=true
2025-09-22 12:44:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=1 | minute=1 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:44:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758534289078 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:44:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758534289078 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "minute": 1, "timestamp": "2025-09-22T09:44:49.078424"}
2025-09-22 12:44:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758534289078 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758534289078"}
2025-09-22 12:44:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758534289078", "status": 200, "latency_ms": 55.44400215148926, "minute": 1, "response_size": 157}
2025-09-22 12:44:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758534289078 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}
2025-09-22 12:44:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:webhook_success | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:49.134741", "request_id": "req_1_1758534289078", "minute": 1, "latency_ms": 55.44400215148926, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}}
2025-09-22 12:44:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | {"minute": 1, "success": true, "latency_ms": 56.57792091369629, "iteration": 1}
2025-09-22 12:44:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758534289135", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:44:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:status_update | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:44:49.135072", "response_id": "resp_1_1758534289135", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:44:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=1 | total_duration_s=60.06 | webhook_duration_ms=56.58
2025-09-22 12:44:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | current_minute=1 | waiting_60s=true
2025-09-22 12:45:24.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=1 | minute=1 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:45:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758534324720 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:45:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758534324720 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "minute": 1, "timestamp": "2025-09-22T09:45:24.720847"}
2025-09-22 12:45:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758534324720 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758534324720"}
2025-09-22 12:45:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758534324720", "status": 200, "latency_ms": 21.815061569213867, "minute": 1, "response_size": 206}
2025-09-22 12:45:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758534324720 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:45:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:webhook_success | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:45:24.743886", "request_id": "req_1_1758534324720", "minute": 1, "latency_ms": 21.815061569213867, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:45:24.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | {"minute": 1, "success": true, "latency_ms": 23.409366607666016, "iteration": 1}
2025-09-22 12:45:24.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758534324744", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:45:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:status_update | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:45:24.744437", "response_id": "resp_1_1758534324744", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:45:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=23.41
2025-09-22 12:45:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | current_minute=1 | waiting_60s=true
2025-09-22 12:45:40.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=1 | minute=1 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:45:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758534340708 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:45:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758534340708 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "minute": 1, "timestamp": "2025-09-22T09:45:40.708220"}
2025-09-22 12:45:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758534340708 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758534340708"}
2025-09-22 12:45:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758534340708", "status": 200, "latency_ms": 8.454084396362305, "minute": 1, "response_size": 206}
2025-09-22 12:45:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758534340708 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:45:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:webhook_success | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:45:40.716950", "request_id": "req_1_1758534340708", "minute": 1, "latency_ms": 8.454084396362305, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:45:40.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | {"minute": 1, "success": true, "latency_ms": 8.900880813598633, "iteration": 1}
2025-09-22 12:45:40.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758534340717", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:45:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:status_update | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:45:40.717203", "response_id": "resp_1_1758534340717", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:45:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=1 | total_duration_s=60.01 | webhook_duration_ms=8.90
2025-09-22 12:45:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | current_minute=1 | waiting_60s=true
2025-09-22 12:45:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=2 | minute=2 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:45:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758534349136 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:45:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758534349136 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "minute": 2, "timestamp": "2025-09-22T09:45:49.136093"}
2025-09-22 12:45:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758534349136 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758534349136"}
2025-09-22 12:45:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758534349136", "status": 200, "latency_ms": 30.23815155029297, "minute": 2, "response_size": 157}
2025-09-22 12:45:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758534349136 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}
2025-09-22 12:45:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:webhook_success | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:45:49.166782", "request_id": "req_2_1758534349136", "minute": 2, "latency_ms": 30.23815155029297, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}}
2025-09-22 12:45:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | {"minute": 2, "success": true, "latency_ms": 30.952930450439453, "iteration": 2}
2025-09-22 12:45:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758534349167", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:45:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:status_update | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:45:49.167131", "response_id": "resp_2_1758534349167", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:45:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=2 | total_duration_s=60.03 | webhook_duration_ms=30.95
2025-09-22 12:45:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | current_minute=2 | waiting_60s=true
2025-09-22 12:46:24.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=2 | minute=2 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:46:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758534384747 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:46:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758534384747 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "minute": 2, "timestamp": "2025-09-22T09:46:24.747992"}
2025-09-22 12:46:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758534384747 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758534384747"}
2025-09-22 12:46:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758534384747", "status": 200, "latency_ms": 18.960237503051758, "minute": 2, "response_size": 206}
2025-09-22 12:46:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758534384747 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:46:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:webhook_success | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:46:24.768025", "request_id": "req_2_1758534384747", "minute": 2, "latency_ms": 18.960237503051758, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:46:24.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | {"minute": 2, "success": true, "latency_ms": 20.305871963500977, "iteration": 2}
2025-09-22 12:46:24.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758534384768", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:46:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:status_update | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:46:24.768378", "response_id": "resp_2_1758534384768", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:46:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=2 | total_duration_s=60.02 | webhook_duration_ms=20.31
2025-09-22 12:46:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | current_minute=2 | waiting_60s=true
2025-09-22 12:46:40.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=2 | minute=2 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:46:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758534400718 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:46:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758534400718 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "minute": 2, "timestamp": "2025-09-22T09:46:40.718170"}
2025-09-22 12:46:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758534400718 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758534400718"}
2025-09-22 12:46:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758534400718", "status": 200, "latency_ms": 18.941879272460938, "minute": 2, "response_size": 206}
2025-09-22 12:46:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758534400718 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:46:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:webhook_success | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:46:40.738120", "request_id": "req_2_1758534400718", "minute": 2, "latency_ms": 18.941879272460938, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:46:40.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | {"minute": 2, "success": true, "latency_ms": 20.251989364624023, "iteration": 2}
2025-09-22 12:46:40.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758534400738", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:46:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:status_update | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:46:40.738536", "response_id": "resp_2_1758534400738", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:46:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=2 | total_duration_s=60.02 | webhook_duration_ms=20.25
2025-09-22 12:46:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | current_minute=2 | waiting_60s=true
2025-09-22 12:46:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=3 | minute=3 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:46:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758534409168 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 12:46:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758534409168 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "minute": 3, "timestamp": "2025-09-22T09:46:49.168014"}
2025-09-22 12:46:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758534409168 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758534409168"}
2025-09-22 12:46:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758534409168", "status": 200, "latency_ms": 28.783798217773438, "minute": 3, "response_size": 157}
2025-09-22 12:46:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758534409168 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}
2025-09-22 12:46:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:webhook_success | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:46:49.197691", "request_id": "req_3_1758534409168", "minute": 3, "latency_ms": 28.783798217773438, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}}
2025-09-22 12:46:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | {"minute": 3, "success": true, "latency_ms": 29.88123893737793, "iteration": 3}
2025-09-22 12:46:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758534409197", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:46:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:status_update | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:46:49.197984", "response_id": "resp_3_1758534409197", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:46:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=3 | total_duration_s=60.03 | webhook_duration_ms=29.88
2025-09-22 12:46:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | current_minute=3 | waiting_60s=true
2025-09-22 12:47:24.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=3 | minute=3 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:47:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758534444772 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 12:47:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758534444772 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "minute": 3, "timestamp": "2025-09-22T09:47:24.772056"}
2025-09-22 12:47:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758534444772 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758534444772"}
2025-09-22 12:47:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758534444772", "status": 200, "latency_ms": 19.333839416503906, "minute": 3, "response_size": 206}
2025-09-22 12:47:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758534444772 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:47:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:webhook_success | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:47:24.792438", "request_id": "req_3_1758534444772", "minute": 3, "latency_ms": 19.333839416503906, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:47:24.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | {"minute": 3, "success": true, "latency_ms": 20.68305015563965, "iteration": 3}
2025-09-22 12:47:24.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758534444792", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:47:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:status_update | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:47:24.792864", "response_id": "resp_3_1758534444792", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:47:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=3 | total_duration_s=60.02 | webhook_duration_ms=20.68
2025-09-22 12:47:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | current_minute=3 | waiting_60s=true
2025-09-22 12:47:40.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=3 | minute=3 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:47:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758534460740 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 12:47:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758534460740 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "minute": 3, "timestamp": "2025-09-22T09:47:40.740307"}
2025-09-22 12:47:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758534460740 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758534460740"}
2025-09-22 12:47:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758534460740", "status": 200, "latency_ms": 21.66295051574707, "minute": 3, "response_size": 206}
2025-09-22 12:47:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758534460740 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:47:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:webhook_success | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:47:40.762930", "request_id": "req_3_1758534460740", "minute": 3, "latency_ms": 21.66295051574707, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:47:40.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | {"minute": 3, "success": true, "latency_ms": 22.92799949645996, "iteration": 3}
2025-09-22 12:47:40.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758534460763", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:47:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:status_update | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:47:40.763432", "response_id": "resp_3_1758534460763", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:47:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=3 | total_duration_s=60.02 | webhook_duration_ms=22.93
2025-09-22 12:47:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | current_minute=3 | waiting_60s=true
2025-09-22 12:47:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=4 | minute=4 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:47:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758534469200 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 12:47:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758534469200 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "minute": 4, "timestamp": "2025-09-22T09:47:49.200711"}
2025-09-22 12:47:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758534469200 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758534469200"}
2025-09-22 12:47:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758534469200", "status": 200, "latency_ms": 25.07495880126953, "minute": 4, "response_size": 157}
2025-09-22 12:47:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758534469200 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}
2025-09-22 12:47:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:webhook_success | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:47:49.226469", "request_id": "req_4_1758534469200", "minute": 4, "latency_ms": 25.07495880126953, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}}
2025-09-22 12:47:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | {"minute": 4, "success": true, "latency_ms": 26.0317325592041, "iteration": 4}
2025-09-22 12:47:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758534469226", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:47:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:status_update | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:47:49.226836", "response_id": "resp_4_1758534469226", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:47:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=4 | total_duration_s=60.03 | webhook_duration_ms=26.03
2025-09-22 12:47:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | current_minute=4 | waiting_60s=true
2025-09-22 12:48:24.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=4 | minute=4 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:48:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758534504795 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 12:48:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758534504795 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "minute": 4, "timestamp": "2025-09-22T09:48:24.795482"}
2025-09-22 12:48:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758534504795 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758534504795"}
2025-09-22 12:48:24.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758534504795", "status": 200, "latency_ms": 24.518728256225586, "minute": 4, "response_size": 206}
2025-09-22 12:48:24.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758534504795 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:48:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:webhook_success | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:48:24.821079", "request_id": "req_4_1758534504795", "minute": 4, "latency_ms": 24.518728256225586, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:48:24.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | {"minute": 4, "success": true, "latency_ms": 25.952816009521484, "iteration": 4}
2025-09-22 12:48:24.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758534504821", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:48:24.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:status_update | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:48:24.821539", "response_id": "resp_4_1758534504821", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:48:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | iteration=4 | total_duration_s=60.03 | webhook_duration_ms=25.95
2025-09-22 12:48:24.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | current_minute=4 | waiting_60s=true
2025-09-22 12:48:40.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=4 | minute=4 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:48:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758534520765 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 12:48:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758534520765 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "minute": 4, "timestamp": "2025-09-22T09:48:40.765378"}
2025-09-22 12:48:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758534520765 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758534520765"}
2025-09-22 12:48:40.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758534520765", "status": 200, "latency_ms": 26.187896728515625, "minute": 4, "response_size": 206}
2025-09-22 12:48:40.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758534520765 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:48:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:webhook_success | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:48:40.792601", "request_id": "req_4_1758534520765", "minute": 4, "latency_ms": 26.187896728515625, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:48:40.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | {"minute": 4, "success": true, "latency_ms": 27.523040771484375, "iteration": 4}
2025-09-22 12:48:40.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758534520792", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:48:40.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:status_update | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:48:40.793027", "response_id": "resp_4_1758534520792", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:48:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | iteration=4 | total_duration_s=60.03 | webhook_duration_ms=27.52
2025-09-22 12:48:40.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | current_minute=4 | waiting_60s=true
2025-09-22 12:48:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=5 | minute=5 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:48:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758534529228 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 12:48:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758534529228 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "minute": 5, "timestamp": "2025-09-22T09:48:49.228137"}
2025-09-22 12:48:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758534529228 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758534529228"}
2025-09-22 12:48:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758534529228", "status": 200, "latency_ms": 34.20901298522949, "minute": 5, "response_size": 157}
2025-09-22 12:48:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758534529228 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}
2025-09-22 12:48:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:webhook_success | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:48:49.262866", "request_id": "req_5_1758534529228", "minute": 5, "latency_ms": 34.20901298522949, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}}
2025-09-22 12:48:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | {"minute": 5, "success": true, "latency_ms": 34.94405746459961, "iteration": 5}
2025-09-22 12:48:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758534529263", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:48:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:status_update | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:48:49.263180", "response_id": "resp_5_1758534529263", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:48:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | iteration=5 | total_duration_s=60.04 | webhook_duration_ms=34.94
2025-09-22 12:48:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | current_minute=5 | waiting_60s=true
2025-09-22 12:49:18.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758534558886 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | state=active
2025-09-22 12:49:18.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758534558887 | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | reason=cleanup | minutes_billed=5
2025-09-22 12:49:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-22 12:49:18.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758534558887 | task_name=billing_loop_c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:49:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:state_transition | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:18.887375", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 12:49:18.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | total_iterations=6 | minutes_billed=5
2025-09-22 12:49:18.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0_1758534229 | total_iterations=6 | total_minutes=5 | final_state=stopping
2025-09-22 12:49:18.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758534558887 | task_name=billing_loop_c51f20e9-365f-46e7-b1f8-abb2778de8b0
2025-09-22 12:49:18.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758534558887", "total_seconds": 329.813733, "billed_minutes": 5, "calculated_minutes": 6, "needs_final_billing": true}
2025-09-22 12:49:18.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758534558887 | minute=6
2025-09-22 12:49:18.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758534558890 | final_minute=6 | previous_minutes=5
2025-09-22 12:49:18.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758534558890 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-22 12:49:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758534558890 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "minute": 6, "timestamp": "2025-09-22T09:49:18.890129"}
2025-09-22 12:49:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758534558890 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758534558890"}
2025-09-22 12:49:18.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758534558890", "status": 200, "latency_ms": 24.927139282226562, "minute": 6, "response_size": 157}
2025-09-22 12:49:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758534558890 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}
2025-09-22 12:49:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:webhook_success | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:18.915452", "request_id": "req_6_1758534558890", "minute": 6, "latency_ms": 24.927139282226562, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false}}
2025-09-22 12:49:18.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758534558890 | success=True
2025-09-22 12:49:18.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758534558887 | {"webhook_attempts": 6, "webhook_successes": 6, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 33.11284383138021, "min_latency_ms": 24.927139282226562, "max_latency_ms": 55.44400215148926, "last_webhook_time": "2025-09-22T09:49:18.915228", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:43:49.075852"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:43:49.075889"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T09:49:18.887375"}]}
2025-09-22 12:49:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c51f20e9-365f-46e7-b1f8-abb2778de8b0 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 12:49:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:stopped | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:18.915955", "stop_id": "stop_1758534558887", "reason": "cleanup", "total_minutes": 6, "metrics": {"webhook_attempts": 6, "webhook_successes": 6, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 33.11284383138021, "min_latency_ms": 24.927139282226562, "max_latency_ms": 55.44400215148926, "last_webhook_time": "2025-09-22T09:49:18.915228", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:43:49.075852"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:43:49.075889"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T09:49:18.887375"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T09:49:18.915835"}]}}
2025-09-22 12:49:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c51f20e9-365f-46e7-b1f8-abb2778de8b0:billing:state_transition | data={"conversation_id": "c51f20e9-365f-46e7-b1f8-abb2778de8b0", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:18.915835", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 12:49:18.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758534558886 | final_state=stopped
2025-09-22 12:49:19.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758534559825 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | state=active
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758534559826 | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | reason=cleanup | minutes_billed=4
2025-09-22 12:49:19.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-22 12:49:19.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758534559826 | task_name=billing_loop_56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:state_transition | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.826582", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 12:49:19.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | total_iterations=5 | minutes_billed=4
2025-09-22 12:49:19.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=56651fcd-06f4-40b8-a2fc-bf11486cadee_1758534280 | total_iterations=5 | total_minutes=4 | final_state=stopping
2025-09-22 12:49:19.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758534559826 | task_name=billing_loop_56651fcd-06f4-40b8-a2fc-bf11486cadee
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758534559826", "total_seconds": 279.120888, "billed_minutes": 4, "calculated_minutes": 5, "needs_final_billing": true}
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758534559826 | minute=5
2025-09-22 12:49:19.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758534559829 | final_minute=5 | previous_minutes=4
2025-09-22 12:49:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758534559829 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 12:49:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758534559829 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "minute": 5, "timestamp": "2025-09-22T09:49:19.829331"}
2025-09-22 12:49:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758534559829 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758534559829"}
2025-09-22 12:49:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758534559829", "status": 200, "latency_ms": 13.135194778442383, "minute": 5, "response_size": 206}
2025-09-22 12:49:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758534559829 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 5, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:webhook_success | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.843377", "request_id": "req_5_1758534559829", "minute": 5, "latency_ms": 13.135194778442383, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 5, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:49:19.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758534559829 | success=True
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758534559826 | {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 17.676401138305664, "min_latency_ms": 8.454084396362305, "max_latency_ms": 26.187896728515625, "last_webhook_time": "2025-09-22T09:49:19.843145", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:44:40.707644"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:44:40.707681"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T09:49:19.826582"}]}
2025-09-22 12:49:19.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=56651fcd-06f4-40b8-a2fc-bf11486cadee | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:stopped | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.843925", "stop_id": "stop_1758534559826", "reason": "cleanup", "total_minutes": 5, "metrics": {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 17.676401138305664, "min_latency_ms": 8.454084396362305, "max_latency_ms": 26.187896728515625, "last_webhook_time": "2025-09-22T09:49:19.843145", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:44:40.707644"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:44:40.707681"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T09:49:19.826582"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T09:49:19.843796"}]}}
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:56651fcd-06f4-40b8-a2fc-bf11486cadee:billing:state_transition | data={"conversation_id": "56651fcd-06f4-40b8-a2fc-bf11486cadee", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.843796", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 12:49:19.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758534559825 | final_state=stopped
2025-09-22 12:49:19.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758534559946 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | state=active
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758534559947 | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | reason=cleanup | minutes_billed=4
2025-09-22 12:49:19.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-22 12:49:19.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758534559947 | task_name=billing_loop_bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:state_transition | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.947165", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 12:49:19.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | total_iterations=5 | minutes_billed=4
2025-09-22 12:49:19.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=bf00b666-6a5c-4687-89db-783abf2e97c6_1758534264 | total_iterations=5 | total_minutes=4 | final_state=stopping
2025-09-22 12:49:19.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758534559947 | task_name=billing_loop_bf00b666-6a5c-4687-89db-783abf2e97c6
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758534559947", "total_seconds": 295.229896, "billed_minutes": 4, "calculated_minutes": 5, "needs_final_billing": true}
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758534559947 | minute=5
2025-09-22 12:49:19.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758534559947 | final_minute=5 | previous_minutes=4
2025-09-22 12:49:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758534559947 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 12:49:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758534559947 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "minute": 5, "timestamp": "2025-09-22T09:49:19.947831"}
2025-09-22 12:49:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758534559947 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758534559947"}
2025-09-22 12:49:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758534559947", "status": 200, "latency_ms": 10.032892227172852, "minute": 5, "response_size": 206}
2025-09-22 12:49:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758534559947 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 5, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:webhook_success | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.958222", "request_id": "req_5_1758534559947", "minute": 5, "latency_ms": 10.032892227172852, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 5, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:49:19.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758534559947 | success=True
2025-09-22 12:49:19.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758534559947 | {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 18.932151794433594, "min_latency_ms": 10.032892227172852, "max_latency_ms": 24.518728256225586, "last_webhook_time": "2025-09-22T09:49:19.958006", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:44:24.717683"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:44:24.717719"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T09:49:19.947165"}]}
2025-09-22 12:49:19.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=bf00b666-6a5c-4687-89db-783abf2e97c6 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:stopped | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.958637", "stop_id": "stop_1758534559947", "reason": "cleanup", "total_minutes": 5, "metrics": {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 18.932151794433594, "min_latency_ms": 10.032892227172852, "max_latency_ms": 24.518728256225586, "last_webhook_time": "2025-09-22T09:49:19.958006", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:44:24.717683"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:44:24.717719"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T09:49:19.947165"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T09:49:19.958582"}]}}
2025-09-22 12:49:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:bf00b666-6a5c-4687-89db-783abf2e97c6:billing:state_transition | data={"conversation_id": "bf00b666-6a5c-4687-89db-783abf2e97c6", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:49:19.958582", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 12:49:19.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758534559946 | final_state=stopped
2025-09-22 12:56:18.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:56:18.877251"}
2025-09-22 12:56:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:processor_initialized | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:18.877251", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:56:19.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | correlation_token=sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849 | will_start_billing=True
2025-09-22 12:56:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:first_audio_received | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:19.475121", "direction": "DOWNSTREAM"}
2025-09-22 12:56:19.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:56:19.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:56:19.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "start_time": "2025-09-22T09:56:19.475301", "backend_url": "http://localhost:3000"}
2025-09-22 12:56:19.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | task_id=4659520000
2025-09-22 12:56:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:started | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:19.475369", "start_time": "2025-09-22T09:56:19.475301", "backend_url": "http://localhost:3000"}
2025-09-22 12:56:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:state_transition | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:19.475220", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:56:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:state_transition | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:19.475268", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:56:19.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 12:56:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | current_minute=0 | waiting_60s=true
2025-09-22 12:56:19.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=1 | minute=1 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 12:56:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758534979475 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:56:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758534979475 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "minute": 1, "timestamp": "2025-09-22T09:56:19.475702"}
2025-09-22 12:56:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758534979475 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758534979475"}
2025-09-22 12:56:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758534979475", "status": 200, "latency_ms": 11.97195053100586, "minute": 1, "response_size": 206}
2025-09-22 12:56:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758534979475 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 1, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:56:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:webhook_success | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:19.487951", "request_id": "req_1_1758534979475", "minute": 1, "latency_ms": 11.97195053100586, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 1, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:56:19.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | {"minute": 1, "success": true, "latency_ms": 12.421131134033203, "iteration": 1}
2025-09-22 12:56:19.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758534979488", "minute": 1, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:56:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:status_update | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:56:19.488205", "response_id": "resp_1_1758534979488", "minute": 1, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:57:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=1 | total_duration_s=0.01 | webhook_duration_ms=12.42
2025-09-22 12:57:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | current_minute=1 | waiting_60s=true
2025-09-22 12:57:19.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=2 | minute=2 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 12:57:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758535039426 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:57:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758535039426 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "minute": 2, "timestamp": "2025-09-22T09:57:19.426029"}
2025-09-22 12:57:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758535039426 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758535039426"}
2025-09-22 12:57:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758535039426", "status": 200, "latency_ms": 25.510072708129883, "minute": 2, "response_size": 206}
2025-09-22 12:57:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758535039426 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 2, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:57:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:webhook_success | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:57:19.452432", "request_id": "req_2_1758535039426", "minute": 2, "latency_ms": 25.510072708129883, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 2, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:57:19.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | {"minute": 2, "success": true, "latency_ms": 26.764631271362305, "iteration": 2}
2025-09-22 12:57:19.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758535039452", "minute": 2, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:57:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:status_update | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:57:19.452963", "response_id": "resp_2_1758535039452", "minute": 2, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:57:30.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:57:30.843883"}
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:processor_initialized | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.843883", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:57:30.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | correlation_token=sim_e9aedc4d957d191018c284479e1241a2_1758535025260 | will_start_billing=True
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:first_audio_received | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.903057", "direction": "DOWNSTREAM"}
2025-09-22 12:57:30.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:57:30.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:57:30.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "start_time": "2025-09-22T09:57:30.903297", "backend_url": "http://localhost:3000"}
2025-09-22 12:57:30.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_ea789eb7-964a-4b81-b022-98e38c518bfc | task_id=4861696640
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:started | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.903464", "start_time": "2025-09-22T09:57:30.903297", "backend_url": "http://localhost:3000"}
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:state_transition | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.903188", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:state_transition | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.903250", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:57:30.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 12:57:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | current_minute=0 | waiting_60s=true
2025-09-22 12:57:30.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=1 | minute=1 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 12:57:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758535050903 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:57:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758535050903 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "minute": 1, "timestamp": "2025-09-22T09:57:30.903841"}
2025-09-22 12:57:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758535050903 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758535050903"}
2025-09-22 12:57:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758535050903", "status": 200, "latency_ms": 25.367021560668945, "minute": 1, "response_size": 157}
2025-09-22 12:57:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758535050903 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false}
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:webhook_success | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.929459", "request_id": "req_1_1758535050903", "minute": 1, "latency_ms": 25.367021560668945, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false}}
2025-09-22 12:57:30.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | {"minute": 1, "success": true, "latency_ms": 25.791168212890625, "iteration": 1}
2025-09-22 12:57:30.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758535050929", "minute": 1, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:57:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:status_update | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:57:30.929740", "response_id": "resp_1_1758535050929", "minute": 1, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 12:58:05.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T09:58:05.567209"}
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:processor_initialized | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.567209", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 12:58:05.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | correlation_token=sim_e9aedc4d957d191018c284479e1241a2_1758535025260 | will_start_billing=True
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:first_audio_received | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.620131", "direction": "DOWNSTREAM"}
2025-09-22 12:58:05.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 12:58:05.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 12:58:05.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "start_time": "2025-09-22T09:58:05.620300", "backend_url": "http://localhost:3000"}
2025-09-22 12:58:05.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_74bb6e03-1ae0-4290-8360-424df476e6d3 | task_id=4900521344
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:started | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.620363", "start_time": "2025-09-22T09:58:05.620300", "backend_url": "http://localhost:3000"}
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:state_transition | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.620228", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:state_transition | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.620272", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 12:58:05.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 12:58:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | current_minute=0 | waiting_60s=true
2025-09-22 12:58:05.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=1 | minute=1 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 12:58:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758535085620 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 12:58:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758535085620 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "minute": 1, "timestamp": "2025-09-22T09:58:05.620838"}
2025-09-22 12:58:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758535085620 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758535085620"}
2025-09-22 12:58:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758535085620", "status": 200, "latency_ms": 12.859344482421875, "minute": 1, "response_size": 206}
2025-09-22 12:58:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758535085620 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:webhook_success | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.633961", "request_id": "req_1_1758535085620", "minute": 1, "latency_ms": 12.859344482421875, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:58:05.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | {"minute": 1, "success": true, "latency_ms": 14.175891876220703, "iteration": 1}
2025-09-22 12:58:05.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758535085635", "minute": 1, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:58:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:status_update | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:05.635162", "response_id": "resp_1_1758535085635", "minute": 1, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:58:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=2 | total_duration_s=0.03 | webhook_duration_ms=26.76
2025-09-22 12:58:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | current_minute=2 | waiting_60s=true
2025-09-22 12:58:19.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=3 | minute=3 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 12:58:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758535099454 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 12:58:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758535099454 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "minute": 3, "timestamp": "2025-09-22T09:58:19.454736"}
2025-09-22 12:58:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758535099454 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758535099454"}
2025-09-22 12:58:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758535099454", "status": 200, "latency_ms": 19.910097122192383, "minute": 3, "response_size": 206}
2025-09-22 12:58:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758535099454 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 3, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:58:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:webhook_success | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:58:19.475239", "request_id": "req_3_1758535099454", "minute": 3, "latency_ms": 19.910097122192383, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 3, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:58:19.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | {"minute": 3, "success": true, "latency_ms": 20.821094512939453, "iteration": 3}
2025-09-22 12:58:19.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758535099475", "minute": 3, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:58:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:status_update | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:58:19.475727", "response_id": "resp_3_1758535099475", "minute": 3, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:58:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=1 | total_duration_s=0.03 | webhook_duration_ms=25.79
2025-09-22 12:58:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | current_minute=1 | waiting_60s=true
2025-09-22 12:58:30.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=2 | minute=2 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 12:58:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758535110930 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:58:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758535110930 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "minute": 2, "timestamp": "2025-09-22T09:58:30.930894"}
2025-09-22 12:58:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758535110930 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758535110930"}
2025-09-22 12:58:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758535110930", "status": 200, "latency_ms": 19.403934478759766, "minute": 2, "response_size": 211}
2025-09-22 12:58:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758535110930 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-22 12:58:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:webhook_success | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:30.950649", "request_id": "req_2_1758535110930", "minute": 2, "latency_ms": 19.403934478759766, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-22 12:58:30.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | {"minute": 2, "success": true, "latency_ms": 19.948959350585938, "iteration": 2}
2025-09-22 12:58:30.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758535110950", "minute": 2, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 12:58:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:status_update | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:58:30.950975", "response_id": "resp_2_1758535110950", "minute": 2, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 12:58:30.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_2_1758535110950 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-22 12:59:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=1 | total_duration_s=0.01 | webhook_duration_ms=14.18
2025-09-22 12:59:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | current_minute=1 | waiting_60s=true
2025-09-22 12:59:05.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=2 | minute=2 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 12:59:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758535145636 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 12:59:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758535145636 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "minute": 2, "timestamp": "2025-09-22T09:59:05.636509"}
2025-09-22 12:59:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758535145636 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758535145636"}
2025-09-22 12:59:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758535145636", "status": 200, "latency_ms": 19.1650390625, "minute": 2, "response_size": 206}
2025-09-22 12:59:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758535145636 | data={"status": "continue", "creditsRemaining": 2, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:59:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:webhook_success | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:59:05.656806", "request_id": "req_2_1758535145636", "minute": 2, "latency_ms": 19.1650390625, "response": {"status": "continue", "creditsRemaining": 2, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:59:05.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | {"minute": 2, "success": true, "latency_ms": 20.61605453491211, "iteration": 2}
2025-09-22 12:59:05.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758535145657", "minute": 2, "status": "continue", "credits_remaining": 2, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:59:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:status_update | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:59:05.657245", "response_id": "resp_2_1758535145657", "minute": 2, "status": "continue", "credits_remaining": 2, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:59:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=3 | total_duration_s=0.02 | webhook_duration_ms=20.82
2025-09-22 12:59:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | current_minute=3 | waiting_60s=true
2025-09-22 12:59:19.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=4 | minute=4 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 12:59:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758535159477 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 12:59:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758535159477 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "minute": 4, "timestamp": "2025-09-22T09:59:19.477478"}
2025-09-22 12:59:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758535159477 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758535159477"}
2025-09-22 12:59:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758535159477", "status": 200, "latency_ms": 19.941329956054688, "minute": 4, "response_size": 206}
2025-09-22 12:59:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758535159477 | data={"status": "continue", "creditsRemaining": 2, "minuteBilled": 4, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 12:59:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:webhook_success | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:59:19.498489", "request_id": "req_4_1758535159477", "minute": 4, "latency_ms": 19.941329956054688, "response": {"status": "continue", "creditsRemaining": 2, "minuteBilled": 4, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 12:59:19.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | {"minute": 4, "success": true, "latency_ms": 21.337032318115234, "iteration": 4}
2025-09-22 12:59:19.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758535159498", "minute": 4, "status": "continue", "credits_remaining": 2, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:59:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:status_update | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T09:59:19.498951", "response_id": "resp_4_1758535159498", "minute": 4, "status": "continue", "credits_remaining": 2, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 12:59:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=2 | total_duration_s=0.02 | webhook_duration_ms=19.95
2025-09-22 12:59:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | current_minute=2 | waiting_60s=true
2025-09-22 12:59:30.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=3 | minute=3 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 12:59:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758535170952 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 12:59:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758535170952 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "minute": 3, "timestamp": "2025-09-22T09:59:30.952641"}
2025-09-22 12:59:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758535170952 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758535170952"}
2025-09-22 12:59:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758535170952", "status": 200, "latency_ms": 36.70501708984375, "minute": 3, "response_size": 211}
2025-09-22 12:59:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758535170952 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-22 12:59:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:webhook_success | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:59:30.989765", "request_id": "req_3_1758535170952", "minute": 3, "latency_ms": 36.70501708984375, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-22 12:59:30.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | {"minute": 3, "success": true, "latency_ms": 37.405967712402344, "iteration": 3}
2025-09-22 12:59:30.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758535170990", "minute": 3, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 12:59:30.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:status_update | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T09:59:30.990250", "response_id": "resp_3_1758535170990", "minute": 3, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 12:59:30.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_3_1758535170990 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-22 13:00:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=2 | total_duration_s=0.02 | webhook_duration_ms=20.62
2025-09-22 13:00:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | current_minute=2 | waiting_60s=true
2025-09-22 13:00:05.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=3 | minute=3 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 13:00:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758535205660 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 13:00:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758535205660 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "minute": 3, "timestamp": "2025-09-22T10:00:05.661007"}
2025-09-22 13:00:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758535205660 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758535205660"}
2025-09-22 13:00:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758535205660", "status": 200, "latency_ms": 15.730142593383789, "minute": 3, "response_size": 206}
2025-09-22 13:00:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758535205660 | data={"status": "continue", "creditsRemaining": 1, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 13:00:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:webhook_success | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:00:05.677698", "request_id": "req_3_1758535205660", "minute": 3, "latency_ms": 15.730142593383789, "response": {"status": "continue", "creditsRemaining": 1, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 13:00:05.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | {"minute": 3, "success": true, "latency_ms": 17.036914825439453, "iteration": 3}
2025-09-22 13:00:05.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758535205678", "minute": 3, "status": "continue", "credits_remaining": 1, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:00:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:status_update | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:00:05.678149", "response_id": "resp_3_1758535205678", "minute": 3, "status": "continue", "credits_remaining": 1, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:00:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=4 | total_duration_s=0.02 | webhook_duration_ms=21.34
2025-09-22 13:00:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | current_minute=4 | waiting_60s=true
2025-09-22 13:00:19.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=5 | minute=5 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 13:00:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758535219502 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 13:00:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758535219502 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "minute": 5, "timestamp": "2025-09-22T10:00:19.502427"}
2025-09-22 13:00:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758535219502 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758535219502"}
2025-09-22 13:00:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758535219502", "status": 200, "latency_ms": 17.848968505859375, "minute": 5, "response_size": 206}
2025-09-22 13:00:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758535219502 | data={"status": "continue", "creditsRemaining": 1, "minuteBilled": 5, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 13:00:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:webhook_success | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:00:19.521708", "request_id": "req_5_1758535219502", "minute": 5, "latency_ms": 17.848968505859375, "response": {"status": "continue", "creditsRemaining": 1, "minuteBilled": 5, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 13:00:19.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | {"minute": 5, "success": true, "latency_ms": 19.565105438232422, "iteration": 5}
2025-09-22 13:00:19.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758535219522", "minute": 5, "status": "continue", "credits_remaining": 1, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:00:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:status_update | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:00:19.522104", "response_id": "resp_5_1758535219522", "minute": 5, "status": "continue", "credits_remaining": 1, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:00:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=3 | total_duration_s=0.04 | webhook_duration_ms=37.41
2025-09-22 13:00:30.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | current_minute=3 | waiting_60s=true
2025-09-22 13:00:30.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=4 | minute=4 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 13:00:30.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758535230993 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 13:00:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758535230993 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "minute": 4, "timestamp": "2025-09-22T10:00:30.993541"}
2025-09-22 13:00:30.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758535230993 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758535230993"}
2025-09-22 13:00:31.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758535230993", "status": 200, "latency_ms": 33.10275077819824, "minute": 4, "response_size": 234}
2025-09-22 13:00:31.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758535230993 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-22 13:00:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:webhook_success | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:00:31.027705", "request_id": "req_4_1758535230993", "minute": 4, "latency_ms": 33.10275077819824, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-22 13:00:31.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | {"minute": 4, "success": true, "latency_ms": 34.42120552062988, "iteration": 4}
2025-09-22 13:00:31.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758535231028", "minute": 4, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 13:00:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:status_update | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:00:31.028108", "response_id": "resp_4_1758535231028", "minute": 4, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 13:00:31.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_4_1758535231028 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | reason=Last credit used - conversation will end | grace_period=60s
2025-09-22 13:00:31.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | from=active | to=stopping | reason=termination_requested
2025-09-22 13:00:31.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=60s
2025-09-22 13:00:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:grace_period_started | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:00:31.028340", "duration_seconds": 60, "reason": "Last credit used - conversation will end"}
2025-09-22 13:00:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:state_transition | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:00:31.028254", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 13:01:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=3 | total_duration_s=0.02 | webhook_duration_ms=17.04
2025-09-22 13:01:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | current_minute=3 | waiting_60s=true
2025-09-22 13:01:05.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=4 | minute=4 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 13:01:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758535265680 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 13:01:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758535265680 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "minute": 4, "timestamp": "2025-09-22T10:01:05.680182"}
2025-09-22 13:01:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758535265680 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758535265680"}
2025-09-22 13:01:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758535265680", "status": 200, "latency_ms": 18.620014190673828, "minute": 4, "response_size": 206}
2025-09-22 13:01:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758535265680 | data={"status": "continue", "creditsRemaining": 0, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 13:01:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:webhook_success | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:05.699809", "request_id": "req_4_1758535265680", "minute": 4, "latency_ms": 18.620014190673828, "response": {"status": "continue", "creditsRemaining": 0, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 13:01:05.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | {"minute": 4, "success": true, "latency_ms": 19.95992660522461, "iteration": 4}
2025-09-22 13:01:05.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758535265700", "minute": 4, "status": "continue", "credits_remaining": 0, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:01:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:status_update | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:05.700366", "response_id": "resp_4_1758535265700", "minute": 4, "status": "continue", "credits_remaining": 0, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:01:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=5 | total_duration_s=0.02 | webhook_duration_ms=19.57
2025-09-22 13:01:19.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | current_minute=5 | waiting_60s=true
2025-09-22 13:01:19.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | iteration=6 | minute=6 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 13:01:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758535279523 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-22 13:01:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758535279523 | data={"correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "minute": 6, "timestamp": "2025-09-22T10:01:19.523377"}
2025-09-22 13:01:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758535279523 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758535279523"}
2025-09-22 13:01:19.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758535279523", "status": 200, "latency_ms": 19.881010055541992, "minute": 6, "response_size": 206}
2025-09-22 13:01:19.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758535279523 | data={"status": "continue", "creditsRemaining": 0, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}
2025-09-22 13:01:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:webhook_success | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:01:19.544349", "request_id": "req_6_1758535279523", "minute": 6, "latency_ms": 19.881010055541992, "response": {"status": "continue", "creditsRemaining": 0, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "efde8c5f-80c0-41fd-a720-9cb297138a14", "shouldTerminate": false, "message": "Already billed (idempotent response)"}}
2025-09-22 13:01:19.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | {"minute": 6, "success": true, "latency_ms": 21.25382423400879, "iteration": 6}
2025-09-22 13:01:19.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758535279544", "minute": 6, "status": "continue", "credits_remaining": 0, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:01:19.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:status_update | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:01:19.544735", "response_id": "resp_6_1758535279544", "minute": 6, "status": "continue", "credits_remaining": 0, "should_terminate": false, "message": "Already billed (idempotent response)", "grace_period": null}
2025-09-22 13:01:31.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-22 13:01:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:grace_period_ended | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:31.028975"}
2025-09-22 13:01:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:terminated | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:31.029515", "reason": "insufficient_credits", "minutes_used": 4, "final_message": "Last credit used - conversation will end"}
2025-09-22 13:01:31.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758535291029 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | reason=insufficient_credits | minutes_billed=4
2025-09-22 13:01:31.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-22 13:01:31.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758535291029 | task_name=billing_loop_ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 13:01:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:state_transition | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:31.030259", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-22 13:01:31.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758535291029 | task_name=billing_loop_ea789eb7-964a-4b81-b022-98e38c518bfc
2025-09-22 13:01:31.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758535291029", "total_seconds": 240.128917, "billed_minutes": 4, "calculated_minutes": 5, "needs_final_billing": true}
2025-09-22 13:01:31.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758535291029 | minute=5
2025-09-22 13:01:31.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758535291032 | final_minute=5 | previous_minutes=4
2025-09-22 13:01:31.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758535291033 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 13:01:31.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758535291033 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "minute": 5, "timestamp": "2025-09-22T10:01:31.033073"}
2025-09-22 13:01:31.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758535291033 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758535291033"}
2025-09-22 13:01:31.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758535291033", "status": 200, "latency_ms": 17.590999603271484, "minute": 5, "response_size": 226}
2025-09-22 13:01:31.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758535291033 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 13:01:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:webhook_success | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:31.051381", "request_id": "req_5_1758535291033", "minute": 5, "latency_ms": 17.590999603271484, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 13:01:31.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758535291032 | success=True
2025-09-22 13:01:31.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758535291029 | {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 26.433944702148438, "min_latency_ms": 17.590999603271484, "max_latency_ms": 36.70501708984375, "last_webhook_time": "2025-09-22T10:01:31.051052", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:57:30.903188"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:57:30.903250"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T10:00:31.028254"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T10:01:31.030259"}]}
2025-09-22 13:01:31.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-22 13:01:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:stopped | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:31.051999", "stop_id": "stop_1758535291029", "reason": "insufficient_credits", "total_minutes": 5, "metrics": {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 26.433944702148438, "min_latency_ms": 17.590999603271484, "max_latency_ms": 36.70501708984375, "last_webhook_time": "2025-09-22T10:01:31.051052", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:57:30.903188"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:57:30.903250"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T10:00:31.028254"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T10:01:31.030259"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-22T10:01:31.051934"}]}}
2025-09-22 13:01:31.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-22 13:01:31.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-22 13:01:31.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:ea789eb7-964a-4b81-b022-98e38c518bfc:billing:state_transition | data={"conversation_id": "ea789eb7-964a-4b81-b022-98e38c518bfc", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:01:31.051934", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-22 13:02:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=4 | total_duration_s=0.02 | webhook_duration_ms=19.96
2025-09-22 13:02:05.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | current_minute=4 | waiting_60s=true
2025-09-22 13:02:05.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | iteration=5 | minute=5 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 13:02:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758535325703 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 13:02:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758535325703 | data={"correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "minute": 5, "timestamp": "2025-09-22T10:02:05.703206"}
2025-09-22 13:02:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758535325703 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758535325703"}
2025-09-22 13:02:05.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758535325703", "status": 200, "latency_ms": 18.39900016784668, "minute": 5, "response_size": 226}
2025-09-22 13:02:05.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758535325703 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 13:02:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:webhook_success | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:05.722522", "request_id": "req_5_1758535325703", "minute": 5, "latency_ms": 18.39900016784668, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "bbd9e241-b441-40b7-b109-d71a90872c4a", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 13:02:05.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | {"minute": 5, "success": true, "latency_ms": 19.719839096069336, "iteration": 5}
2025-09-22 13:02:05.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758535325722", "minute": 5, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 13:02:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:status_update | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:05.722897", "response_id": "resp_5_1758535325722", "minute": 5, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 13:02:05.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_5_1758535325722 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | reason=Insufficient credits to continue | grace_period=30s
2025-09-22 13:02:05.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | from=active | to=stopping | reason=termination_requested
2025-09-22 13:02:05.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=30s
2025-09-22 13:02:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:grace_period_started | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:05.723139", "duration_seconds": 30, "reason": "Insufficient credits to continue"}
2025-09-22 13:02:05.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:state_transition | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:05.723033", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 13:02:17.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758535337437 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | state=active
2025-09-22 13:02:17.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758535337437 | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | reason=cleanup | minutes_billed=6
2025-09-22 13:02:17.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-22 13:02:17.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758535337437 | task_name=billing_loop_47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 13:02:17.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:state_transition | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:02:17.437537", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 13:02:17.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | total_iterations=6 | minutes_billed=6
2025-09-22 13:02:17.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7_1758534979 | total_iterations=6 | total_minutes=6 | final_state=stopping
2025-09-22 13:02:17.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758535337437 | task_name=billing_loop_47f19ad4-7c03-472c-b7a8-60c2a31ce3d7
2025-09-22 13:02:17.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758535337437", "total_seconds": 357.962605, "billed_minutes": 6, "calculated_minutes": 6, "needs_final_billing": false}
2025-09-22 13:02:17.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758535337437 | {"webhook_attempts": 6, "webhook_successes": 6, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 19.17723814646403, "min_latency_ms": 11.97195053100586, "max_latency_ms": 25.510072708129883, "last_webhook_time": "2025-09-22T10:01:19.544039", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:56:19.475220"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:56:19.475268"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T10:02:17.437537"}]}
2025-09-22 13:02:17.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=47f19ad4-7c03-472c-b7a8-60c2a31ce3d7 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 13:02:17.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:stopped | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:02:17.438085", "stop_id": "stop_1758535337437", "reason": "cleanup", "total_minutes": 6, "metrics": {"webhook_attempts": 6, "webhook_successes": 6, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 19.17723814646403, "min_latency_ms": 11.97195053100586, "max_latency_ms": 25.510072708129883, "last_webhook_time": "2025-09-22T10:01:19.544039", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:56:19.475220"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:56:19.475268"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T10:02:17.437537"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T10:02:17.438042"}]}}
2025-09-22 13:02:17.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:47f19ad4-7c03-472c-b7a8-60c2a31ce3d7:billing:state_transition | data={"conversation_id": "47f19ad4-7c03-472c-b7a8-60c2a31ce3d7", "correlation_token": "sim_7a998722dfc1bc948cd49b1398196e6d_1758534162849", "timestamp": "2025-09-22T10:02:17.438042", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 13:02:17.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758535337437 | final_state=stopped
2025-09-22 13:02:17.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758535337440 | conversation_id=ea789eb7-964a-4b81-b022-98e38c518bfc | state=stopped
2025-09-22 13:02:17.f | DEBUG    | _stop_billing             | [STOP] Already inactive | stop_id=stop_1758535337440 | state=stopped
2025-09-22 13:02:17.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758535337440 | final_state=stopped
2025-09-22 13:02:18.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758535338504 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | state=stopping
2025-09-22 13:02:18.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758535338504 | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | reason=cleanup | minutes_billed=5
2025-09-22 13:02:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | from=stopping | to=stopping | reason=stop_requested: cleanup
2025-09-22 13:02:18.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758535338504 | task_name=billing_loop_74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 13:02:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:state_transition | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:18.505126", "from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 13:02:18.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | total_iterations=5 | minutes_billed=5
2025-09-22 13:02:18.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=74bb6e03-1ae0-4290-8360-424df476e6d3_1758535085 | total_iterations=5 | total_minutes=5 | final_state=stopping
2025-09-22 13:02:18.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758535338504 | task_name=billing_loop_74bb6e03-1ae0-4290-8360-424df476e6d3
2025-09-22 13:02:18.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758535338504", "total_seconds": 252.886535, "billed_minutes": 5, "calculated_minutes": 5, "needs_final_billing": false}
2025-09-22 13:02:18.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758535338504 | {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 16.954708099365234, "min_latency_ms": 12.859344482421875, "max_latency_ms": 19.1650390625, "last_webhook_time": "2025-09-22T10:02:05.722254", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:58:05.620228"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:58:05.620272"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T10:02:05.723033"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T10:02:18.505126"}]}
2025-09-22 13:02:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=74bb6e03-1ae0-4290-8360-424df476e6d3 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 13:02:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:stopped | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:18.507149", "stop_id": "stop_1758535338504", "reason": "cleanup", "total_minutes": 5, "metrics": {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 16.954708099365234, "min_latency_ms": 12.859344482421875, "max_latency_ms": 19.1650390625, "last_webhook_time": "2025-09-22T10:02:05.722254", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T09:58:05.620228"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T09:58:05.620272"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T10:02:05.723033"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T10:02:18.505126"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T10:02:18.507058"}]}}
2025-09-22 13:02:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:74bb6e03-1ae0-4290-8360-424df476e6d3:billing:state_transition | data={"conversation_id": "74bb6e03-1ae0-4290-8360-424df476e6d3", "correlation_token": "sim_e9aedc4d957d191018c284479e1241a2_1758535025260", "timestamp": "2025-09-22T10:02:18.507058", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 13:02:18.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758535338504 | final_state=stopped
2025-09-22 13:02:31.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | iteration=4 | total_duration_s=60.06 | webhook_duration_ms=34.42
2025-09-22 13:02:31.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=ea789eb7-964a-4b81-b022-98e38c518bfc_1758535050 | total_iterations=4 | total_minutes=5 | final_state=stopped
2025-09-22 14:32:43.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:32:43.190365"}
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:processor_initialized | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.190365", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:32:43.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | correlation_token=sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970 | will_start_billing=True
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:first_audio_received | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.253211", "direction": "DOWNSTREAM"}
2025-09-22 14:32:43.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:32:43.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:32:43.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "start_time": "2025-09-22T11:32:43.253391", "backend_url": "http://localhost:3000"}
2025-09-22 14:32:43.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | task_id=4861697408
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:started | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.253463", "start_time": "2025-09-22T11:32:43.253391", "backend_url": "http://localhost:3000"}
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:state_transition | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.253311", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:state_transition | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.253355", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:32:43.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:32:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | current_minute=0 | waiting_60s=true
2025-09-22 14:32:43.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=1 | minute=1 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:32:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758540763253 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:32:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758540763253 | data={"correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "minute": 1, "timestamp": "2025-09-22T11:32:43.253798"}
2025-09-22 14:32:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758540763253 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758540763253"}
2025-09-22 14:32:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758540763253", "status": 200, "latency_ms": 26.571035385131836, "minute": 1, "response_size": 157}
2025-09-22 14:32:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758540763253 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:webhook_success | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.280625", "request_id": "req_1_1758540763253", "minute": 1, "latency_ms": 26.571035385131836, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}}
2025-09-22 14:32:43.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | {"minute": 1, "success": true, "latency_ms": 26.98993682861328, "iteration": 1}
2025-09-22 14:32:43.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758540763280", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:32:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:status_update | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:32:43.280867", "response_id": "resp_1_1758540763280", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:33:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=1 | total_duration_s=0.03 | webhook_duration_ms=26.99
2025-09-22 14:33:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | current_minute=1 | waiting_60s=true
2025-09-22 14:33:43.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=2 | minute=2 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:33:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758540823285 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 14:33:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758540823285 | data={"correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "minute": 2, "timestamp": "2025-09-22T11:33:43.285363"}
2025-09-22 14:33:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758540823285 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758540823285"}
2025-09-22 14:33:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758540823285", "status": 200, "latency_ms": 36.05818748474121, "minute": 2, "response_size": 157}
2025-09-22 14:33:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758540823285 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}
2025-09-22 14:33:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:webhook_success | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:33:43.322204", "request_id": "req_2_1758540823285", "minute": 2, "latency_ms": 36.05818748474121, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}}
2025-09-22 14:33:43.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | {"minute": 2, "success": true, "latency_ms": 37.15395927429199, "iteration": 2}
2025-09-22 14:33:43.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758540823322", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:33:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:status_update | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:33:43.322591", "response_id": "resp_2_1758540823322", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:34:02.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:34:02.962253"}
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:processor_initialized | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:02.962253", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:34:03.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | correlation_token=sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652 | will_start_billing=True
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:first_audio_received | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:03.032211", "direction": "DOWNSTREAM"}
2025-09-22 14:34:03.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:34:03.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:34:03.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "start_time": "2025-09-22T11:34:03.032414", "backend_url": "http://localhost:3000"}
2025-09-22 14:34:03.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_d35fa990-20fb-4f2a-86bd-10b18852c24c | task_id=4900522880
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:started | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:03.032496", "start_time": "2025-09-22T11:34:03.032414", "backend_url": "http://localhost:3000"}
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:state_transition | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:03.032332", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:state_transition | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:03.032383", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:34:03.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:34:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | current_minute=0 | waiting_60s=true
2025-09-22 14:34:03.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=1 | minute=1 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:34:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758540843032 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:34:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758540843032 | data={"correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "minute": 1, "timestamp": "2025-09-22T11:34:03.032823"}
2025-09-22 14:34:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758540843032 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758540843032"}
2025-09-22 14:34:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758540843032", "status": 200, "latency_ms": 18.911123275756836, "minute": 1, "response_size": 157}
2025-09-22 14:34:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758540843032 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": false}
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:webhook_success | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:03.052000", "request_id": "req_1_1758540843032", "minute": 1, "latency_ms": 18.911123275756836, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": false}}
2025-09-22 14:34:03.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | {"minute": 1, "success": true, "latency_ms": 19.3479061126709, "iteration": 1}
2025-09-22 14:34:03.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758540843052", "minute": 1, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:34:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:status_update | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:34:03.052305", "response_id": "resp_1_1758540843052", "minute": 1, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:34:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=2 | total_duration_s=0.04 | webhook_duration_ms=37.15
2025-09-22 14:34:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | current_minute=2 | waiting_60s=true
2025-09-22 14:34:43.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=3 | minute=3 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:34:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758540883325 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 14:34:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758540883325 | data={"correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "minute": 3, "timestamp": "2025-09-22T11:34:43.325293"}
2025-09-22 14:34:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758540883325 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758540883325"}
2025-09-22 14:34:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758540883325", "status": 200, "latency_ms": 17.927885055541992, "minute": 3, "response_size": 157}
2025-09-22 14:34:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758540883325 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}
2025-09-22 14:34:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:webhook_success | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:34:43.343502", "request_id": "req_3_1758540883325", "minute": 3, "latency_ms": 17.927885055541992, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}}
2025-09-22 14:34:43.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | {"minute": 3, "success": true, "latency_ms": 18.362998962402344, "iteration": 3}
2025-09-22 14:34:43.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758540883343", "minute": 3, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:34:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:status_update | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:34:43.343733", "response_id": "resp_3_1758540883343", "minute": 3, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:35:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=1 | total_duration_s=0.02 | webhook_duration_ms=19.35
2025-09-22 14:35:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | current_minute=1 | waiting_60s=true
2025-09-22 14:35:03.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=2 | minute=2 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:35:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758540903055 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 14:35:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758540903055 | data={"correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "minute": 2, "timestamp": "2025-09-22T11:35:03.055511"}
2025-09-22 14:35:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758540903055 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758540903055"}
2025-09-22 14:35:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758540903055", "status": 200, "latency_ms": 33.5240364074707, "minute": 2, "response_size": 157}
2025-09-22 14:35:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758540903055 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": false}
2025-09-22 14:35:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:webhook_success | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:35:03.089801", "request_id": "req_2_1758540903055", "minute": 2, "latency_ms": 33.5240364074707, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": false}}
2025-09-22 14:35:03.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | {"minute": 2, "success": true, "latency_ms": 34.62719917297363, "iteration": 2}
2025-09-22 14:35:03.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758540903090", "minute": 2, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:35:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:status_update | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:35:03.090260", "response_id": "resp_2_1758540903090", "minute": 2, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:35:06.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:35:06.448199"}
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:processor_initialized | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.448199", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:35:06.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | correlation_token=sim_c1252c275bfeffd01d758a66404304b2_1758540906220 | will_start_billing=True
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:first_audio_received | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.511926", "direction": "DOWNSTREAM"}
2025-09-22 14:35:06.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:35:06.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:35:06.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "start_time": "2025-09-22T11:35:06.512085", "backend_url": "http://localhost:3000"}
2025-09-22 14:35:06.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | task_id=4922016960
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:started | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.512140", "start_time": "2025-09-22T11:35:06.512085", "backend_url": "http://localhost:3000"}
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:state_transition | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.512014", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:state_transition | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.512059", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:35:06.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649
2025-09-22 14:35:06.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | current_minute=0 | waiting_60s=true
2025-09-22 14:35:06.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | iteration=1 | minute=1 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649
2025-09-22 14:35:06.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758540906512 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:35:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758540906512 | data={"correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "minute": 1, "timestamp": "2025-09-22T11:35:06.512365"}
2025-09-22 14:35:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758540906512 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758540906512"}
2025-09-22 14:35:06.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758540906512", "status": 200, "latency_ms": 19.707918167114258, "minute": 1, "response_size": 157}
2025-09-22 14:35:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758540906512 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "db718599-4168-4508-9b9d-813ca61966bd", "shouldTerminate": false}
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:webhook_success | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.532330", "request_id": "req_1_1758540906512", "minute": 1, "latency_ms": 19.707918167114258, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "db718599-4168-4508-9b9d-813ca61966bd", "shouldTerminate": false}}
2025-09-22 14:35:06.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | {"minute": 1, "success": true, "latency_ms": 20.119190216064453, "iteration": 1}
2025-09-22 14:35:06.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758540906532", "minute": 1, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:35:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:status_update | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:35:06.532556", "response_id": "resp_1_1758540906532", "minute": 1, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:35:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=3 | total_duration_s=0.02 | webhook_duration_ms=18.36
2025-09-22 14:35:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | current_minute=3 | waiting_60s=true
2025-09-22 14:35:43.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=4 | minute=4 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:35:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758540943346 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 14:35:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758540943346 | data={"correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "minute": 4, "timestamp": "2025-09-22T11:35:43.346158"}
2025-09-22 14:35:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758540943346 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758540943346"}
2025-09-22 14:35:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758540943346", "status": 200, "latency_ms": 45.584917068481445, "minute": 4, "response_size": 157}
2025-09-22 14:35:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758540943346 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}
2025-09-22 14:35:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:webhook_success | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:35:43.392746", "request_id": "req_4_1758540943346", "minute": 4, "latency_ms": 45.584917068481445, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": false}}
2025-09-22 14:35:43.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | {"minute": 4, "success": true, "latency_ms": 46.8440055847168, "iteration": 4}
2025-09-22 14:35:43.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758540943393", "minute": 4, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:35:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:status_update | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:35:43.393293", "response_id": "resp_4_1758540943393", "minute": 4, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:36:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=2 | total_duration_s=0.04 | webhook_duration_ms=34.63
2025-09-22 14:36:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | current_minute=2 | waiting_60s=true
2025-09-22 14:36:03.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=3 | minute=3 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:36:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758540963093 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 14:36:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758540963093 | data={"correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "minute": 3, "timestamp": "2025-09-22T11:36:03.093054"}
2025-09-22 14:36:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758540963093 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758540963093"}
2025-09-22 14:36:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758540963093", "status": 200, "latency_ms": 31.64982795715332, "minute": 3, "response_size": 211}
2025-09-22 14:36:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758540963093 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-22 14:36:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:webhook_success | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:36:03.125264", "request_id": "req_3_1758540963093", "minute": 3, "latency_ms": 31.64982795715332, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-22 14:36:03.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | {"minute": 3, "success": true, "latency_ms": 32.41086006164551, "iteration": 3}
2025-09-22 14:36:03.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758540963125", "minute": 3, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 14:36:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:status_update | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:36:03.125554", "response_id": "resp_3_1758540963125", "minute": 3, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 14:36:03.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_3_1758540963125 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-22 14:36:06.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | iteration=1 | total_duration_s=0.02 | webhook_duration_ms=20.12
2025-09-22 14:36:06.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | current_minute=1 | waiting_60s=true
2025-09-22 14:36:06.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | iteration=2 | minute=2 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649
2025-09-22 14:36:06.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758540966536 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 14:36:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758540966536 | data={"correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "minute": 2, "timestamp": "2025-09-22T11:36:06.536742"}
2025-09-22 14:36:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758540966536 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758540966536"}
2025-09-22 14:36:06.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758540966536", "status": 200, "latency_ms": 32.37605094909668, "minute": 2, "response_size": 211}
2025-09-22 14:36:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758540966536 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "db718599-4168-4508-9b9d-813ca61966bd", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-22 14:36:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:webhook_success | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:36:06.569824", "request_id": "req_2_1758540966536", "minute": 2, "latency_ms": 32.37605094909668, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "db718599-4168-4508-9b9d-813ca61966bd", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-22 14:36:06.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | {"minute": 2, "success": true, "latency_ms": 33.28990936279297, "iteration": 2}
2025-09-22 14:36:06.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758540966570", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 14:36:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:status_update | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:36:06.570119", "response_id": "resp_2_1758540966570", "minute": 2, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 14:36:06.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_2_1758540966570 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-22 14:36:42.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:36:42.533958"}
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:processor_initialized | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.533958", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:36:42.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | correlation_token=sim_8079dc3143f03904453c62f15ff15871_1758541002299 | will_start_billing=True
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:first_audio_received | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.597326", "direction": "DOWNSTREAM"}
2025-09-22 14:36:42.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:36:42.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:36:42.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "start_time": "2025-09-22T11:36:42.597487", "backend_url": "http://localhost:3000"}
2025-09-22 14:36:42.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | task_id=4922030208
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:started | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.597557", "start_time": "2025-09-22T11:36:42.597487", "backend_url": "http://localhost:3000"}
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:state_transition | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.597420", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:state_transition | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.597457", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:36:42.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3_1758541002 | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3
2025-09-22 14:36:42.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3_1758541002 | current_minute=0 | waiting_60s=true
2025-09-22 14:36:42.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3_1758541002 | iteration=1 | minute=1 | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3
2025-09-22 14:36:42.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758541002597 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:36:42.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758541002597 | data={"correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "minute": 1, "timestamp": "2025-09-22T11:36:42.597860"}
2025-09-22 14:36:42.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758541002597 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758541002597"}
2025-09-22 14:36:42.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758541002597", "status": 200, "latency_ms": 21.43383026123047, "minute": 1, "response_size": 234}
2025-09-22 14:36:42.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758541002597 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "9501a976-fcb8-416e-b0fb-bc609227cc27", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:webhook_success | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.619693", "request_id": "req_1_1758541002597", "minute": 1, "latency_ms": 21.43383026123047, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "9501a976-fcb8-416e-b0fb-bc609227cc27", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-22 14:36:42.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3_1758541002 | {"minute": 1, "success": true, "latency_ms": 22.075891494750977, "iteration": 1}
2025-09-22 14:36:42.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758541002620", "minute": 1, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:status_update | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.620067", "response_id": "resp_1_1758541002620", "minute": 1, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 14:36:42.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_1_1758541002620 | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | reason=Last credit used - conversation will end | grace_period=60s
2025-09-22 14:36:42.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | from=active | to=stopping | reason=termination_requested
2025-09-22 14:36:42.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=60s
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:grace_period_started | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.620261", "duration_seconds": 60, "reason": "Last credit used - conversation will end"}
2025-09-22 14:36:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:state_transition | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:36:42.620188", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 14:36:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=4 | total_duration_s=0.05 | webhook_duration_ms=46.84
2025-09-22 14:36:43.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | current_minute=4 | waiting_60s=true
2025-09-22 14:36:43.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=5 | minute=5 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:36:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758541003394 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 14:36:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758541003394 | data={"correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "minute": 5, "timestamp": "2025-09-22T11:36:43.394671"}
2025-09-22 14:36:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758541003394 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758541003394"}
2025-09-22 14:36:43.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758541003394", "status": 200, "latency_ms": 14.513731002807617, "minute": 5, "response_size": 226}
2025-09-22 14:36:43.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758541003394 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 14:36:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:webhook_success | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:36:43.409813", "request_id": "req_5_1758541003394", "minute": 5, "latency_ms": 14.513731002807617, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "88493a8f-f908-47ae-97d8-06fe8ff912b1", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 14:36:43.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | {"minute": 5, "success": true, "latency_ms": 15.385627746582031, "iteration": 5}
2025-09-22 14:36:43.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758541003410", "minute": 5, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:36:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:status_update | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:36:43.410383", "response_id": "resp_5_1758541003410", "minute": 5, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:36:43.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_5_1758541003410 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | reason=Insufficient credits to continue | grace_period=30s
2025-09-22 14:36:43.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | from=active | to=stopping | reason=termination_requested
2025-09-22 14:36:43.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=30s
2025-09-22 14:36:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:grace_period_started | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:36:43.410715", "duration_seconds": 30, "reason": "Insufficient credits to continue"}
2025-09-22 14:36:43.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:state_transition | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:36:43.410589", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 14:37:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=3 | total_duration_s=0.03 | webhook_duration_ms=32.41
2025-09-22 14:37:03.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | current_minute=3 | waiting_60s=true
2025-09-22 14:37:03.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=4 | minute=4 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:37:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758541023128 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 14:37:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758541023128 | data={"correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "minute": 4, "timestamp": "2025-09-22T11:37:03.128832"}
2025-09-22 14:37:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758541023128 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758541023128"}
2025-09-22 14:37:03.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758541023128", "status": 200, "latency_ms": 22.921085357666016, "minute": 4, "response_size": 226}
2025-09-22 14:37:03.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758541023128 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 4, "totalMinutesBilled": 3, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 14:37:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:webhook_success | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:03.152275", "request_id": "req_4_1758541023128", "minute": 4, "latency_ms": 22.921085357666016, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 4, "totalMinutesBilled": 3, "attemptId": "91bb8001-4992-46e0-95ac-5833336188c6", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 14:37:03.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | {"minute": 4, "success": true, "latency_ms": 23.710966110229492, "iteration": 4}
2025-09-22 14:37:03.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758541023152", "minute": 4, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:37:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:status_update | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:03.152647", "response_id": "resp_4_1758541023152", "minute": 4, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:37:03.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_4_1758541023152 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | reason=Insufficient credits to continue | grace_period=30s
2025-09-22 14:37:03.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | from=active | to=stopping | reason=termination_requested
2025-09-22 14:37:03.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=30s
2025-09-22 14:37:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:grace_period_started | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:03.152851", "duration_seconds": 30, "reason": "Insufficient credits to continue"}
2025-09-22 14:37:03.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:state_transition | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:03.152765", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 14:37:06.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | iteration=2 | total_duration_s=0.03 | webhook_duration_ms=33.29
2025-09-22 14:37:06.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | current_minute=2 | waiting_60s=true
2025-09-22 14:37:06.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | iteration=3 | minute=3 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649
2025-09-22 14:37:06.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758541026572 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 14:37:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758541026572 | data={"correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "minute": 3, "timestamp": "2025-09-22T11:37:06.572544"}
2025-09-22 14:37:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758541026572 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758541026572"}
2025-09-22 14:37:06.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758541026572", "status": 200, "latency_ms": 12.921810150146484, "minute": 3, "response_size": 226}
2025-09-22 14:37:06.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758541026572 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 2, "attemptId": "db718599-4168-4508-9b9d-813ca61966bd", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 14:37:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:webhook_success | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:06.585864", "request_id": "req_3_1758541026572", "minute": 3, "latency_ms": 12.921810150146484, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 3, "totalMinutesBilled": 2, "attemptId": "db718599-4168-4508-9b9d-813ca61966bd", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 14:37:06.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | {"minute": 3, "success": true, "latency_ms": 13.53597640991211, "iteration": 3}
2025-09-22 14:37:06.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758541026586", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:37:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:status_update | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:06.586227", "response_id": "resp_3_1758541026586", "minute": 3, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:37:06.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_3_1758541026586 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | reason=Insufficient credits to continue | grace_period=30s
2025-09-22 14:37:06.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | from=active | to=stopping | reason=termination_requested
2025-09-22 14:37:06.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=30s
2025-09-22 14:37:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:grace_period_started | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:06.586733", "duration_seconds": 30, "reason": "Insufficient credits to continue"}
2025-09-22 14:37:06.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:state_transition | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:06.586592", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 14:37:13.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-22 14:37:13.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:grace_period_ended | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:37:13.411642"}
2025-09-22 14:37:13.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:terminated | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:37:13.411753", "reason": "insufficient_credits", "minutes_used": 5, "final_message": "Insufficient credits to continue"}
2025-09-22 14:37:13.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758541033411 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | reason=insufficient_credits | minutes_billed=5
2025-09-22 14:37:13.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-22 14:37:13.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758541033411 | task_name=billing_loop_2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:37:13.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:state_transition | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:37:13.411878", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-22 14:37:13.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758541033411 | task_name=billing_loop_2f4ab2d2-724f-4a5a-824d-ca17c2e37561
2025-09-22 14:37:13.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758541033411", "total_seconds": 270.158728, "billed_minutes": 5, "calculated_minutes": 5, "needs_final_billing": false}
2025-09-22 14:37:13.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758541033411 | {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 28.13115119934082, "min_latency_ms": 14.513731002807617, "max_latency_ms": 45.584917068481445, "last_webhook_time": "2025-09-22T11:36:43.409563", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:32:43.253311"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:32:43.253355"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:36:43.410589"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:13.411878"}]}
2025-09-22 14:37:13.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-22 14:37:13.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:stopped | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:37:13.412343", "stop_id": "stop_1758541033411", "reason": "insufficient_credits", "total_minutes": 5, "metrics": {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 28.13115119934082, "min_latency_ms": 14.513731002807617, "max_latency_ms": 45.584917068481445, "last_webhook_time": "2025-09-22T11:36:43.409563", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:32:43.253311"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:32:43.253355"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:36:43.410589"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:13.411878"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-22T11:37:13.412301"}]}}
2025-09-22 14:37:13.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-22 14:37:13.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-22 14:37:13.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f4ab2d2-724f-4a5a-824d-ca17c2e37561:billing:state_transition | data={"conversation_id": "2f4ab2d2-724f-4a5a-824d-ca17c2e37561", "correlation_token": "sim_80aa5b3f44f5691f53187cc0955b2050_1758540761970", "timestamp": "2025-09-22T11:37:13.412301", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-22 14:37:33.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-22 14:37:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:grace_period_ended | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:33.155750"}
2025-09-22 14:37:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:terminated | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:33.156178", "reason": "insufficient_credits", "minutes_used": 4, "final_message": "Insufficient credits to continue"}
2025-09-22 14:37:33.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758541053156 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | reason=insufficient_credits | minutes_billed=4
2025-09-22 14:37:33.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-22 14:37:33.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758541053156 | task_name=billing_loop_d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:37:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:state_transition | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:33.156529", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-22 14:37:33.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758541053156 | task_name=billing_loop_d35fa990-20fb-4f2a-86bd-10b18852c24c
2025-09-22 14:37:33.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758541053156", "total_seconds": 210.124739, "billed_minutes": 4, "calculated_minutes": 4, "needs_final_billing": false}
2025-09-22 14:37:33.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758541053156 | {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 26.75151824951172, "min_latency_ms": 18.911123275756836, "max_latency_ms": 33.5240364074707, "last_webhook_time": "2025-09-22T11:37:03.151959", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:34:03.032332"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:34:03.032383"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:37:03.152765"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:33.156529"}]}
2025-09-22 14:37:33.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-22 14:37:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:stopped | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:33.157538", "stop_id": "stop_1758541053156", "reason": "insufficient_credits", "total_minutes": 4, "metrics": {"webhook_attempts": 4, "webhook_successes": 4, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 26.75151824951172, "min_latency_ms": 18.911123275756836, "max_latency_ms": 33.5240364074707, "last_webhook_time": "2025-09-22T11:37:03.151959", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:34:03.032332"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:34:03.032383"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:37:03.152765"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:33.156529"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-22T11:37:33.157423"}]}}
2025-09-22 14:37:33.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-22 14:37:33.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-22 14:37:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:d35fa990-20fb-4f2a-86bd-10b18852c24c:billing:state_transition | data={"conversation_id": "d35fa990-20fb-4f2a-86bd-10b18852c24c", "correlation_token": "sim_f5c37d129a237f73db5c05827eb7b6d7_1758540842652", "timestamp": "2025-09-22T11:37:33.157423", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-22 14:37:36.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-22 14:37:36.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:grace_period_ended | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:36.588338"}
2025-09-22 14:37:36.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:terminated | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:36.588821", "reason": "insufficient_credits", "minutes_used": 3, "final_message": "Insufficient credits to continue"}
2025-09-22 14:37:36.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758541056589 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | reason=insufficient_credits | minutes_billed=3
2025-09-22 14:37:36.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-22 14:37:36.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758541056589 | task_name=billing_loop_2fbe5c29-45ba-4913-8d6f-6d83d9cd7649
2025-09-22 14:37:36.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:state_transition | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:36.589244", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-22 14:37:36.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758541056589 | task_name=billing_loop_2fbe5c29-45ba-4913-8d6f-6d83d9cd7649
2025-09-22 14:37:36.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758541056589", "total_seconds": 150.077865, "billed_minutes": 3, "calculated_minutes": 3, "needs_final_billing": false}
2025-09-22 14:37:36.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758541056589 | {"webhook_attempts": 3, "webhook_successes": 3, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 21.66859308878581, "min_latency_ms": 12.921810150146484, "max_latency_ms": 32.37605094909668, "last_webhook_time": "2025-09-22T11:37:06.585616", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:35:06.512014"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:35:06.512059"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:37:06.586592"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:36.589244"}]}
2025-09-22 14:37:36.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-22 14:37:36.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:stopped | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:36.590286", "stop_id": "stop_1758541056589", "reason": "insufficient_credits", "total_minutes": 3, "metrics": {"webhook_attempts": 3, "webhook_successes": 3, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 21.66859308878581, "min_latency_ms": 12.921810150146484, "max_latency_ms": 32.37605094909668, "last_webhook_time": "2025-09-22T11:37:06.585616", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:35:06.512014"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:35:06.512059"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:37:06.586592"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:36.589244"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-22T11:37:36.590210"}]}}
2025-09-22 14:37:36.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-22 14:37:36.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-22 14:37:36.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2fbe5c29-45ba-4913-8d6f-6d83d9cd7649:billing:state_transition | data={"conversation_id": "2fbe5c29-45ba-4913-8d6f-6d83d9cd7649", "correlation_token": "sim_c1252c275bfeffd01d758a66404304b2_1758540906220", "timestamp": "2025-09-22T11:37:36.590210", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-22 14:37:42.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period ended
2025-09-22 14:37:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:grace_period_ended | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:37:42.623036"}
2025-09-22 14:37:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:terminated | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:37:42.623506", "reason": "insufficient_credits", "minutes_used": 1, "final_message": "Last credit used - conversation will end"}
2025-09-22 14:37:42.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758541062623 | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | reason=insufficient_credits | minutes_billed=1
2025-09-22 14:37:42.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-22 14:37:42.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758541062623 | task_name=billing_loop_c0a3de0b-b6c0-4e24-8101-5544c57d70b3
2025-09-22 14:37:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:state_transition | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:37:42.624363", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-22 14:37:42.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758541062623 | task_name=billing_loop_c0a3de0b-b6c0-4e24-8101-5544c57d70b3
2025-09-22 14:37:42.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758541062623", "total_seconds": 60.028044, "billed_minutes": 1, "calculated_minutes": 2, "needs_final_billing": true}
2025-09-22 14:37:42.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758541062623 | minute=2
2025-09-22 14:37:42.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758541062625 | final_minute=2 | previous_minutes=1
2025-09-22 14:37:42.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758541062625 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 14:37:42.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758541062625 | data={"correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "minute": 2, "timestamp": "2025-09-22T11:37:42.625947"}
2025-09-22 14:37:42.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758541062625 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758541062625"}
2025-09-22 14:37:42.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758541062625", "status": 200, "latency_ms": 17.535924911499023, "minute": 2, "response_size": 226}
2025-09-22 14:37:42.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758541062625 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 2, "totalMinutesBilled": 1, "attemptId": "9501a976-fcb8-416e-b0fb-bc609227cc27", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 14:37:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:webhook_success | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:37:42.644289", "request_id": "req_2_1758541062625", "minute": 2, "latency_ms": 17.535924911499023, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 2, "totalMinutesBilled": 1, "attemptId": "9501a976-fcb8-416e-b0fb-bc609227cc27", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 14:37:42.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758541062625 | success=True
2025-09-22 14:37:42.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758541062623 | {"webhook_attempts": 2, "webhook_successes": 2, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 19.484877586364746, "min_latency_ms": 17.535924911499023, "max_latency_ms": 21.43383026123047, "last_webhook_time": "2025-09-22T11:37:42.643949", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:36:42.597420"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:36:42.597457"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:36:42.620188"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:42.624363"}]}
2025-09-22 14:37:42.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-22 14:37:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:stopped | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:37:42.644787", "stop_id": "stop_1758541062623", "reason": "insufficient_credits", "total_minutes": 2, "metrics": {"webhook_attempts": 2, "webhook_successes": 2, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 19.484877586364746, "min_latency_ms": 17.535924911499023, "max_latency_ms": 21.43383026123047, "last_webhook_time": "2025-09-22T11:37:42.643949", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:36:42.597420"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:36:42.597457"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:36:42.620188"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-22T11:37:42.624363"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-22T11:37:42.644723"}]}}
2025-09-22 14:37:42.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-22 14:37:42.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-22 14:37:42.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:c0a3de0b-b6c0-4e24-8101-5544c57d70b3:billing:state_transition | data={"conversation_id": "c0a3de0b-b6c0-4e24-8101-5544c57d70b3", "correlation_token": "sim_8079dc3143f03904453c62f15ff15871_1758541002299", "timestamp": "2025-09-22T11:37:42.644723", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-22 14:38:13.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | iteration=5 | total_duration_s=30.02 | webhook_duration_ms=15.39
2025-09-22 14:38:13.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561_1758540763 | total_iterations=5 | total_minutes=5 | final_state=stopped
2025-09-22 14:38:33.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | iteration=4 | total_duration_s=30.03 | webhook_duration_ms=23.71
2025-09-22 14:38:33.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=d35fa990-20fb-4f2a-86bd-10b18852c24c_1758540843 | total_iterations=4 | total_minutes=4 | final_state=stopped
2025-09-22 14:38:36.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | iteration=3 | total_duration_s=30.02 | webhook_duration_ms=13.54
2025-09-22 14:38:36.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649_1758540906 | total_iterations=3 | total_minutes=3 | final_state=stopped
2025-09-22 14:38:42.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3_1758541002 | iteration=1 | total_duration_s=60.05 | webhook_duration_ms=22.08
2025-09-22 14:38:42.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3_1758541002 | total_iterations=1 | total_minutes=2 | final_state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758541334913 | conversation_id=2f4ab2d2-724f-4a5a-824d-ca17c2e37561 | state=stopped
2025-09-22 14:42:14.f | DEBUG    | _stop_billing             | [STOP] Already inactive | stop_id=stop_1758541334916 | state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758541334913 | final_state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758541334922 | conversation_id=d35fa990-20fb-4f2a-86bd-10b18852c24c | state=stopped
2025-09-22 14:42:14.f | DEBUG    | _stop_billing             | [STOP] Already inactive | stop_id=stop_1758541334922 | state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758541334922 | conversation_id=2fbe5c29-45ba-4913-8d6f-6d83d9cd7649 | state=stopped
2025-09-22 14:42:14.f | DEBUG    | _stop_billing             | [STOP] Already inactive | stop_id=stop_1758541334922 | state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758541334922 | conversation_id=c0a3de0b-b6c0-4e24-8101-5544c57d70b3 | state=stopped
2025-09-22 14:42:14.f | DEBUG    | _stop_billing             | [STOP] Already inactive | stop_id=stop_1758541334922 | state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758541334922 | final_state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758541334922 | final_state=stopped
2025-09-22 14:42:14.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758541334922 | final_state=stopped
2025-09-22 14:45:57.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:45:57.245809"}
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:processor_initialized | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.245809", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:45:57.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | correlation_token=sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017 | will_start_billing=True
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:first_audio_received | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.306838", "direction": "DOWNSTREAM"}
2025-09-22 14:45:57.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:45:57.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:45:57.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "start_time": "2025-09-22T11:45:57.307014", "backend_url": "http://localhost:3000"}
2025-09-22 14:45:57.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_6db91322-c458-4310-a4c3-6e8b808c928a | task_id=4900527680
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:started | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.307074", "start_time": "2025-09-22T11:45:57.307014", "backend_url": "http://localhost:3000"}
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:state_transition | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.306939", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:state_transition | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.306985", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:45:57.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:45:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | current_minute=0 | waiting_60s=true
2025-09-22 14:45:57.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=1 | minute=1 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:45:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758541557307 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:45:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758541557307 | data={"correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "minute": 1, "timestamp": "2025-09-22T11:45:57.307329"}
2025-09-22 14:45:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758541557307 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758541557307"}
2025-09-22 14:45:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758541557307", "status": 200, "latency_ms": 18.72992515563965, "minute": 1, "response_size": 157}
2025-09-22 14:45:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758541557307 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:webhook_success | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.326327", "request_id": "req_1_1758541557307", "minute": 1, "latency_ms": 18.72992515563965, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}}
2025-09-22 14:45:57.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | {"minute": 1, "success": true, "latency_ms": 19.18482780456543, "iteration": 1}
2025-09-22 14:45:57.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758541557326", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:45:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:status_update | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:45:57.326586", "response_id": "resp_1_1758541557326", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:46:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=1 | total_duration_s=0.02 | webhook_duration_ms=19.18
2025-09-22 14:46:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | current_minute=1 | waiting_60s=true
2025-09-22 14:46:57.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=2 | minute=2 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:46:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758541617312 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 14:46:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758541617312 | data={"correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "minute": 2, "timestamp": "2025-09-22T11:46:57.312305"}
2025-09-22 14:46:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758541617312 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758541617312"}
2025-09-22 14:46:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758541617312", "status": 200, "latency_ms": 17.7609920501709, "minute": 2, "response_size": 157}
2025-09-22 14:46:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758541617312 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}
2025-09-22 14:46:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:webhook_success | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:46:57.330318", "request_id": "req_2_1758541617312", "minute": 2, "latency_ms": 17.7609920501709, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}}
2025-09-22 14:46:57.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | {"minute": 2, "success": true, "latency_ms": 18.15485954284668, "iteration": 2}
2025-09-22 14:46:57.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758541617330", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:46:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:status_update | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:46:57.330530", "response_id": "resp_2_1758541617330", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:47:08.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:47:08.667884"}
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:processor_initialized | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.667884", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:47:08.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | correlation_token=sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423 | will_start_billing=True
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:first_audio_received | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.723522", "direction": "DOWNSTREAM"}
2025-09-22 14:47:08.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:47:08.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:47:08.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "start_time": "2025-09-22T11:47:08.723680", "backend_url": "http://localhost:3000"}
2025-09-22 14:47:08.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_e1179ddf-4f45-451b-91bc-4aab871e371b | task_id=4922018304
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:started | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.723792", "start_time": "2025-09-22T11:47:08.723680", "backend_url": "http://localhost:3000"}
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:state_transition | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.723615", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:state_transition | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.723652", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:47:08.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:47:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | current_minute=0 | waiting_60s=true
2025-09-22 14:47:08.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=1 | minute=1 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:47:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758541628724 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:47:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758541628724 | data={"correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "minute": 1, "timestamp": "2025-09-22T11:47:08.724238"}
2025-09-22 14:47:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758541628724 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758541628724"}
2025-09-22 14:47:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758541628724", "status": 200, "latency_ms": 18.300771713256836, "minute": 1, "response_size": 157}
2025-09-22 14:47:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758541628724 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false}
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:webhook_success | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.742824", "request_id": "req_1_1758541628724", "minute": 1, "latency_ms": 18.300771713256836, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false}}
2025-09-22 14:47:08.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | {"minute": 1, "success": true, "latency_ms": 18.727779388427734, "iteration": 1}
2025-09-22 14:47:08.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758541628743", "minute": 1, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:47:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:status_update | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:47:08.743032", "response_id": "resp_1_1758541628743", "minute": 1, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:47:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=2 | total_duration_s=0.02 | webhook_duration_ms=18.15
2025-09-22 14:47:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | current_minute=2 | waiting_60s=true
2025-09-22 14:47:57.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=3 | minute=3 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:47:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758541677334 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 14:47:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758541677334 | data={"correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "minute": 3, "timestamp": "2025-09-22T11:47:57.334045"}
2025-09-22 14:47:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758541677334 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758541677334"}
2025-09-22 14:47:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758541677334", "status": 200, "latency_ms": 34.43312644958496, "minute": 3, "response_size": 157}
2025-09-22 14:47:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758541677334 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}
2025-09-22 14:47:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:webhook_success | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:47:57.369508", "request_id": "req_3_1758541677334", "minute": 3, "latency_ms": 34.43312644958496, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}}
2025-09-22 14:47:57.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | {"minute": 3, "success": true, "latency_ms": 35.797119140625, "iteration": 3}
2025-09-22 14:47:57.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758541677369", "minute": 3, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:47:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:status_update | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:47:57.369912", "response_id": "resp_3_1758541677369", "minute": 3, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:48:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=1 | total_duration_s=0.02 | webhook_duration_ms=18.73
2025-09-22 14:48:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | current_minute=1 | waiting_60s=true
2025-09-22 14:48:08.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=2 | minute=2 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:48:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758541688743 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 14:48:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758541688743 | data={"correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "minute": 2, "timestamp": "2025-09-22T11:48:08.743823"}
2025-09-22 14:48:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758541688743 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758541688743"}
2025-09-22 14:48:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758541688743", "status": 200, "latency_ms": 18.50295066833496, "minute": 2, "response_size": 157}
2025-09-22 14:48:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758541688743 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false}
2025-09-22 14:48:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:webhook_success | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:48:08.762677", "request_id": "req_2_1758541688743", "minute": 2, "latency_ms": 18.50295066833496, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false}}
2025-09-22 14:48:08.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | {"minute": 2, "success": true, "latency_ms": 19.034147262573242, "iteration": 2}
2025-09-22 14:48:08.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758541688762", "minute": 2, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:48:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:status_update | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:48:08.762952", "response_id": "resp_2_1758541688762", "minute": 2, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:48:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=3 | total_duration_s=0.04 | webhook_duration_ms=35.80
2025-09-22 14:48:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | current_minute=3 | waiting_60s=true
2025-09-22 14:48:57.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=4 | minute=4 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:48:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758541737374 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 14:48:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758541737374 | data={"correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "minute": 4, "timestamp": "2025-09-22T11:48:57.375005"}
2025-09-22 14:48:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758541737374 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758541737374"}
2025-09-22 14:48:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758541737374", "status": 200, "latency_ms": 37.53805160522461, "minute": 4, "response_size": 157}
2025-09-22 14:48:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758541737374 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}
2025-09-22 14:48:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:webhook_success | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:48:57.413698", "request_id": "req_4_1758541737374", "minute": 4, "latency_ms": 37.53805160522461, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false}}
2025-09-22 14:48:57.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | {"minute": 4, "success": true, "latency_ms": 39.225101470947266, "iteration": 4}
2025-09-22 14:48:57.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758541737414", "minute": 4, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:48:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:status_update | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:48:57.414253", "response_id": "resp_4_1758541737414", "minute": 4, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:49:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=2 | total_duration_s=0.02 | webhook_duration_ms=19.03
2025-09-22 14:49:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | current_minute=2 | waiting_60s=true
2025-09-22 14:49:08.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=3 | minute=3 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:49:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758541748764 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 14:49:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758541748764 | data={"correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "minute": 3, "timestamp": "2025-09-22T11:49:08.764948"}
2025-09-22 14:49:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758541748764 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758541748764"}
2025-09-22 14:49:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758541748764", "status": 200, "latency_ms": 33.22172164916992, "minute": 3, "response_size": 157}
2025-09-22 14:49:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758541748764 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false}
2025-09-22 14:49:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:webhook_success | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:49:08.798824", "request_id": "req_3_1758541748764", "minute": 3, "latency_ms": 33.22172164916992, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false}}
2025-09-22 14:49:08.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | {"minute": 3, "success": true, "latency_ms": 34.140825271606445, "iteration": 3}
2025-09-22 14:49:08.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758541748799", "minute": 3, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:49:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:status_update | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:49:08.799134", "response_id": "resp_3_1758541748799", "minute": 3, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:49:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=4 | total_duration_s=0.04 | webhook_duration_ms=39.23
2025-09-22 14:49:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | current_minute=4 | waiting_60s=true
2025-09-22 14:49:57.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=5 | minute=5 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:49:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758541797418 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 14:49:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758541797418 | data={"correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "minute": 5, "timestamp": "2025-09-22T11:49:57.418592"}
2025-09-22 14:49:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758541797418 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758541797418"}
2025-09-22 14:49:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758541797418", "status": 200, "latency_ms": 37.71209716796875, "minute": 5, "response_size": 211}
2025-09-22 14:49:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758541797418 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-22 14:49:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:webhook_success | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:49:57.456992", "request_id": "req_5_1758541797418", "minute": 5, "latency_ms": 37.71209716796875, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-22 14:49:57.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | {"minute": 5, "success": true, "latency_ms": 38.68579864501953, "iteration": 5}
2025-09-22 14:49:57.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758541797457", "minute": 5, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 14:49:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:status_update | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:49:57.457384", "response_id": "resp_5_1758541797457", "minute": 5, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 14:49:57.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_5_1758541797457 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-22 14:50:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=3 | total_duration_s=0.03 | webhook_duration_ms=34.14
2025-09-22 14:50:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | current_minute=3 | waiting_60s=true
2025-09-22 14:50:08.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=4 | minute=4 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:50:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758541808801 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 14:50:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758541808801 | data={"correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "minute": 4, "timestamp": "2025-09-22T11:50:08.801824"}
2025-09-22 14:50:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758541808801 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758541808801"}
2025-09-22 14:50:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758541808801", "status": 200, "latency_ms": 20.473957061767578, "minute": 4, "response_size": 211}
2025-09-22 14:50:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758541808801 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-22 14:50:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:webhook_success | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:50:08.822727", "request_id": "req_4_1758541808801", "minute": 4, "latency_ms": 20.473957061767578, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-22 14:50:08.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | {"minute": 4, "success": true, "latency_ms": 21.181106567382812, "iteration": 4}
2025-09-22 14:50:08.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758541808823", "minute": 4, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 14:50:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:status_update | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:50:08.823082", "response_id": "resp_4_1758541808823", "minute": 4, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-22 14:50:08.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_4_1758541808823 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-22 14:50:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=5 | total_duration_s=0.04 | webhook_duration_ms=38.69
2025-09-22 14:50:57.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | current_minute=5 | waiting_60s=true
2025-09-22 14:50:57.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | iteration=6 | minute=6 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:50:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758541857460 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-22 14:50:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758541857460 | data={"correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "minute": 6, "timestamp": "2025-09-22T11:50:57.460688"}
2025-09-22 14:50:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758541857460 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758541857460"}
2025-09-22 14:50:57.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758541857460", "status": 200, "latency_ms": 33.92505645751953, "minute": 6, "response_size": 234}
2025-09-22 14:50:57.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758541857460 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-22 14:50:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:webhook_success | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:50:57.495326", "request_id": "req_6_1758541857460", "minute": 6, "latency_ms": 33.92505645751953, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "cf1a8587-a916-4109-a2a9-85ddcb5dde7b", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-22 14:50:57.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | {"minute": 6, "success": true, "latency_ms": 34.87706184387207, "iteration": 6}
2025-09-22 14:50:57.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758541857495", "minute": 6, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 14:50:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:status_update | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:50:57.495652", "response_id": "resp_6_1758541857495", "minute": 6, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Last credit used - conversation will end", "grace_period": 60}
2025-09-22 14:50:57.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_6_1758541857495 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | reason=Last credit used - conversation will end | grace_period=60s
2025-09-22 14:50:57.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | from=active | to=stopping | reason=termination_requested
2025-09-22 14:50:57.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=60s
2025-09-22 14:50:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:grace_period_started | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:50:57.496053", "duration_seconds": 60, "reason": "Last credit used - conversation will end"}
2025-09-22 14:50:57.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:state_transition | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:50:57.495926", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 14:51:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=4 | total_duration_s=0.02 | webhook_duration_ms=21.18
2025-09-22 14:51:08.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | current_minute=4 | waiting_60s=true
2025-09-22 14:51:08.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | iteration=5 | minute=5 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:51:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758541868825 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 14:51:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758541868825 | data={"correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "minute": 5, "timestamp": "2025-09-22T11:51:08.825236"}
2025-09-22 14:51:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758541868825 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758541868825"}
2025-09-22 14:51:08.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758541868825", "status": 200, "latency_ms": 12.897968292236328, "minute": 5, "response_size": 226}
2025-09-22 14:51:08.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758541868825 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}
2025-09-22 14:51:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:webhook_success | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:08.838528", "request_id": "req_5_1758541868825", "minute": 5, "latency_ms": 12.897968292236328, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 5, "totalMinutesBilled": 4, "attemptId": "08c2c446-fdf4-49c4-91a4-6c0c528e0baf", "shouldTerminate": true, "message": "Insufficient credits to continue", "gracePeriodSeconds": 30}}
2025-09-22 14:51:08.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | {"minute": 5, "success": true, "latency_ms": 13.469934463500977, "iteration": 5}
2025-09-22 14:51:08.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758541868838", "minute": 5, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:51:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:status_update | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:08.838758", "response_id": "resp_5_1758541868838", "minute": 5, "status": "terminate", "credits_remaining": 0, "should_terminate": true, "message": "Insufficient credits to continue", "grace_period": 30}
2025-09-22 14:51:08.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_5_1758541868838 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | reason=Insufficient credits to continue | grace_period=30s
2025-09-22 14:51:08.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | from=active | to=stopping | reason=termination_requested
2025-09-22 14:51:08.f | INFO     | _handle_billing_response  | [TERMINATION] Grace period starting | duration=30s
2025-09-22 14:51:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:grace_period_started | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:08.838919", "duration_seconds": 30, "reason": "Insufficient credits to continue"}
2025-09-22 14:51:08.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:state_transition | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:08.838857", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-22 14:51:21.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758541881736 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | state=stopping
2025-09-22 14:51:21.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758541881737 | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | reason=cleanup | minutes_billed=6
2025-09-22 14:51:21.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | from=stopping | to=stopping | reason=stop_requested: cleanup
2025-09-22 14:51:21.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758541881737 | task_name=billing_loop_6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:51:21.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:state_transition | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:51:21.738015", "from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 14:51:21.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | total_iterations=6 | minutes_billed=6
2025-09-22 14:51:21.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=6db91322-c458-4310-a4c3-6e8b808c928a_1758541557 | total_iterations=6 | total_minutes=6 | final_state=stopping
2025-09-22 14:51:21.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758541881737 | task_name=billing_loop_6db91322-c458-4310-a4c3-6e8b808c928a
2025-09-22 14:51:21.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758541881737", "total_seconds": 324.431846, "billed_minutes": 6, "calculated_minutes": 6, "needs_final_billing": false}
2025-09-22 14:51:21.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758541881737 | {"webhook_attempts": 6, "webhook_successes": 6, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 30.016541481018066, "min_latency_ms": 17.7609920501709, "max_latency_ms": 37.71209716796875, "last_webhook_time": "2025-09-22T11:50:57.495071", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:45:57.306939"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:45:57.306985"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:50:57.495926"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T11:51:21.738015"}]}
2025-09-22 14:51:21.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=6db91322-c458-4310-a4c3-6e8b808c928a | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 14:51:21.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:stopped | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:51:21.739781", "stop_id": "stop_1758541881737", "reason": "cleanup", "total_minutes": 6, "metrics": {"webhook_attempts": 6, "webhook_successes": 6, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 30.016541481018066, "min_latency_ms": 17.7609920501709, "max_latency_ms": 37.71209716796875, "last_webhook_time": "2025-09-22T11:50:57.495071", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:45:57.306939"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:45:57.306985"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:50:57.495926"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T11:51:21.738015"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T11:51:21.739582"}]}}
2025-09-22 14:51:21.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:6db91322-c458-4310-a4c3-6e8b808c928a:billing:state_transition | data={"conversation_id": "6db91322-c458-4310-a4c3-6e8b808c928a", "correlation_token": "sim_eb870e0dbbbbbe10f35a91436804eaaf_1758541557017", "timestamp": "2025-09-22T11:51:21.739582", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 14:51:21.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758541881736 | final_state=stopped
2025-09-22 14:51:22.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758541882744 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | state=stopping
2025-09-22 14:51:22.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758541882744 | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | reason=cleanup | minutes_billed=5
2025-09-22 14:51:22.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | from=stopping | to=stopping | reason=stop_requested: cleanup
2025-09-22 14:51:22.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758541882744 | task_name=billing_loop_e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:51:22.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:state_transition | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:22.744583", "from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-22 14:51:22.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | total_iterations=5 | minutes_billed=5
2025-09-22 14:51:22.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=e1179ddf-4f45-451b-91bc-4aab871e371b_1758541628 | total_iterations=5 | total_minutes=5 | final_state=stopping
2025-09-22 14:51:22.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758541882744 | task_name=billing_loop_e1179ddf-4f45-451b-91bc-4aab871e371b
2025-09-22 14:51:22.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758541882744", "total_seconds": 254.021491, "billed_minutes": 5, "calculated_minutes": 5, "needs_final_billing": false}
2025-09-22 14:51:22.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758541882744 | {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 20.679473876953125, "min_latency_ms": 12.897968292236328, "max_latency_ms": 33.22172164916992, "last_webhook_time": "2025-09-22T11:51:08.838329", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:47:08.723615"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:47:08.723652"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:51:08.838857"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T11:51:22.744583"}]}
2025-09-22 14:51:22.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e1179ddf-4f45-451b-91bc-4aab871e371b | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-22 14:51:22.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:stopped | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:22.745435", "stop_id": "stop_1758541882744", "reason": "cleanup", "total_minutes": 5, "metrics": {"webhook_attempts": 5, "webhook_successes": 5, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 20.679473876953125, "min_latency_ms": 12.897968292236328, "max_latency_ms": 33.22172164916992, "last_webhook_time": "2025-09-22T11:51:08.838329", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-22T11:47:08.723615"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-22T11:47:08.723652"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-22T11:51:08.838857"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-22T11:51:22.744583"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-22T11:51:22.745367"}]}}
2025-09-22 14:51:22.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e1179ddf-4f45-451b-91bc-4aab871e371b:billing:state_transition | data={"conversation_id": "e1179ddf-4f45-451b-91bc-4aab871e371b", "correlation_token": "sim_7ebe473739be17b8ea3cc0b38285f28f_1758541628423", "timestamp": "2025-09-22T11:51:22.745367", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-22 14:51:22.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758541882744 | final_state=stopped
2025-09-22 14:59:49.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T11:59:49.242565"}
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:processor_initialized | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.242565", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 14:59:49.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=567117e1-b4b8-4594-a105-6e49383190a3 | correlation_token=sim_90814388f9072c2c81b655288147913c_1758542388964 | will_start_billing=True
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:first_audio_received | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.306421", "direction": "DOWNSTREAM"}
2025-09-22 14:59:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=567117e1-b4b8-4594-a105-6e49383190a3 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 14:59:49.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=567117e1-b4b8-4594-a105-6e49383190a3 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 14:59:49.f | INFO     | _start_billing            | [START] Starting billing timer and billing first minute immediately | {"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "start_time": "2025-09-22T11:59:49.307672", "backend_url": "http://localhost:3000", "initial_minute_billed": true}
2025-09-22 14:59:49.f | INFO     | _start_billing            | [START] Sending initial billing webhook for minute 1 | conversation_id=567117e1-b4b8-4594-a105-6e49383190a3
2025-09-22 14:59:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758542389307 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 14:59:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758542389307 | data={"correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "minute": 1, "timestamp": "2025-09-22T11:59:49.307765"}
2025-09-22 14:59:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758542389307 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758542389307"}
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:state_transition | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.307028", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:state_transition | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.307579", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 14:59:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758542389307", "status": 200, "latency_ms": 22.821903228759766, "minute": 1, "response_size": 157}
2025-09-22 14:59:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758542389307 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "e019a1b5-e627-405e-89d1-ffdf9406875d", "shouldTerminate": false}
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:webhook_success | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.330887", "request_id": "req_1_1758542389307", "minute": 1, "latency_ms": 22.821903228759766, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "e019a1b5-e627-405e-89d1-ffdf9406875d", "shouldTerminate": false}}
2025-09-22 14:59:49.f | INFO     | _start_billing            | [START] Initial webhook result | {"minute": 1, "success": true, "latency_ms": 23.499011993408203, "initial_billing": true}
2025-09-22 14:59:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758542389331", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:status_update | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.331456", "response_id": "resp_1_1758542389331", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 14:59:49.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_567117e1-b4b8-4594-a105-6e49383190a3 | task_id=4996110592
2025-09-22 14:59:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:started | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T11:59:49.331546", "start_time": "2025-09-22T11:59:49.307672", "backend_url": "http://localhost:3000", "initial_minute_billed": true}
2025-09-22 14:59:49.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | conversation_id=567117e1-b4b8-4594-a105-6e49383190a3 | starting_from_minute=2
2025-09-22 14:59:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | current_minute=1 | waiting_60s=true
2025-09-22 15:00:49.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | iteration=1 | minute=2 | conversation_id=567117e1-b4b8-4594-a105-6e49383190a3
2025-09-22 15:00:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758542449333 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 15:00:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758542449333 | data={"correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "minute": 2, "timestamp": "2025-09-22T12:00:49.333832"}
2025-09-22 15:00:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758542449333 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758542449333"}
2025-09-22 15:00:49.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758542449333", "status": 200, "latency_ms": 27.901411056518555, "minute": 2, "response_size": 157}
2025-09-22 15:00:49.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758542449333 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "e019a1b5-e627-405e-89d1-ffdf9406875d", "shouldTerminate": false}
2025-09-22 15:00:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:webhook_success | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T12:00:49.362075", "request_id": "req_2_1758542449333", "minute": 2, "latency_ms": 27.901411056518555, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "e019a1b5-e627-405e-89d1-ffdf9406875d", "shouldTerminate": false}}
2025-09-22 15:00:49.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | {"minute": 2, "success": true, "latency_ms": 28.40399742126465, "iteration": 1}
2025-09-22 15:00:49.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758542449362", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:00:49.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:567117e1-b4b8-4594-a105-6e49383190a3:billing:status_update | data={"conversation_id": "567117e1-b4b8-4594-a105-6e49383190a3", "correlation_token": "sim_90814388f9072c2c81b655288147913c_1758542388964", "timestamp": "2025-09-22T12:00:49.362293", "response_id": "resp_2_1758542449362", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:00:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=28.40
2025-09-22 15:00:49.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | current_minute=2 | waiting_60s=true
2025-09-22 15:01:14.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | total_iterations=2 | minutes_billed=2
2025-09-22 15:01:14.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=567117e1-b4b8-4594-a105-6e49383190a3_1758542389 | total_iterations=2 | total_minutes=2 | final_state=active
2025-09-22 15:01:41.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T12:01:41.227862"}
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:processor_initialized | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.227862", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 15:01:41.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15 | correlation_token=sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950 | will_start_billing=True
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:first_audio_received | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.294815", "direction": "DOWNSTREAM"}
2025-09-22 15:01:41.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 15:01:41.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 15:01:41.f | INFO     | _start_billing            | [START] Starting billing timer and billing first minute immediately | {"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "start_time": "2025-09-22T12:01:41.294975", "backend_url": "http://localhost:3000", "initial_minute_billed": true}
2025-09-22 15:01:41.f | INFO     | _start_billing            | [START] Sending initial billing webhook for minute 1 | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15
2025-09-22 15:01:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758542501295 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 15:01:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758542501295 | data={"correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "minute": 1, "timestamp": "2025-09-22T12:01:41.295044"}
2025-09-22 15:01:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758542501295 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758542501295"}
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:state_transition | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.294907", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:state_transition | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.294944", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 15:01:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758542501295", "status": 200, "latency_ms": 31.135082244873047, "minute": 1, "response_size": 157}
2025-09-22 15:01:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758542501295 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:webhook_success | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.326483", "request_id": "req_1_1758542501295", "minute": 1, "latency_ms": 31.135082244873047, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}}
2025-09-22 15:01:41.f | INFO     | _start_billing            | [START] Initial webhook result | {"minute": 1, "success": true, "latency_ms": 31.611919403076172, "initial_billing": true}
2025-09-22 15:01:41.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758542501326", "minute": 1, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:status_update | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.326734", "response_id": "resp_1_1758542501326", "minute": 1, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:01:41.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_65c4e57d-1eab-433f-b66a-a72002471c15 | task_id=4640643328
2025-09-22 15:01:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:started | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:01:41.326813", "start_time": "2025-09-22T12:01:41.294975", "backend_url": "http://localhost:3000", "initial_minute_billed": true}
2025-09-22 15:01:41.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15 | starting_from_minute=2
2025-09-22 15:01:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | current_minute=1 | waiting_60s=true
2025-09-22 15:02:41.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=1 | minute=2 | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15
2025-09-22 15:02:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758542561328 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-22 15:02:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758542561328 | data={"correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "minute": 2, "timestamp": "2025-09-22T12:02:41.328346"}
2025-09-22 15:02:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758542561328 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758542561328"}
2025-09-22 15:02:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758542561328", "status": 200, "latency_ms": 36.33713722229004, "minute": 2, "response_size": 157}
2025-09-22 15:02:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758542561328 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}
2025-09-22 15:02:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:webhook_success | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:02:41.365579", "request_id": "req_2_1758542561328", "minute": 2, "latency_ms": 36.33713722229004, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}}
2025-09-22 15:02:41.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | {"minute": 2, "success": true, "latency_ms": 37.46795654296875, "iteration": 1}
2025-09-22 15:02:41.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758542561365", "minute": 2, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:02:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:status_update | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:02:41.365933", "response_id": "resp_2_1758542561365", "minute": 2, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:02:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=1 | total_duration_s=60.04 | webhook_duration_ms=37.47
2025-09-22 15:02:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | current_minute=2 | waiting_60s=true
2025-09-22 15:03:41.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=2 | minute=3 | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15
2025-09-22 15:03:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758542621367 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-22 15:03:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758542621367 | data={"correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "minute": 3, "timestamp": "2025-09-22T12:03:41.367849"}
2025-09-22 15:03:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758542621367 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758542621367"}
2025-09-22 15:03:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758542621367", "status": 200, "latency_ms": 42.40012168884277, "minute": 3, "response_size": 157}
2025-09-22 15:03:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758542621367 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}
2025-09-22 15:03:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:webhook_success | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:03:41.411143", "request_id": "req_3_1758542621367", "minute": 3, "latency_ms": 42.40012168884277, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}}
2025-09-22 15:03:41.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | {"minute": 3, "success": true, "latency_ms": 43.69783401489258, "iteration": 2}
2025-09-22 15:03:41.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758542621411", "minute": 3, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:03:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:status_update | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:03:41.411791", "response_id": "resp_3_1758542621411", "minute": 3, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:03:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=2 | total_duration_s=60.05 | webhook_duration_ms=43.70
2025-09-22 15:03:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | current_minute=3 | waiting_60s=true
2025-09-22 15:04:41.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=3 | minute=4 | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15
2025-09-22 15:04:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758542681413 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-22 15:04:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758542681413 | data={"correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "minute": 4, "timestamp": "2025-09-22T12:04:41.413679"}
2025-09-22 15:04:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758542681413 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758542681413"}
2025-09-22 15:04:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758542681413", "status": 200, "latency_ms": 39.498090744018555, "minute": 4, "response_size": 157}
2025-09-22 15:04:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758542681413 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}
2025-09-22 15:04:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:webhook_success | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:04:41.454172", "request_id": "req_4_1758542681413", "minute": 4, "latency_ms": 39.498090744018555, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}}
2025-09-22 15:04:41.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | {"minute": 4, "success": true, "latency_ms": 40.75312614440918, "iteration": 3}
2025-09-22 15:04:41.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758542681454", "minute": 4, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:04:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:status_update | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:04:41.454509", "response_id": "resp_4_1758542681454", "minute": 4, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:04:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=3 | total_duration_s=60.04 | webhook_duration_ms=40.75
2025-09-22 15:04:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | current_minute=4 | waiting_60s=true
2025-09-22 15:05:41.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=4 | minute=5 | conversation_id=65c4e57d-1eab-433f-b66a-a72002471c15
2025-09-22 15:05:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758542741457 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-22 15:05:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758542741457 | data={"correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "minute": 5, "timestamp": "2025-09-22T12:05:41.457055"}
2025-09-22 15:05:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758542741457 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758542741457"}
2025-09-22 15:05:41.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758542741457", "status": 200, "latency_ms": 32.99903869628906, "minute": 5, "response_size": 157}
2025-09-22 15:05:41.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758542741457 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}
2025-09-22 15:05:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:webhook_success | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:05:41.490853", "request_id": "req_5_1758542741457", "minute": 5, "latency_ms": 32.99903869628906, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "cb7bd7de-7940-42d4-9b93-64909724b7fa", "shouldTerminate": false}}
2025-09-22 15:05:41.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | {"minute": 5, "success": true, "latency_ms": 34.060001373291016, "iteration": 4}
2025-09-22 15:05:41.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758542741491", "minute": 5, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:05:41.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:65c4e57d-1eab-433f-b66a-a72002471c15:billing:status_update | data={"conversation_id": "65c4e57d-1eab-433f-b66a-a72002471c15", "correlation_token": "sim_a151b4f4b98ba14c99ec9a7ba50fff94_1758542500950", "timestamp": "2025-09-22T12:05:41.491329", "response_id": "resp_5_1758542741491", "minute": 5, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-22 15:05:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | iteration=4 | total_duration_s=60.04 | webhook_duration_ms=34.06
2025-09-22 15:05:41.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | current_minute=5 | waiting_60s=true
2025-09-22 15:05:48.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | total_iterations=5 | minutes_billed=5
2025-09-22 15:05:48.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=65c4e57d-1eab-433f-b66a-a72002471c15_1758542501 | total_iterations=5 | total_minutes=5 | final_state=active
2025-09-22 15:06:26.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-22T12:06:26.699040"}
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:processor_initialized | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.699040", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-22 15:06:26.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=4308a778-692a-4a04-ae06-dc1997a462ea | correlation_token=sim_82a049f739ca83d788bb55f34c2e9393_1758542786394 | will_start_billing=True
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:first_audio_received | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.757130", "direction": "DOWNSTREAM"}
2025-09-22 15:06:26.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=4308a778-692a-4a04-ae06-dc1997a462ea | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-22 15:06:26.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=4308a778-692a-4a04-ae06-dc1997a462ea | from=waiting_for_audio | to=active | reason=billing_started
2025-09-22 15:06:26.f | INFO     | _start_billing            | [START] Starting billing timer and billing first minute immediately | {"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "start_time": "2025-09-22T12:06:26.757348", "backend_url": "http://localhost:3000", "initial_minute_billed": true}
2025-09-22 15:06:26.f | INFO     | _start_billing            | [START] Sending initial billing webhook for minute 1 | conversation_id=4308a778-692a-4a04-ae06-dc1997a462ea
2025-09-22 15:06:26.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758542786757 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-22 15:06:26.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758542786757 | data={"correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "minute": 1, "timestamp": "2025-09-22T12:06:26.757440"}
2025-09-22 15:06:26.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758542786757 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758542786757"}
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:state_transition | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.757268", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:state_transition | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.757317", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-22 15:06:26.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758542786757", "status": 200, "latency_ms": 18.682003021240234, "minute": 1, "response_size": 211}
2025-09-22 15:06:26.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758542786757 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "9b23c949-b71d-4e52-af9f-a7d23f4b4cf8", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:webhook_success | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.776369", "request_id": "req_1_1758542786757", "minute": 1, "latency_ms": 18.682003021240234, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "9b23c949-b71d-4e52-af9f-a7d23f4b4cf8", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-22 15:06:26.f | INFO     | _start_billing            | [START] Initial webhook result | {"minute": 1, "success": true, "latency_ms": 19.0889835357666, "initial_billing": true}
2025-09-22 15:06:26.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758542786776", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:status_update | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.776647", "response_id": "resp_1_1758542786776", "minute": 1, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-22 15:06:26.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_1_1758542786776 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-22 15:06:26.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_4308a778-692a-4a04-ae06-dc1997a462ea | task_id=5161787712
2025-09-22 15:06:26.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:4308a778-692a-4a04-ae06-dc1997a462ea:billing:started | data={"conversation_id": "4308a778-692a-4a04-ae06-dc1997a462ea", "correlation_token": "sim_82a049f739ca83d788bb55f34c2e9393_1758542786394", "timestamp": "2025-09-22T12:06:26.776831", "start_time": "2025-09-22T12:06:26.757348", "backend_url": "http://localhost:3000", "initial_minute_billed": true}
2025-09-22 15:06:26.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=4308a778-692a-4a04-ae06-dc1997a462ea_1758542786 | conversation_id=4308a778-692a-4a04-ae06-dc1997a462ea | starting_from_minute=2
2025-09-22 15:06:26.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=4308a778-692a-4a04-ae06-dc1997a462ea_1758542786 | current_minute=1 | waiting_60s=true
2025-09-22 15:07:09.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=4308a778-692a-4a04-ae06-dc1997a462ea_1758542786 | total_iterations=1 | minutes_billed=1
2025-09-22 15:07:09.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=4308a778-692a-4a04-ae06-dc1997a462ea_1758542786 | total_iterations=1 | total_minutes=1 | final_state=active
