2025-09-20 16:00:53.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T13:00:53.670383"}
2025-09-20 16:00:53.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:processor_initialized | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:53.670383", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-20 16:00:54.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | correlation_token=sim_909c4aa76664333dbd33add873591bca_1758373233161 | will_start_billing=True
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:first_audio_received | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697176", "direction": "DOWNSTREAM"}
2025-09-20 16:00:54.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-20 16:00:54.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=waiting_for_audio | to=active | reason=billing_started
2025-09-20 16:00:54.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "start_time": "2025-09-20T13:00:54.697379", "backend_url": "http://localhost:3000"}
2025-09-20 16:00:54.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_2f51cb14-306b-498d-be37-efe1deef93e7 | task_id=13305912320
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:started | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697474", "start_time": "2025-09-20T13:00:54.697379", "backend_url": "http://localhost:3000"}
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697285", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-20 16:00:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:00:54.697335", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-20 16:00:54.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:00:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=0 | waiting_60s=true
2025-09-20 16:01:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=1 | minute=1 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:01:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758373314701 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-20 16:01:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758373314701 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 1, "timestamp": "2025-09-20T13:01:54.701329"}
2025-09-20 16:01:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758373314701 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758373314701"}
2025-09-20 16:01:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758373314701", "status": 200, "latency_ms": 37.358999252319336, "minute": 1, "response_size": 157}
2025-09-20 16:01:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758373314701 | data={"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:01:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:01:54.739236", "request_id": "req_1_1758373314701", "minute": 1, "latency_ms": 37.358999252319336, "response": {"status": "continue", "creditsRemaining": 9, "minuteBilled": 1, "totalMinutesBilled": 1, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:01:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 1, "success": true, "latency_ms": 38.13886642456055, "iteration": 1}
2025-09-20 16:01:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758373314739", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:01:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:01:54.739571", "response_id": "resp_1_1758373314739", "minute": 1, "status": "continue", "credits_remaining": 9, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:01:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=1 | total_duration_s=60.04 | webhook_duration_ms=38.14
2025-09-20 16:01:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 2 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=1 | waiting_60s=true
2025-09-20 16:02:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=2 | minute=2 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:02:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758373374747 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-20 16:02:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758373374747 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 2, "timestamp": "2025-09-20T13:02:54.747275"}
2025-09-20 16:02:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758373374747 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758373374747"}
2025-09-20 16:02:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758373374747", "status": 200, "latency_ms": 34.65700149536133, "minute": 2, "response_size": 157}
2025-09-20 16:02:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758373374747 | data={"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:02:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:02:54.782625", "request_id": "req_2_1758373374747", "minute": 2, "latency_ms": 34.65700149536133, "response": {"status": "continue", "creditsRemaining": 8, "minuteBilled": 2, "totalMinutesBilled": 2, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:02:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 2, "success": true, "latency_ms": 35.57586669921875, "iteration": 2}
2025-09-20 16:02:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_2_1758373374782", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:02:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:02:54.782928", "response_id": "resp_2_1758373374782", "minute": 2, "status": "continue", "credits_remaining": 8, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:02:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=2 | total_duration_s=60.04 | webhook_duration_ms=35.58
2025-09-20 16:02:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 3 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=2 | waiting_60s=true
2025-09-20 16:03:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=3 | minute=3 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:03:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_3_1758373434794 | url=http://localhost:3000/api/billing/voice-minute | minute=3 | attempt=3
2025-09-20 16:03:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_3_1758373434794 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 3, "timestamp": "2025-09-20T13:03:54.794419"}
2025-09-20 16:03:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_3_1758373434794 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_3_1758373434794"}
2025-09-20 16:03:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_3_1758373434794", "status": 200, "latency_ms": 32.31310844421387, "minute": 3, "response_size": 157}
2025-09-20 16:03:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_3_1758373434794 | data={"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:03:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:03:54.827860", "request_id": "req_3_1758373434794", "minute": 3, "latency_ms": 32.31310844421387, "response": {"status": "continue", "creditsRemaining": 7, "minuteBilled": 3, "totalMinutesBilled": 3, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:03:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 3, "success": true, "latency_ms": 33.66899490356445, "iteration": 3}
2025-09-20 16:03:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_3_1758373434828", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:03:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:03:54.828159", "response_id": "resp_3_1758373434828", "minute": 3, "status": "continue", "credits_remaining": 7, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:03:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=3 | total_duration_s=60.05 | webhook_duration_ms=33.67
2025-09-20 16:03:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 4 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=3 | waiting_60s=true
2025-09-20 16:04:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=4 | minute=4 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:04:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_4_1758373494832 | url=http://localhost:3000/api/billing/voice-minute | minute=4 | attempt=4
2025-09-20 16:04:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_4_1758373494832 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 4, "timestamp": "2025-09-20T13:04:54.832422"}
2025-09-20 16:04:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_4_1758373494832 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_4_1758373494832"}
2025-09-20 16:04:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_4_1758373494832", "status": 200, "latency_ms": 42.664289474487305, "minute": 4, "response_size": 157}
2025-09-20 16:04:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_4_1758373494832 | data={"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:04:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:04:54.875607", "request_id": "req_4_1758373494832", "minute": 4, "latency_ms": 42.664289474487305, "response": {"status": "continue", "creditsRemaining": 6, "minuteBilled": 4, "totalMinutesBilled": 4, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:04:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 4, "success": true, "latency_ms": 43.463945388793945, "iteration": 4}
2025-09-20 16:04:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_4_1758373494875", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:04:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:04:54.875968", "response_id": "resp_4_1758373494875", "minute": 4, "status": "continue", "credits_remaining": 6, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:04:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=4 | total_duration_s=60.05 | webhook_duration_ms=43.46
2025-09-20 16:04:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 5 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=4 | waiting_60s=true
2025-09-20 16:05:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=5 | minute=5 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:05:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_5_1758373554878 | url=http://localhost:3000/api/billing/voice-minute | minute=5 | attempt=5
2025-09-20 16:05:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_5_1758373554878 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 5, "timestamp": "2025-09-20T13:05:54.878360"}
2025-09-20 16:05:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_5_1758373554878 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_5_1758373554878"}
2025-09-20 16:05:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_5_1758373554878", "status": 200, "latency_ms": 32.68313407897949, "minute": 5, "response_size": 157}
2025-09-20 16:05:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_5_1758373554878 | data={"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:05:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:05:54.912249", "request_id": "req_5_1758373554878", "minute": 5, "latency_ms": 32.68313407897949, "response": {"status": "continue", "creditsRemaining": 5, "minuteBilled": 5, "totalMinutesBilled": 5, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:05:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 5, "success": true, "latency_ms": 34.15107727050781, "iteration": 5}
2025-09-20 16:05:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_5_1758373554912", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:05:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:05:54.912694", "response_id": "resp_5_1758373554912", "minute": 5, "status": "continue", "credits_remaining": 5, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:05:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=5 | total_duration_s=60.04 | webhook_duration_ms=34.15
2025-09-20 16:05:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 6 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=5 | waiting_60s=true
2025-09-20 16:06:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=6 | minute=6 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:06:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_6_1758373614914 | url=http://localhost:3000/api/billing/voice-minute | minute=6 | attempt=6
2025-09-20 16:06:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_6_1758373614914 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 6, "timestamp": "2025-09-20T13:06:54.914407"}
2025-09-20 16:06:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_6_1758373614914 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_6_1758373614914"}
2025-09-20 16:06:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_6_1758373614914", "status": 200, "latency_ms": 22.996902465820312, "minute": 6, "response_size": 157}
2025-09-20 16:06:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_6_1758373614914 | data={"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:06:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:06:54.937770", "request_id": "req_6_1758373614914", "minute": 6, "latency_ms": 22.996902465820312, "response": {"status": "continue", "creditsRemaining": 4, "minuteBilled": 6, "totalMinutesBilled": 6, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:06:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 6, "success": true, "latency_ms": 23.555994033813477, "iteration": 6}
2025-09-20 16:06:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_6_1758373614938", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:06:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:06:54.938057", "response_id": "resp_6_1758373614938", "minute": 6, "status": "continue", "credits_remaining": 4, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:06:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=6 | total_duration_s=60.03 | webhook_duration_ms=23.56
2025-09-20 16:06:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 7 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=6 | waiting_60s=true
2025-09-20 16:07:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=7 | minute=7 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:07:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_7_1758373674942 | url=http://localhost:3000/api/billing/voice-minute | minute=7 | attempt=7
2025-09-20 16:07:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_7_1758373674942 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 7, "timestamp": "2025-09-20T13:07:54.942594"}
2025-09-20 16:07:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_7_1758373674942 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_7_1758373674942"}
2025-09-20 16:07:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_7_1758373674942", "status": 200, "latency_ms": 36.17286682128906, "minute": 7, "response_size": 157}
2025-09-20 16:07:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_7_1758373674942 | data={"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}
2025-09-20 16:07:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:07:54.979357", "request_id": "req_7_1758373674942", "minute": 7, "latency_ms": 36.17286682128906, "response": {"status": "continue", "creditsRemaining": 3, "minuteBilled": 7, "totalMinutesBilled": 7, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false}}
2025-09-20 16:07:54.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 7, "success": true, "latency_ms": 37.00685501098633, "iteration": 7}
2025-09-20 16:07:54.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_7_1758373674979", "minute": 7, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:07:54.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:07:54.979743", "response_id": "resp_7_1758373674979", "minute": 7, "status": "continue", "credits_remaining": 3, "should_terminate": false, "message": null, "grace_period": null}
2025-09-20 16:07:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=7 | total_duration_s=60.04 | webhook_duration_ms=37.01
2025-09-20 16:07:54.f | DEBUG    | _billing_loop             | [LOOP] Iteration 8 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=7 | waiting_60s=true
2025-09-20 16:08:54.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=8 | minute=8 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:08:54.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_8_1758373734984 | url=http://localhost:3000/api/billing/voice-minute | minute=8 | attempt=8
2025-09-20 16:08:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_8_1758373734984 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 8, "timestamp": "2025-09-20T13:08:54.984259"}
2025-09-20 16:08:54.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_8_1758373734984 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_8_1758373734984"}
2025-09-20 16:08:55.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_8_1758373734984", "status": 200, "latency_ms": 59.144020080566406, "minute": 8, "response_size": 211}
2025-09-20 16:08:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_8_1758373734984 | data={"status": "warning", "creditsRemaining": 2, "minuteBilled": 8, "totalMinutesBilled": 8, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}
2025-09-20 16:08:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:08:55.044387", "request_id": "req_8_1758373734984", "minute": 8, "latency_ms": 59.144020080566406, "response": {"status": "warning", "creditsRemaining": 2, "minuteBilled": 8, "totalMinutesBilled": 8, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 2 minute(s) remaining"}}
2025-09-20 16:08:55.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 8, "success": true, "latency_ms": 60.36996841430664, "iteration": 8}
2025-09-20 16:08:55.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_8_1758373735044", "minute": 8, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-20 16:08:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:08:55.044708", "response_id": "resp_8_1758373735044", "minute": 8, "status": "warning", "credits_remaining": 2, "should_terminate": false, "message": "Low credits warning: 2 minute(s) remaining", "grace_period": null}
2025-09-20 16:08:55.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_8_1758373735044 | credits_remaining=2 | message=Low credits warning: 2 minute(s) remaining
2025-09-20 16:08:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=8 | total_duration_s=60.06 | webhook_duration_ms=60.37
2025-09-20 16:08:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration 9 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=8 | waiting_60s=true
2025-09-20 16:09:55.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=9 | minute=9 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:09:55.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_9_1758373795048 | url=http://localhost:3000/api/billing/voice-minute | minute=9 | attempt=9
2025-09-20 16:09:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_9_1758373795048 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 9, "timestamp": "2025-09-20T13:09:55.048660"}
2025-09-20 16:09:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_9_1758373795048 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_9_1758373795048"}
2025-09-20 16:09:55.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_9_1758373795048", "status": 200, "latency_ms": 34.73377227783203, "minute": 9, "response_size": 211}
2025-09-20 16:09:55.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_9_1758373795048 | data={"status": "warning", "creditsRemaining": 1, "minuteBilled": 9, "totalMinutesBilled": 9, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}
2025-09-20 16:09:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:09:55.084446", "request_id": "req_9_1758373795048", "minute": 9, "latency_ms": 34.73377227783203, "response": {"status": "warning", "creditsRemaining": 1, "minuteBilled": 9, "totalMinutesBilled": 9, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": false, "message": "Low credits warning: 1 minute(s) remaining"}}
2025-09-20 16:09:55.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | {"minute": 9, "success": true, "latency_ms": 36.1788272857666, "iteration": 9}
2025-09-20 16:09:55.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_9_1758373795084", "minute": 9, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-20 16:09:55.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:status_update | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:09:55.085019", "response_id": "resp_9_1758373795084", "minute": 9, "status": "warning", "credits_remaining": 1, "should_terminate": false, "message": "Low credits warning: 1 minute(s) remaining", "grace_period": null}
2025-09-20 16:09:55.f | WARNING  | _handle_billing_response  | [RESPONSE] Low credits warning | response_id=resp_9_1758373795084 | credits_remaining=1 | message=Low credits warning: 1 minute(s) remaining
2025-09-20 16:09:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | iteration=9 | total_duration_s=60.04 | webhook_duration_ms=36.18
2025-09-20 16:09:55.f | DEBUG    | _billing_loop             | [LOOP] Iteration 10 starting | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | current_minute=9 | waiting_60s=true
2025-09-20 16:10:18.f | INFO     | cleanup                   | [CLEANUP] Starting | cleanup_id=cleanup_1758373818476 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | state=active
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758373818477 | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | reason=cleanup | minutes_billed=9
2025-09-20 16:10:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=active | to=stopping | reason=stop_requested: cleanup
2025-09-20 16:10:18.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758373818477 | task_name=billing_loop_2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.478044", "from": "active", "to": "stopping", "reason": "stop_requested: cleanup"}
2025-09-20 16:10:18.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | total_iterations=10 | minutes_billed=9
2025-09-20 16:10:18.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=2f51cb14-306b-498d-be37-efe1deef93e7_1758373254 | total_iterations=10 | total_minutes=9 | final_state=stopping
2025-09-20 16:10:18.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758373818477 | task_name=billing_loop_2f51cb14-306b-498d-be37-efe1deef93e7
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758373818477", "total_seconds": 563.780965, "billed_minutes": 9, "calculated_minutes": 10, "needs_final_billing": true}
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758373818477 | minute=10
2025-09-20 16:10:18.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758373818478 | final_minute=10 | previous_minutes=9
2025-09-20 16:10:18.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_10_1758373818478 | url=http://localhost:3000/api/billing/voice-minute | minute=10 | attempt=10
2025-09-20 16:10:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_10_1758373818478 | data={"correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "minute": 10, "timestamp": "2025-09-20T13:10:18.478443"}
2025-09-20 16:10:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_10_1758373818478 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_10_1758373818478"}
2025-09-20 16:10:18.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_10_1758373818478", "status": 200, "latency_ms": 24.90711212158203, "minute": 10, "response_size": 236}
2025-09-20 16:10:18.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_10_1758373818478 | data={"status": "terminate", "creditsRemaining": 0, "minuteBilled": 10, "totalMinutesBilled": 10, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:webhook_success | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.503598", "request_id": "req_10_1758373818478", "minute": 10, "latency_ms": 24.90711212158203, "response": {"status": "terminate", "creditsRemaining": 0, "minuteBilled": 10, "totalMinutesBilled": 10, "attemptId": "1598f8e1-be6c-475c-a76d-9412a5ce9994", "shouldTerminate": true, "message": "Last credit used - conversation will end", "gracePeriodSeconds": 60}}
2025-09-20 16:10:18.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758373818478 | success=True
2025-09-20 16:10:18.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758373818477 | {"webhook_attempts": 10, "webhook_successes": 10, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 35.76312065124512, "min_latency_ms": 22.996902465820312, "max_latency_ms": 59.144020080566406, "last_webhook_time": "2025-09-20T13:10:18.503429", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T13:00:54.697285"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T13:00:54.697335"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-20T13:10:18.478044"}]}
2025-09-20 16:10:18.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=2f51cb14-306b-498d-be37-efe1deef93e7 | from=stopping | to=stopped | reason=stop_completed: cleanup
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:stopped | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.504073", "stop_id": "stop_1758373818477", "reason": "cleanup", "total_minutes": 10, "metrics": {"webhook_attempts": 10, "webhook_successes": 10, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 35.76312065124512, "min_latency_ms": 22.996902465820312, "max_latency_ms": 59.144020080566406, "last_webhook_time": "2025-09-20T13:10:18.503429", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T13:00:54.697285"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T13:00:54.697335"}, {"from": "active", "to": "stopping", "reason": "stop_requested: cleanup", "timestamp": "2025-09-20T13:10:18.478044"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup", "timestamp": "2025-09-20T13:10:18.504022"}]}}
2025-09-20 16:10:18.f | INFO     | cleanup                   | [CLEANUP] Complete | cleanup_id=cleanup_1758373818476 | final_state=stopped
2025-09-20 16:10:18.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:2f51cb14-306b-498d-be37-efe1deef93e7:billing:state_transition | data={"conversation_id": "2f51cb14-306b-498d-be37-efe1deef93e7", "correlation_token": "sim_909c4aa76664333dbd33add873591bca_1758373233161", "timestamp": "2025-09-20T13:10:18.504022", "from": "stopping", "to": "stopped", "reason": "stop_completed: cleanup"}
2025-09-21 00:03:37.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T21:03:37.636425"}
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:processor_initialized | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.636425", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 00:03:37.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | correlation_token=transcript-1758402217369-rq608s2g1 | will_start_billing=True
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:first_audio_received | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.692928", "direction": "DOWNSTREAM"}
2025-09-21 00:03:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 00:03:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 00:03:37.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "start_time": "2025-09-20T21:03:37.693150", "backend_url": "http://localhost:3000"}
2025-09-21 00:03:37.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_5bbec813-4889-4aea-9cdc-e58e92774dfe | task_id=5803532416
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:started | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.693227", "start_time": "2025-09-20T21:03:37.693150", "backend_url": "http://localhost:3000"}
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.693068", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 00:03:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:03:37.693119", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 00:03:37.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:03:37.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | current_minute=0 | waiting_60s=true
2025-09-21 00:04:33.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T21:04:33.666835"}
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:processor_initialized | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.666835", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 00:04:33.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a | correlation_token=transcript-1758402273412-73gyu8nit | will_start_billing=True
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:first_audio_received | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.727860", "direction": "DOWNSTREAM"}
2025-09-21 00:04:33.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 00:04:33.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 00:04:33.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "start_time": "2025-09-20T21:04:33.728207", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:33.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_14c7af04-2ab9-497f-bb19-45f373c6310a | task_id=5864104256
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:started | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.728291", "start_time": "2025-09-20T21:04:33.728207", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:state_transition | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.728111", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 00:04:33.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:14c7af04-2ab9-497f-bb19-45f373c6310a:billing:state_transition | data={"conversation_id": "14c7af04-2ab9-497f-bb19-45f373c6310a", "correlation_token": "transcript-1758402273412-73gyu8nit", "timestamp": "2025-09-20T21:04:33.728164", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 00:04:33.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | conversation_id=14c7af04-2ab9-497f-bb19-45f373c6310a
2025-09-21 00:04:33.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | current_minute=0 | waiting_60s=true
2025-09-21 00:04:37.f | INFO     | _billing_loop             | [LOOP] Minute elapsed | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | iteration=1 | minute=1 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_1_1758402277694 | url=http://localhost:3000/api/billing/voice-minute | minute=1 | attempt=1
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_1_1758402277694 | data={"correlation_token": "transcript-1758402217369-rq608s2g1", "conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "minute": 1, "timestamp": "2025-09-20T21:04:37.694803"}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_1_1758402277694 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_1_1758402277694"}
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_1_1758402277694", "status": 200, "latency_ms": 25.20608901977539, "minute": 1, "response_size": 160}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_1_1758402277694 | data={"status": "error", "creditsRemaining": 0, "minuteBilled": 1, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:webhook_success | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720278", "request_id": "req_1_1758402277694", "minute": 1, "latency_ms": 25.20608901977539, "response": {"status": "error", "creditsRemaining": 0, "minuteBilled": 1, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}}
2025-09-21 00:04:37.f | INFO     | _billing_loop             | [LOOP] Webhook result | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | {"minute": 1, "success": true, "latency_ms": 25.6960391998291, "iteration": 1}
2025-09-21 00:04:37.f | INFO     | _handle_billing_response  | [RESPONSE] Processing | {"response_id": "resp_1_1758402277720", "minute": 1, "status": "error", "credits_remaining": 0, "should_terminate": true, "message": "Invalid correlation token - session not found", "grace_period": null}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:status_update | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720683", "response_id": "resp_1_1758402277720", "minute": 1, "status": "error", "credits_remaining": 0, "should_terminate": true, "message": "Invalid correlation token - session not found", "grace_period": null}
2025-09-21 00:04:37.f | WARNING  | _handle_billing_response  | [TERMINATION] Requested | response_id=resp_1_1758402277720 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | reason=Invalid correlation token - session not found | grace_period=Nones
2025-09-21 00:04:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=active | to=stopping | reason=termination_requested
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:terminated | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720844", "reason": "insufficient_credits", "minutes_used": 1, "final_message": "Invalid correlation token - session not found"}
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Initiating | stop_id=stop_1758402277720 | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | reason=insufficient_credits | minutes_billed=1
2025-09-21 00:04:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=stopping | to=stopping | reason=stop_requested: insufficient_credits
2025-09-21 00:04:37.f | DEBUG    | _stop_billing             | [STOP] Cancelling task | stop_id=stop_1758402277720 | task_name=billing_loop_5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720806", "from": "active", "to": "stopping", "reason": "termination_requested"}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.720923", "from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits"}
2025-09-21 00:04:37.f | DEBUG    | _stop_billing             | [STOP] Task cancelled | stop_id=stop_1758402277720 | task_name=billing_loop_5bbec813-4889-4aea-9cdc-e58e92774dfe
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Session duration | {"stop_id": "stop_1758402277720", "total_seconds": 60.027983, "billed_minutes": 1, "calculated_minutes": 2, "needs_final_billing": true}
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Billing partial minute | stop_id=stop_1758402277720 | minute=2
2025-09-21 00:04:37.f | INFO     | _send_final_webhook       | [FINAL] Sending final webhook | final_id=final_1758402277721 | final_minute=2 | previous_minutes=1
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Request starting | request_id=req_2_1758402277721 | url=http://localhost:3000/api/billing/voice-minute | minute=2 | attempt=2
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Request data | request_id=req_2_1758402277721 | data={"correlation_token": "transcript-1758402217369-rq608s2g1", "conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "minute": 2, "timestamp": "2025-09-20T21:04:37.721219"}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Sending POST | request_id=req_2_1758402277721 | headers={"Content-Type": "application/json", "X-Internal-Secret": "REDACTED", "X-Request-ID": "req_2_1758402277721"}
2025-09-21 00:04:37.f | INFO     | _send_billing_webhook     | [WEBHOOK] Response received | {"request_id": "req_2_1758402277721", "status": 200, "latency_ms": 6.0520172119140625, "minute": 2, "response_size": 160}
2025-09-21 00:04:37.f | DEBUG    | _send_billing_webhook     | [WEBHOOK] Success response | request_id=req_2_1758402277721 | data={"status": "error", "creditsRemaining": 0, "minuteBilled": 2, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:webhook_success | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.727551", "request_id": "req_2_1758402277721", "minute": 2, "latency_ms": 6.0520172119140625, "response": {"status": "error", "creditsRemaining": 0, "minuteBilled": 2, "totalMinutesBilled": 0, "shouldTerminate": true, "message": "Invalid correlation token - session not found"}}
2025-09-21 00:04:37.f | INFO     | _send_final_webhook       | [FINAL] Final webhook complete | final_id=final_1758402277721 | success=True
2025-09-21 00:04:37.f | INFO     | _stop_billing             | [STOP] Final metrics | stop_id=stop_1758402277720 | {"webhook_attempts": 2, "webhook_successes": 2, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 15.629053115844727, "min_latency_ms": 6.0520172119140625, "max_latency_ms": 25.20608901977539, "last_webhook_time": "2025-09-20T21:04:37.727350", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T21:03:37.693068"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T21:03:37.693119"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-20T21:04:37.720806"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-20T21:04:37.720923"}]}
2025-09-21 00:04:37.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=5bbec813-4889-4aea-9cdc-e58e92774dfe | from=stopping | to=stopped | reason=stop_completed: insufficient_credits
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:stopped | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.728025", "stop_id": "stop_1758402277720", "reason": "insufficient_credits", "total_minutes": 2, "metrics": {"webhook_attempts": 2, "webhook_successes": 2, "webhook_failures": 0, "success_rate": 100.0, "avg_latency_ms": 15.629053115844727, "min_latency_ms": 6.0520172119140625, "max_latency_ms": 25.20608901977539, "last_webhook_time": "2025-09-20T21:04:37.727350", "state_transitions": [{"from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received", "timestamp": "2025-09-20T21:03:37.693068"}, {"from": "waiting_for_audio", "to": "active", "reason": "billing_started", "timestamp": "2025-09-20T21:03:37.693119"}, {"from": "active", "to": "stopping", "reason": "termination_requested", "timestamp": "2025-09-20T21:04:37.720806"}, {"from": "stopping", "to": "stopping", "reason": "stop_requested: insufficient_credits", "timestamp": "2025-09-20T21:04:37.720923"}, {"from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits", "timestamp": "2025-09-20T21:04:37.727936"}]}}
2025-09-21 00:04:37.f | WARNING  | _close_websocket          | [WEBSOCKET] No transport available to close | has_transport=True | has_websocket=False
2025-09-21 00:04:37.f | INFO     | _handle_billing_response  | [TERMINATION] Sending EndFrame
2025-09-21 00:04:37.f | DEBUG    | _billing_loop             | [LOOP] Iteration complete | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | iteration=1 | total_duration_s=60.03 | webhook_duration_ms=25.70
2025-09-21 00:04:37.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=5bbec813-4889-4aea-9cdc-e58e92774dfe_1758402217 | total_iterations=1 | total_minutes=2 | final_state=stopped
2025-09-21 00:04:37.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:5bbec813-4889-4aea-9cdc-e58e92774dfe:billing:state_transition | data={"conversation_id": "5bbec813-4889-4aea-9cdc-e58e92774dfe", "correlation_token": "transcript-1758402217369-rq608s2g1", "timestamp": "2025-09-20T21:04:37.727936", "from": "stopping", "to": "stopped", "reason": "stop_completed: insufficient_credits"}
2025-09-21 00:04:48.f | INFO     | __init__                  | [INIT] BillingProcessor initialized | {"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle", "timestamp": "2025-09-20T21:04:48.163645"}
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:processor_initialized | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.163645", "backend_url": "http://localhost:3000", "has_backend_shared_secret": true, "has_transport": true, "initial_state": "idle"}
2025-09-21 00:04:48.f | INFO     | process_frame             | [AUDIO] First audio frame received | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e | correlation_token=transcript-1758402287937-ohsc01l1c | will_start_billing=True
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:first_audio_received | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228765", "direction": "DOWNSTREAM"}
2025-09-21 00:04:48.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e | from=idle | to=waiting_for_audio | reason=first_audio_received
2025-09-21 00:04:48.f | INFO     | _transition_state         | [STATE] Transition | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e | from=waiting_for_audio | to=active | reason=billing_started
2025-09-21 00:04:48.f | INFO     | _start_billing            | [START] Starting billing timer | {"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "start_time": "2025-09-20T21:04:48.228925", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:48.f | DEBUG    | _start_billing            | [START] Created billing task | task_name=billing_loop_e015f41e-3393-4621-9cd4-6552acd6389e | task_id=5868405760
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:started | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228984", "start_time": "2025-09-20T21:04:48.228925", "backend_url": "http://localhost:3000"}
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:state_transition | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228860", "from": "idle", "to": "waiting_for_audio", "reason": "first_audio_received"}
2025-09-21 00:04:48.f | DEBUG    | _emit_billing_event       | [EVENT] Emitted conversation:e015f41e-3393-4621-9cd4-6552acd6389e:billing:state_transition | data={"conversation_id": "e015f41e-3393-4621-9cd4-6552acd6389e", "correlation_token": "transcript-1758402287937-ohsc01l1c", "timestamp": "2025-09-20T21:04:48.228897", "from": "waiting_for_audio", "to": "active", "reason": "billing_started"}
2025-09-21 00:04:48.f | INFO     | _billing_loop             | [LOOP] Started | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | conversation_id=e015f41e-3393-4621-9cd4-6552acd6389e
2025-09-21 00:04:48.f | DEBUG    | _billing_loop             | [LOOP] Iteration 1 starting | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | current_minute=0 | waiting_60s=true
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | total_iterations=1 | minutes_billed=0
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=14c7af04-2ab9-497f-bb19-45f373c6310a_1758402273 | total_iterations=1 | total_minutes=0 | final_state=active
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Cancelled | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | total_iterations=1 | minutes_billed=0
2025-09-21 00:05:10.f | INFO     | _billing_loop             | [LOOP] Ended | loop_id=e015f41e-3393-4621-9cd4-6552acd6389e_1758402288 | total_iterations=1 | total_minutes=0 | final_state=active
